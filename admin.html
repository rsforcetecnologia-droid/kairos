<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Super Admin - Kairos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            display: none; 
        }
        .modal { display: none; transition: opacity 0.3s ease; }
        .modal.flex { display: flex; }

        #sidebar {
            width: 4.5rem; 
            transition: width 0.3s ease-in-out;
        }
        #sidebar.expanded {
            width: 16rem;
        }
        #sidebar:not(.expanded) .sidebar-text,
        #sidebar:not(.expanded) .sidebar-header-text {
            opacity: 0;
            pointer-events: none;
            width: 0;
            overflow: hidden;
        }
        #sidebar:not(.expanded) .sidebar-link {
            justify-content: center;
        }
        #sidebar:not(.expanded) .sidebar-link span {
            display: none;
        }
        #sidebarToggle {
            transition: transform 0.3s ease-in-out;
        }
        #sidebar.expanded #sidebarToggle {
            transform: rotate(180deg);
        }
        .dot { transition: transform .2s ease-in-out; }
        input[type="checkbox"]:checked ~ .dot { transform: translateX(100%); }
        input[type="checkbox"]:checked ~ .toggle-bg { background-color: #22c55e; }
        .toggle-bg:after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            background: white;
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 9999px;
            transition: transform 0.2s ease-in-out;
        }
        input:checked + .toggle-bg:after {
            transform: translateX(100%);
        }
        input:checked + .toggle-bg {
            background-color: #22c55e;
        }
        @keyframes fade-in-out {
            0% { opacity: 0; transform: translateY(20px); } 10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-20px); }
        }
        .animate-fade-in-out {
            animation: fade-in-out 3s ease-in-out forwards;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="flex h-screen">
        <aside id="sidebar" class="bg-gray-900 text-gray-300 flex flex-col">
            <div class="p-4 flex items-center justify-between border-b border-gray-800 h-16">
                <div class="sidebar-header-text overflow-hidden transition-all duration-300 ease-in-out">
                    <h1 class="text-xl font-bold text-white">KAIROS</h1>
                </div>
                <button id="sidebarToggle" class="p-2 rounded-full hover:bg-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7" /></svg>
                </button>
            </div>
            <nav class="flex-1 p-4 space-y-2">
                 <a href="#establishments" class="sidebar-link w-full flex items-center gap-3 py-2 px-4 rounded-lg text-white font-semibold active">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /></svg>
                    <span class="sidebar-text">Estabelecimentos</span>
                </a>
                <a href="#trash" class="sidebar-link w-full flex items-center gap-3 py-2 px-4 rounded-lg text-gray-300 hover:bg-gray-700 font-semibold">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m-7-10V4a1 1 0 00-1-1h-2a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                    <span class="sidebar-text">Lixeira</span>
                </a>
                <a href="#plans" class="sidebar-link w-full flex items-center gap-3 py-2 px-4 rounded-lg text-gray-300 hover:bg-gray-700 font-semibold">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.25-10.75a.75.75 0 000 1.5h7.5a.75.75 0 000-1.5h-7.5zM6 8.5h8a1 1 0 100-2H6a1 1 0 000 2z" clip-rule="evenodd" /></svg>
                    <span class="sidebar-text">Gerir Planos</span>
                </a>
                <a href="import.html" class="sidebar-link w-full flex items-center gap-3 py-2 px-4 rounded-lg text-gray-300 hover:bg-gray-700 font-semibold">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                    </svg>
                    <span class="sidebar-text">Importação</span>
                </a>
            </nav>
        </aside>

        <div class="flex-1 flex flex-col">
            <header class="bg-white shadow-sm p-4 flex justify-between items-center h-16">
                <h2 id="pageTitle" class="text-xl font-semibold text-gray-800">Estabelecimentos</h2>
                <div class="flex items-center gap-4">
                    <span id="userDisplayEmail" class="text-sm text-gray-600"></span>
                    <button id="logoutButton" class="text-sm font-semibold text-red-600 hover:text-red-800">Sair</button>
                </div>
            </header>

            <main class="flex-1 p-6 sm:p-8 overflow-y-auto">
                <section id="establishments-section">
                     <div class="flex flex-wrap justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold text-gray-700">Gerir Estabelecimentos</h2>
                        <div class="flex items-center gap-4 mt-4 md:mt-0">
                            <input type="text" id="searchInput" placeholder="Pesquisar por nome ou ID..." class="p-2 border rounded-md">
                            <button data-action="open-create-modal" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300">
                                + Novo
                            </button>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow-md overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome/ID</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Plano</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Expiração</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status Assinatura</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ativo (App)</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="establishmentsList" class="bg-white divide-y divide-gray-200">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <section id="trash-section" class="hidden">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-4">Lixeira</h2>
                    <div class="bg-white rounded-lg shadow-md overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome/ID</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data de Exclusão</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="trashList" class="bg-white divide-y divide-gray-200">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <section id="plans-section" class="hidden">
                    <div class="flex flex-wrap justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold text-gray-700">Planos de Assinatura</h2>
                        <button data-action="open-plan-modal" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition duration-300">
                            + Novo Plano
                        </button>
                    </div>
                    <div id="plansList" class="bg-white rounded-lg shadow-md overflow-hidden"></div>
                </section>
            </main>
        </div>
    </div>

    <div id="establishmentModal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 items-center justify-center p-4">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <h2 id="modalTitle" class="text-2xl font-semibold text-gray-800 p-6 border-b">Novo Estabelecimento</h2>
            <form id="establishmentForm" class="p-6 space-y-6 overflow-y-auto">
                <input type="hidden" id="editEstablishmentId">
                
                <div id="access-links-container" class="hidden">
                    <h3 class="text-lg font-semibold text-gray-700 border-b pb-2">Links de Acesso</h3>
                    <div class="space-y-3 mt-4">
                        <div class="flex items-center gap-2">
                            <input type="text" id="schedulingLink" readonly class="w-full p-2 border bg-gray-100 rounded-md text-sm">
                            <button type="button" data-action="copy-link" data-target="schedulingLink" class="py-2 px-3 bg-gray-200 text-gray-700 font-semibold rounded-lg text-sm">Copiar</button>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="text" id="adminLink" readonly class="w-full p-2 border bg-gray-100 rounded-md text-sm">
                            <button type="button" data-action="copy-link" data-target="adminLink" class="py-2 px-3 bg-gray-200 text-gray-700 font-semibold rounded-lg text-sm">Copiar</button>
                        </div>
                    </div>
                </div>

                <h3 class="text-lg font-semibold text-gray-700 border-b pb-2">Informações Básicas</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="establishmentName" class="block text-sm font-medium text-gray-700">Nome</label>
                        <input type="text" id="establishmentName" class="mt-1 w-full p-2 border border-gray-300 rounded-md" required>
                    </div>
                    <div>
                        <label for="establishmentId" class="block text-sm font-medium text-gray-700">ID Único (URL)</label>
                        <input type="text" id="establishmentId" class="mt-1 w-full p-2 border border-gray-300 rounded-md" required>
                    </div>
                </div>
                
                <div id="owner-credentials-container">
                    <h3 class="text-lg font-semibold text-gray-700 border-b pb-2 pt-4">Credenciais do Dono</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                         <div>
                            <label for="ownerEmail" class="block text-sm font-medium text-gray-700">E-mail do Dono</label>
                            <input type="email" id="ownerEmail" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label for="ownerPassword" class="block text-sm font-medium text-gray-700">Senha Provisória</label>
                            <input type="password" id="ownerPassword" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                        </div>
                    </div>
                </div>

                <h3 class="text-lg font-semibold text-gray-700 border-b pb-2 pt-4">Plano de Assinatura</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                     <div>
                        <label for="subscriptionPlan" class="block text-sm font-medium text-gray-700">Plano</label>
                        <select id="subscriptionPlan" class="mt-1 w-full p-2 border border-gray-300 rounded-md bg-white"></select>
                    </div>
                    <div>
                        <label for="subscriptionExpiry" class="block text-sm font-medium text-gray-700">Expira em</label>
                        <input type="date" id="subscriptionExpiry" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                    </div>
                </div>

                <h3 class="text-lg font-semibold text-gray-700 border-b pb-2 pt-4">Módulos do Sistema</h3>
                <div id="modulesContainer" class="grid grid-cols-2 sm:grid-cols-3 gap-4"></div>
            </form>
            <div class="mt-auto p-6 border-t flex justify-end gap-4 bg-gray-50">
                <button type="button" data-action="close-modal" class="py-2 px-4 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300">Cancelar</button>
                <button type="submit" form="establishmentForm" class="py-2 px-4 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700">Salvar</button>
            </div>
        </div>
    </div>
    
    <div id="planModal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 items-center justify-center p-4">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <h2 id="planModalTitle" class="text-2xl font-semibold text-gray-800 p-6 border-b">Novo Plano</h2>
             <form id="planForm" class="p-6 space-y-6 overflow-y-auto">
                 <input type="hidden" id="editPlanId">
                 <div>
                    <label for="planName" class="block text-sm font-medium text-gray-700">Nome do Plano</label>
                    <input type="text" id="planName" class="mt-1 w-full p-2 border border-gray-300 rounded-md" required>
                 </div>
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                     <div>
                        <label for="planPrice" class="block text-sm font-medium text-gray-700">Preço (R$)</label>
                        <input type="number" id="planPrice" step="0.01" class="mt-1 w-full p-2 border border-gray-300 rounded-md" required>
                    </div>
                    <div>
                        <label for="planMaxProfessionals" class="block text-sm font-medium text-gray-700">Máx. Profissionais</label>
                        <input type="number" id="planMaxProfessionals" class="mt-1 w-full p-2 border border-gray-300 rounded-md" required>
                    </div>
                     <div>
                        <label for="planMaxUsers" class="block text-sm font-medium text-gray-700">Máx. Usuários</label>
                        <input type="number" id="planMaxUsers" class="mt-1 w-full p-2 border border-gray-300 rounded-md" required>
                    </div>
                 </div>
                 <h3 class="text-lg font-semibold text-gray-700 border-b pb-2 pt-4">Módulos Permitidos</h3>
                 <div id="planModulesContainer" class="grid grid-cols-2 sm:grid-cols-3 gap-4"></div>
             </form>
            <div class="mt-auto p-6 border-t flex justify-end gap-4 bg-gray-50">
                <button type="button" data-action="close-plan-modal" class="py-2 px-4 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300">Cancelar</button>
                <button type="submit" form="planForm" class="py-2 px-4 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700">Salvar Plano</button>
            </div>
        </div>
    </div>
    
    <div id="toast-container" class="fixed bottom-5 right-5 z-[100] space-y-2"></div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyAlJaPEW5-yOb-8wkB8EJZhAML2M2yI8Ao",
            authDomain: "kairos-system.firebaseapp.com",
            projectId: "kairos-system",
            storageBucket: "kairos-system.firebasestorage.app",
            messagingSenderId: "603994960586",
            appId: "1:603994960586:web:30d2c030eed3c55eccfa33",
            measurementId: "G-SVHFXKV5EC"
        };
        
        const GRACE_PERIOD_DAYS = 5; 
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        
        let idToken = null;
        let allEstablishments = [];
        let trashedEstablishments = [];
        let allPlans = [];

        const additionalModulesDefinition = {
            'agenda': 'Agenda / Calendário',
            'comandas': 'Comandas / PDV',
            'relatorios': 'Relatórios (Analytics)',
            'sales-report': 'Relatório de Vendas', 
            'financial': 'Financeiro', 
            'servicos': 'Serviços',
            'produtos': 'Produtos', 
            'profissionais': 'Profissionais', 
            'clientes': 'Clientes',
            'estabelecimento': 'Configurações', 
            'users': 'Usuários Internos', 
            'mobileApp': 'Acesso App Mobile'
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    const idTokenResult = await user.getIdTokenResult(true);
                    if (idTokenResult.claims.role !== 'super-admin') {
                        await signOut(auth);
                        window.location.href = '/admin-login';
                        return;
                    }
                    idToken = await user.getIdToken();
                    document.body.style.display = 'flex';
                    document.getElementById('userDisplayEmail').textContent = user.email;
                    initializePage();
                } catch (error) {
                    await signOut(auth);
                    window.location.href = '/admin-login';
                }
            } else {
                window.location.href = '/admin-login';
            }
        });

        function initializePage() {
            document.getElementById('logoutButton').addEventListener('click', () => signOut(auth));
            document.getElementById('establishmentForm').addEventListener('submit', handleFormSubmit);
            document.getElementById('planForm').addEventListener('submit', handlePlanFormSubmit);
            document.getElementById('searchInput').addEventListener('input', renderEstablishmentsTable);
            
            document.body.addEventListener('click', handlePageClick);
            
            setupSidebar();
            setupNavigation();

            loadEstablishments();
            loadPlans();
        }

        function setupSidebar() {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            let isManuallyExpanded = false;

            const updateSidebarState = (expanded) => {
                sidebar.classList.toggle('expanded', expanded);
            };
            
            sidebar.addEventListener('mouseenter', () => {
                if (!isManuallyExpanded && window.innerWidth >= 1024) updateSidebarState(true);
            });

            sidebar.addEventListener('mouseleave', () => {
               if (!isManuallyExpanded && window.innerWidth >= 1024) updateSidebarState(false);
            });

            sidebarToggle.addEventListener('click', (e) => {
                e.preventDefault();
                isManuallyExpanded = !sidebar.classList.contains('expanded');
                updateSidebarState(isManuallyExpanded);
            });

            updateSidebarState(false);
        }

        function setupNavigation() {
            const navLinks = document.querySelectorAll('.sidebar-link');
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();

                    const href = link.getAttribute('href');

                    if (href.startsWith('#')) {
                        navLinks.forEach(l => l.classList.remove('active'));
                        link.classList.add('active');
                        
                        const targetId = href.substring(1);
                        document.querySelectorAll('main > section').forEach(section => {
                            section.classList.add('hidden');
                        });
                        
                        document.getElementById('pageTitle').textContent = link.querySelector('.sidebar-text').textContent;
                        document.getElementById(targetId + '-section').classList.remove('hidden');

                        if (targetId === 'trash') {
                            loadTrash();
                        }
                    } else {
                        window.location.href = href;
                    }
                });
            });
        }
        
        function updateModuleCheckboxes() {
            const planId = document.getElementById('subscriptionPlan').value;
            const selectedPlan = allPlans.find(p => p.id === planId);
            const modulesContainer = document.getElementById('modulesContainer');
            const establishmentModules = JSON.parse(modulesContainer.dataset.modules || '{}');
            
            modulesContainer.innerHTML = '';
            
            Object.entries(additionalModulesDefinition).forEach(([key, label]) => {
                const isFromPlan = selectedPlan?.allowedModules?.[key] === true;
                const isManuallyAdded = establishmentModules?.[key] === true;
                const isChecked = isFromPlan || isManuallyAdded;
                
                const moduleHtml = `
                    <label for="module-${key}" class="flex items-center space-x-2 cursor-pointer ${isFromPlan ? 'bg-indigo-50 p-2 rounded-md' : ''}">
                        <div class="relative">
                            <input type="checkbox" id="module-${key}" name="modules" value="${key}" class="sr-only" ${isChecked ? 'checked' : ''} ${isFromPlan ? 'disabled' : ''}>
                            <div class="toggle-bg block bg-gray-400 w-10 h-6 rounded-full"></div>
                            <div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition"></div>
                        </div>
                        <span class="text-sm font-medium text-gray-700">${label}</span>
                    </label>
                `;
                modulesContainer.innerHTML += moduleHtml;
            });
        }

        const API_BASE_URL = window.location.origin;
        const getAuthHeaders = () => ({ 'Content-Type': 'application/json', 'Authorization': `Bearer ${idToken}` });

        async function apiCall(endpoint, options = {}) {
            const response = await fetch(`${API_BASE_URL}${endpoint}`, { headers: getAuthHeaders(), ...options });
            if (!response.ok) {
                const result = await response.json().catch(() => ({ message: response.statusText }));
                throw new Error(result.message || 'Ocorreu um erro.');
            }
            if (response.status === 204 || response.headers.get('content-length') === '0') return null;
            return response.json();
        }
        
        const establishmentModal = document.getElementById('establishmentModal');
        const planModal = document.getElementById('planModal');
        
        async function openModal(establishment = null) {
            const form = document.getElementById('establishmentForm');
            form.reset();
            const isEditing = !!establishment;
            
            const modulesContainer = document.getElementById('modulesContainer');
            modulesContainer.dataset.modules = JSON.stringify(establishment?.modules || {});
            
            document.getElementById('access-links-container').classList.toggle('hidden', !isEditing);
            if (isEditing) {
                const schedulingLink = `${window.location.origin}/agendar?id=${establishment.id}`;
                const adminLink = `${window.location.origin}/login`;
                document.getElementById('schedulingLink').value = schedulingLink;
                document.getElementById('adminLink').value = adminLink;
            }

            document.getElementById('modalTitle').textContent = isEditing ? "Editar Estabelecimento" : "Novo Estabelecimento";
            document.getElementById('editEstablishmentId').value = establishment?.id || '';
            document.getElementById('establishmentName').value = establishment?.name || '';
            document.getElementById('establishmentId').value = establishment?.id || '';
            document.getElementById('establishmentId').disabled = isEditing;
            
            const ownerEmailInput = document.getElementById('ownerEmail');
            const ownerPasswordInput = document.getElementById('ownerPassword');
            const credentialsContainer = document.getElementById('owner-credentials-container');
            
            ownerEmailInput.value = establishment?.ownerEmail || '';
            credentialsContainer.style.display = isEditing ? 'none' : 'block';

            if (isEditing) {
                ownerEmailInput.removeAttribute('required');
                ownerPasswordInput.removeAttribute('required');
                ownerEmailInput.disabled = true;
                ownerPasswordInput.disabled = true;

                const expiryDateRaw = establishment?.subscription?.expiryDate;
                if (expiryDateRaw && expiryDateRaw._seconds) {
                    const expiryDate = new Date(expiryDateRaw._seconds * 1000);
                    document.getElementById('subscriptionExpiry').value = expiryDate.toISOString().split('T')[0];
                } else {
                    document.getElementById('subscriptionExpiry').value = '';
                }

            } else {
                ownerEmailInput.setAttribute('required', 'required');
                ownerPasswordInput.setAttribute('required', 'required');
                ownerPasswordInput.disabled = false;
                ownerEmailInput.disabled = false;
            }
            
            const planSelect = document.getElementById('subscriptionPlan');
            planSelect.innerHTML = allPlans.map(plan => `<option value="${plan.id}">${plan.name}</option>`).join('');
            if (establishment?.subscription?.planId) {
                planSelect.value = establishment.subscription.planId;
            } else if (allPlans.length > 0) {
                 planSelect.value = allPlans[0].id;
            }
            
            updateModuleCheckboxes();

            establishmentModal.classList.add('flex');
            setTimeout(() => establishmentModal.style.opacity = "1", 10);
        }
        
        function closeModal() {
            establishmentModal.style.opacity = "0";
            setTimeout(() => establishmentModal.classList.remove('flex'), 300);
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            const editId = document.getElementById('editEstablishmentId').value;
            const isEditing = !!editId;
        
            const modules = {};
            document.querySelectorAll('input[name="modules"]').forEach(checkbox => {
                modules[checkbox.value] = checkbox.checked;
            });
        
            const data = {
                establishmentId: document.getElementById('establishmentId').value,
                name: document.getElementById('establishmentName').value,
                ownerEmail: document.getElementById('ownerEmail').value,
                modules: modules
            };
        
            if (!isEditing) {
                data.ownerPassword = document.getElementById('ownerPassword').value;
            }
            
            const planId = document.getElementById('subscriptionPlan').value;
            const expiryDate = document.getElementById('subscriptionExpiry').value;
            if (planId && expiryDate) {
                 data.subscription = { planId, expiryDate };
            }
        
            try {
                if (isEditing) {
                    await apiCall(`/api/admin/establishments/${editId}/modules`, { method: 'PATCH', body: JSON.stringify({ modules: data.modules }) });
                    await apiCall(`/api/admin/establishments/${editId}/details`, { method: 'PUT', body: JSON.stringify({ name: data.name }) });
                    
                    if (planId && expiryDate) {
                         await apiCall(`/api/subscriptions/assign/${editId}`, { method: 'PATCH', body: JSON.stringify({ planId, expiryDate }) });
                    }
                    
                    showToast('Estabelecimento atualizado com sucesso!', 'success');
                } else {
                    await apiCall('/api/admin/establishments', { method: 'POST', body: JSON.stringify(data) });
                    showToast('Estabelecimento criado com sucesso!', 'success');
                }
                closeModal();
                loadEstablishments();
            } catch (error) {
                showToast(`Erro: ${error.message}`, 'error');
            }
        }
        
        async function loadEstablishments() {
            const listDiv = document.getElementById('establishmentsList');
            listDiv.innerHTML = '<tr><td colspan="6" class="text-center p-4"><div class="loader mx-auto"></div></td></tr>';
            try {
                allEstablishments = await apiCall('/api/admin/establishments');
                renderEstablishmentsTable();
            } catch (error) {
                listDiv.innerHTML = '<tr><td colspan="6" class="text-center p-4"><p class="text-red-500">Erro ao carregar estabelecimentos.</p></td></tr>';
            }
        }

        function renderEstablishmentsTable() {
            const listDiv = document.getElementById('establishmentsList');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allEstablishments.filter(est => 
                est.name.toLowerCase().includes(searchTerm) || est.id.toLowerCase().includes(searchTerm)
            );
        
            if (filtered.length > 0) {
                listDiv.innerHTML = filtered.map(est => {
                    const isActive = est.status === 'active';
                    const planName = allPlans.find(p => p.id === est.subscription?.planId)?.name || 'N/A';
                    
                    const expiryDateRaw = est.subscription?.expiryDate ? new Date(est.subscription.expiryDate._seconds * 1000) : null;
                    const expiryDate = expiryDateRaw ? expiryDateRaw.toLocaleDateString('pt-BR') : 'N/A';
                    
                    let subStatus = 'N/A';
                    let subStatusClass = 'bg-gray-200 text-gray-800';
                    
                    if (expiryDateRaw) {
                        const today = new Date();
                        const gracePeriodEnd = new Date(expiryDateRaw);
                        gracePeriodEnd.setDate(gracePeriodEnd.getDate() + GRACE_PERIOD_DAYS);

                        if (today > gracePeriodEnd) {
                            subStatus = 'BLOQUEADO';
                            subStatusClass = 'bg-red-500 text-white';
                        } else if (today > expiryDateRaw) {
                            subStatus = 'CARÊNCIA';
                            subStatusClass = 'bg-yellow-500 text-black';
                        } else {
                            subStatus = 'ATIVO';
                            subStatusClass = 'bg-green-500 text-white';
                        }
                    }

                    return `
                        <tr class="hover:bg-indigo-50">
                            <td class="px-6 py-4 whitespace-nowrap cursor-pointer" data-action="edit-establishment" data-id="${est.id}">
                                <div class="text-sm font-medium text-gray-900">${est.name}</div>
                                <div class="text-xs text-gray-500 font-mono">${est.id}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${planName}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${expiryDate}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${subStatusClass}">${subStatus}</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <label class="flex items-center justify-end cursor-pointer" data-action="toggle-status" data-id="${est.id}">
                                  <div class="relative">
                                    <input type="checkbox" class="sr-only" ${isActive ? 'checked' : ''}>
                                    <div class="toggle-bg block bg-gray-400 w-10 h-6 rounded-full"></div>
                                    <div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition"></div>
                                  </div>
                                </label>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <button data-action="delete-establishment" data-id="${est.id}" class="text-red-600 hover:text-red-900">Lixeira</button>
                            </td>
                        </tr>
                    `;
                }).join('');
            } else {
                listDiv.innerHTML = `<tr><td colspan="6" class="text-center p-4">Nenhum estabelecimento encontrado.</td></tr>`;
            }
        }
        
        async function loadTrash() {
            const trashList = document.getElementById('trashList');
            trashList.innerHTML = '<tr><td colspan="3" class="text-center p-4"><div class="loader mx-auto"></div></td></tr>';
            try {
                trashedEstablishments = await apiCall('/api/admin/establishments?includeDeleted=true');
                renderTrashTable();
            } catch (error) {
                trashList.innerHTML = '<tr><td colspan="3" class="text-center p-4 text-red-500">Erro ao carregar lixeira.</td></tr>';
            }
        }

        function renderTrashTable() {
            const trashList = document.getElementById('trashList');
            if (trashedEstablishments.length > 0) {
                trashList.innerHTML = trashedEstablishments.map(est => {
                    const deletedDate = est.deletedAt ? new Date(est.deletedAt._seconds * 1000).toLocaleDateString('pt-BR') : 'N/A';
                    return `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">${est.name}</div>
                                <div class="text-xs text-gray-500 font-mono">${est.id}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${deletedDate}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-4">
                                <button data-action="restore-establishment" data-id="${est.id}" class="text-green-600 hover:text-green-900">Restaurar</button>
                            </td>
                        </tr>
                    `;
                }).join('');
            } else {
                trashList.innerHTML = `<tr><td colspan="3" class="text-center p-4">Lixeira vazia.</td></tr>`;
            }
        }

        async function handlePageClick(e) {
            const target = e.target.closest('[data-action]');
            if (!target) return;

            e.stopPropagation();
            const action = target.dataset.action;
            const id = target.dataset.id;
            
            switch(action) {
                case 'open-create-modal':
                    openModal();
                    break;
                case 'close-modal':
                    closeModal();
                    break;
                case 'open-plan-modal':
                    openPlanModal();
                    break;
                case 'close-plan-modal':
                    closePlanModal();
                    break;
                case 'edit-establishment': {
                    const establishment = allEstablishments.find(est => est.id === id);
                    if (establishment) openModal(establishment);
                    break;
                }
                case 'toggle-status': {
                    const toggleInput = target.querySelector('input[type="checkbox"]');
                    const statusToSubmit = !toggleInput.checked ? 'active' : 'inactive';
                    try {
                        await apiCall(`/api/admin/establishments/${id}/status`, {
                            method: 'PATCH', body: JSON.stringify({ status: statusToSubmit }),
                        });
                        showToast(`Status atualizado para ${statusToSubmit}.`, 'success');
                        loadEstablishments(); 
                    } catch (error) {
                        showToast(`Erro ao atualizar status: ${error.message}`, 'error');
                        loadEstablishments(); 
                    }
                    break;
                }
                case 'delete-establishment': {
                    if (confirm('Tem certeza que deseja mover este estabelecimento para a lixeira?')) {
                        try {
                            await apiCall(`/api/admin/establishments/${id}`, { method: 'DELETE' });
                            showToast('Estabelecimento movido para a lixeira!', 'success');
                            loadEstablishments();
                        } catch (error) {
                            showToast(`Erro: ${error.message}`, 'error');
                        }
                    }
                    break;
                }
                case 'restore-establishment': {
                    if (confirm('Tem certeza que deseja restaurar este estabelecimento?')) {
                        try {
                            await apiCall(`/api/admin/establishments/${id}/restore`, { method: 'POST' });
                            showToast('Estabelecimento restaurado!', 'success');
                            loadTrash();
                            loadEstablishments();
                        } catch (error) {
                            showToast(`Erro: ${error.message}`, 'error');
                        }
                    }
                    break;
                }
                case 'edit-plan': {
                    const plan = allPlans.find(p => p.id === id);
                    if (plan) openPlanModal(plan);
                    break;
                }
                case 'delete-plan': {
                    if (confirm('Tem a certeza que deseja apagar este plano?')) {
                        try {
                            await apiCall(`/api/subscriptions/plans/${id}`, { method: 'DELETE' });
                            showToast('Plano apagado com sucesso!', 'success');
                            loadPlans();
                        } catch (error) {
                            showToast(`Erro: ${error.message}`, 'error');
                        }
                    }
                    break;
                }
                case 'copy-link': {
                    const targetInputId = target.dataset.target;
                    const inputToCopy = document.getElementById(targetInputId);
                    inputToCopy.select();
                    document.execCommand('copy');
                    showToast('Link copiado!', 'success');
                    break;
                }
            }
        }
        
        async function loadPlans() {
            const listDiv = document.getElementById('plansList');
            listDiv.innerHTML = '<div class="p-4 text-center">A carregar planos...</div>';
            try {
                allPlans = await apiCall('/api/subscriptions/plans');
                renderPlansTable();
            } catch (error) {
                 listDiv.innerHTML = '<div class="p-4 text-center text-red-500">Erro ao carregar planos.</div>';
            }
        }
        
        function renderPlansTable() {
            const listDiv = document.getElementById('plansList');
            let tableHTML = `<div class="overflow-x-auto"><table class="w-full text-sm text-left text-gray-500">
                <thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr>
                    <th class="px-6 py-3">Nome do Plano</th>
                    <th class="px-6 py-3">Preço</th>
                    <th class="px-6 py-3">Limites</th>
                    <th class="px-6 py-3">Módulos</th>
                    <th class="px-6 py-3">Ações</th>
                </tr></thead><tbody>`;
            
            if (allPlans.length > 0) {
                allPlans.forEach(plan => {
                    const modulesCount = plan.allowedModules ? Object.values(plan.allowedModules).filter(v => v).length : 0;
                    tableHTML += `
                        <tr class="bg-white border-b hover:bg-gray-50">
                            <td class="px-6 py-4 font-medium text-gray-900">${plan.name}</td>
                            <td class="px-6 py-4 text-gray-600">R$ ${plan.price.toFixed(2)}</td>
                            <td class="px-6 py-4 text-gray-600">Profs: ${plan.maxProfessionals} / Users: ${plan.maxUsers}</td>
                            <td class="px-6 py-4 text-gray-600">${modulesCount} módulos</td>
                            <td class="px-6 py-4 flex gap-4">
                                <button data-action="edit-plan" data-id="${plan.id}" class="font-medium text-indigo-600 hover:underline">Gerir</button>
                                <button data-action="delete-plan" data-id="${plan.id}" class="font-medium text-red-600 hover:underline">Apagar</button>
                            </td>
                        </tr>`;
                });
            } else {
                tableHTML += `<tr><td colspan="5" class="text-center p-4">Nenhum plano criado.</td></tr>`;
            }
            tableHTML += '</tbody></table></div>';
            listDiv.innerHTML = tableHTML;
        }

        function openPlanModal(plan = null) {
            const form = document.getElementById('planForm');
            form.reset();
            const isEditing = !!plan;

            document.getElementById('planModalTitle').textContent = isEditing ? "Editar Plano" : "Novo Plano";
            document.getElementById('editPlanId').value = plan?.id || '';
            document.getElementById('planName').value = plan?.name || '';
            document.getElementById('planPrice').value = plan?.price || '';
            document.getElementById('planMaxProfessionals').value = plan?.maxProfessionals || '';
            document.getElementById('planMaxUsers').value = plan?.maxUsers || '';
            
            const modulesContainer = document.getElementById('planModulesContainer');
            modulesContainer.innerHTML = Object.entries(additionalModulesDefinition).map(([key, label]) => `
                <label for="plan-module-${key}" class="flex items-center space-x-2 cursor-pointer">
                    <div class="relative">
                        <input type="checkbox" id="plan-module-${key}" name="plan-modules" value="${key}" class="sr-only" ${plan?.allowedModules?.[key] ? 'checked' : ''}>
                        <div class="toggle-bg block bg-gray-400 w-10 h-6 rounded-full"></div>
                        <div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition"></div>
                    </div>
                    <span class="text-sm font-medium text-gray-700">${label}</span>
                </label>
            `).join('');
            
            planModal.classList.add('flex');
            setTimeout(() => planModal.style.opacity = "1", 10);
        }

        function closePlanModal() {
             planModal.style.opacity = "0";
            setTimeout(() => planModal.classList.remove('flex'), 300);
        }

        async function handlePlanFormSubmit(e) {
            e.preventDefault();
            const editPlanId = document.getElementById('editPlanId').value;
            const isEditing = !!editPlanId;

            const allowedModules = {};
            document.querySelectorAll('input[name="plan-modules"]').forEach(checkbox => {
                allowedModules[checkbox.value] = checkbox.checked;
            });

            const data = {
                name: document.getElementById('planName').value,
                price: parseFloat(document.getElementById('planPrice').value),
                maxProfessionals: parseInt(document.getElementById('planMaxProfessionals').value),
                maxUsers: parseInt(document.getElementById('planMaxUsers').value),
                allowedModules
            };

            try {
                if (isEditing) {
                    await apiCall(`/api/subscriptions/plans/${editPlanId}`, { method: 'PUT', body: JSON.stringify(data) });
                    showToast('Plano atualizado com sucesso!', 'success');
                } else {
                    await apiCall('/api/subscriptions/plans', { method: 'POST', body: JSON.stringify(data) });
                    showToast('Plano criado com sucesso!', 'success');
                }
                closePlanModal();
                loadPlans();
            } catch (error) {
                showToast(`Erro: ${error.message}`, 'error');
            }
        }
        
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const colors = { success: 'bg-green-500', error: 'bg-red-500', info: 'bg-blue-500' };
            toast.className = `px-4 py-2 text-white rounded-md shadow-lg ${colors[type]} animate-fade-in-out`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

    </script>
</body>
</html>