<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Super Admin - Kairos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            display: none; /* Evita flash de conteúdo */
            background-color: #f8fafc; /* bg-slate-50 */
        }
        
        /* --- SCROLLBAR PERSONALIZADA (Fina e discreta) --- */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .modal {
            display: none;
            transition: opacity 0.3s ease;
            z-index: 100;
        }
        .modal.flex { display: flex; }

        /* --- LAYOUT E SIDEBAR MODERNIZADA --- */
        #fixed-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 4rem; /* h-16 (64px) - Mais compacto */
            z-index: 30;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid #e2e8f0;
        }
        
        #sidebar {
            width: 5rem; /* 80px colapsado */
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: fixed;
            top: 0; /* Sidebar vai até o topo agora, estilo moderno */
            left: 0;
            height: 100vh;
            z-index: 40;
            background-color: #0f172a; /* slate-900 */
            box-shadow: 4px 0 24px rgba(0,0,0,0.05);
        }

        #main-content-wrapper {
            margin-left: 5rem;
            transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            padding-top: 4rem; /* Espaço do header */
            width: calc(100% - 5rem);
            min-height: 100vh;
        }

        /* Estado Expandido */
        #sidebar.expanded {
            width: 17rem; /* 272px */
        }
        #sidebar.expanded + #main-content-wrapper {
            margin-left: 17rem;
            width: calc(100% - 17rem);
        }

        /* Esconder textos quando colapsado */
        #sidebar:not(.expanded) .sidebar-text,
        #sidebar:not(.expanded) .group-label,
        #sidebar:not(.expanded) .sidebar-logo-text {
            opacity: 0;
            pointer-events: none;
            width: 0;
            overflow: hidden;
            display: none; /* Garante que não ocupe espaço */
        }
        
        /* Centralizar ícones quando colapsado */
        #sidebar:not(.expanded) .sidebar-link {
            justify-content: center;
            padding-left: 0;
            padding-right: 0;
        }
        
        /* Ajuste do botão de toggle */
        #sidebarToggle {
            position: absolute;
            right: -12px;
            top: 48px;
            background: white;
            border: 1px solid #e2e8f0;
            color: #64748b;
            border-radius: 50%;
            padding: 4px;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: transform 0.3s, color 0.2s;
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
        }
        #sidebarToggle:hover { color: #4f46e5; }
        #sidebar.expanded #sidebarToggle { transform: rotate(180deg); }

        /* Checkbox e Toggle Personalizados (UI) */
        .dot { transition: transform .2s ease-in-out; }
        input[type="checkbox"]:checked ~ .dot { transform: translateX(100%); }
        input[type="checkbox"]:checked ~ .toggle-bg { background-color: #4f46e5; }
        .toggle-bg:after {
            content: ''; position: absolute; top: 2px; left: 2px; background: white;
            width: 1.25rem; height: 1.25rem; border-radius: 9999px; transition: transform 0.2s ease-in-out;
        }
        input:checked + .toggle-bg:after { transform: translateX(100%); }
        
        /* Animações */
        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up { animation: fade-in-up 0.4s ease-out forwards; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <aside id="sidebar" class="flex flex-col text-slate-400 transition-all duration-300">
        
        <button id="sidebarToggle">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
        </button>

        <div class="h-16 flex items-center px-6 border-b border-slate-800/50 shrink-0">
            <div class="flex items-center gap-3 overflow-hidden whitespace-nowrap">
                <div class="w-8 h-8 rounded-lg bg-indigo-600 flex items-center justify-center text-white font-bold shrink-0 shadow-lg shadow-indigo-500/20">K</div>
                <span class="sidebar-logo-text font-bold text-lg text-white tracking-wide">KAIROS</span>
            </div>
        </div>

        <nav class="flex-1 overflow-y-auto py-6 px-3 space-y-6">
            
            <div>
                <p class="group-label text-xs font-semibold text-slate-500 uppercase tracking-wider mb-3 px-3">Principal</p>
                <ul class="space-y-1">
                    <li>
                        <a href="#dashboard" class="sidebar-link flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all duration-200 hover:bg-slate-800 hover:text-white group relative active" title="Visão Geral">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 shrink-0 group-hover:text-indigo-400 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>
                            <span class="sidebar-text font-medium">Visão Geral</span>
                        </a>
                    </li>
                </ul>
            </div>

            <div>
                <p class="group-label text-xs font-semibold text-slate-500 uppercase tracking-wider mb-3 px-3">Gestão</p>
                <ul class="space-y-1">
                    <li>
                        <a href="#establishments" class="sidebar-link flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all duration-200 hover:bg-slate-800 hover:text-white group" title="Clientes">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 shrink-0 group-hover:text-indigo-400 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg>
                            <span class="sidebar-text font-medium">Clientes</span>
                        </a>
                    </li>
                    <li>
                        <a href="#plans" class="sidebar-link flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all duration-200 hover:bg-slate-800 hover:text-white group" title="Planos de Assinatura">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 shrink-0 group-hover:text-indigo-400 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8a1 1 0 011 1v4a1 1 0 11-2 0v-4a1 1 0 011-1zm0 0a1 1 0 001-1V5a1 1 0 10-2 0v2a1 1 0 001 1zm0 0a1 1 0 011 1v2a1 1 0 11-2 0v-2a1 1 0 011-1z" /></svg>
                            <span class="sidebar-text font-medium">Planos</span>
                        </a>
                    </li>
                </ul>
            </div>

            <div>
                <p class="group-label text-xs font-semibold text-slate-500 uppercase tracking-wider mb-3 px-3">Sistema</p>
                <ul class="space-y-1">
                    <li>
                        <a href="#trash" class="sidebar-link flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all duration-200 hover:bg-slate-800 hover:text-red-400 group" title="Lixeira">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 shrink-0 group-hover:text-red-400 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m-7-10V4a1 1 0 00-1-1h-2a1 1 0 00-1 1v3M4 7h16" /></svg>
                            <span class="sidebar-text font-medium">Lixeira</span>
                        </a>
                    </li>
                </ul>
            </div>
        </nav>

        <div class="p-4 border-t border-slate-800/50 shrink-0 bg-slate-900">
            <div class="flex items-center gap-3">
                <div class="w-9 h-9 rounded-full bg-slate-700 flex items-center justify-center text-slate-300 font-bold text-sm shrink-0">A</div>
                <div class="sidebar-text overflow-hidden flex-1">
                    <p class="text-sm font-medium text-white truncate" id="userDisplayName">Super Admin</p>
                    <button id="logoutButtonFooter" class="text-xs text-slate-400 hover:text-red-400 transition-colors flex items-center gap-1 mt-0.5">
                        Sair da conta
                    </button>
                </div>
            </div>
        </div>

    </aside>

    <header id="fixed-header" class="flex items-center justify-between px-8 transition-all duration-300" style="margin-left: 5rem;">
        <h1 class="text-xl font-bold text-slate-800" id="pageTitle">Visão Geral</h1>
        
        <div class="flex items-center gap-4">
            <span id="userDisplayEmail" class="text-sm text-slate-500 hidden sm:block"></span>
        </div>
    </header>

    <div id="main-content-wrapper" class="flex-1 flex flex-col transition-all duration-300">
        <main class="flex-1 p-6 sm:p-8 overflow-y-auto">
            
            <section id="dashboard-section">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 hover:shadow-md transition-shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-xs font-semibold text-slate-500 uppercase tracking-wide">MRR (Mensal)</p>
                                <p class="text-2xl font-bold text-slate-800 mt-1" id="kpi-mrr">R$ 0,00</p>
                            </div>
                            <div class="p-3 bg-indigo-50 text-indigo-600 rounded-lg">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8a1 1 0 011 1v4a1 1 0 11-2 0v-4a1 1 0 011-1zm0 0a1 1 0 001-1V5a1 1 0 10-2 0v2a1 1 0 001 1zm0 0a1 1 0 011 1v2a1 1 0 11-2 0v-2a1 1 0 011-1z" /></svg>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 hover:shadow-md transition-shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-xs font-semibold text-slate-500 uppercase tracking-wide">Ativos</p>
                                <p class="text-2xl font-bold text-slate-800 mt-1" id="kpi-active">0</p>
                            </div>
                            <div class="p-3 bg-emerald-50 text-emerald-600 rounded-lg">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 hover:shadow-md transition-shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-xs font-semibold text-slate-500 uppercase tracking-wide">Churn Rate</p>
                                <p class="text-2xl font-bold text-slate-800 mt-1" id="kpi-churn">0%</p>
                            </div>
                            <div class="p-3 bg-rose-50 text-rose-600 rounded-lg">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 hover:shadow-md transition-shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-xs font-semibold text-slate-500 uppercase tracking-wide">Atenção</p>
                                <p class="text-2xl font-bold text-slate-800 mt-1" id="kpi-attention">0</p>
                            </div>
                            <div class="p-3 bg-amber-50 text-amber-600 rounded-lg">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 lg:col-span-2">
                        <h3 class="text-lg font-bold text-slate-800 mb-4">Novos Assinantes</h3>
                        <div class="relative h-64 w-full">
                            <canvas id="growthChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                        <h3 class="text-lg font-bold text-slate-800 mb-4">Renovações Próximas</h3>
                        <div class="overflow-y-auto max-h-64">
                            <table class="min-w-full text-sm text-left">
                                <tbody id="attentionListTable" class="divide-y divide-slate-100"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <section id="establishments-section" class="hidden animate-fade-in-up">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800">Clientes</h2>
                        <p class="text-sm text-slate-500">Gerencie o acesso e planos dos estabelecimentos.</p>
                    </div>
                    <button data-action="open-create-modal" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2.5 px-5 rounded-lg shadow-sm transition-colors flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                        Novo Cliente
                    </button>
                </div>

                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-6">
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                        <div class="col-span-1 sm:col-span-2 lg:col-span-1">
                            <label class="block text-xs font-semibold text-slate-500 mb-1.5">Buscar</label>
                            <div class="relative">
                                <svg class="absolute left-3 top-2.5 h-5 w-5 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                                <input type="text" id="filterSearch" placeholder="Nome, ID ou E-mail" class="pl-10 w-full p-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-shadow">
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-slate-500 mb-1.5">Status</label>
                            <select id="filterStatus" class="w-full p-2 border border-slate-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-indigo-500">
                                <option value="all">Todos</option>
                                <option value="active" selected>Ativos</option>
                                <option value="inactive">Inativos</option>
                                <option value="deleted">Lixeira</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-slate-500 mb-1.5">Plano</label>
                            <select id="filterPlan" class="w-full p-2 border border-slate-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-indigo-500">
                                <option value="all">Todos</option>
                            </select>
                        </div>
                         <div>
                            <button id="clearFiltersBtn" class="w-full py-2 px-3 text-sm text-slate-600 hover:text-red-600 font-medium border border-slate-300 rounded-lg hover:bg-slate-50 transition-colors">
                                Limpar Filtros
                            </button>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-slate-200">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider cursor-pointer hover:bg-slate-100" data-sort="name">Cliente <span class="sort-icon ml-1 text-slate-400">↕</span></th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider cursor-pointer hover:bg-slate-100" data-sort="planId">Plano <span class="sort-icon ml-1 text-slate-400">↕</span></th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider cursor-pointer hover:bg-slate-100" data-sort="createdAt">Cadastro <span class="sort-icon ml-1 text-slate-400">↕</span></th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-right text-xs font-bold text-slate-500 uppercase tracking-wider">App</th>
                                    <th class="px-6 py-3 text-right text-xs font-bold text-slate-500 uppercase tracking-wider">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="establishmentsList" class="bg-white divide-y divide-slate-200 text-sm"></tbody>
                        </table>
                    </div>
                    <div id="paginationControls" class="bg-white px-4 py-3 border-t border-slate-200 flex items-center justify-between sm:px-6">
                        <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                            <p class="text-sm text-slate-700">Exibindo <span id="pageStart" class="font-bold">0</span> a <span id="pageEnd" class="font-bold">0</span> de <span id="totalItems" class="font-bold">0</span></p>
                            <nav class="isolate inline-flex -space-x-px rounded-md shadow-sm" aria-label="Pagination">
                                <button id="prevPageBtn" class="relative inline-flex items-center rounded-l-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0">
                                    <span class="sr-only">Anterior</span>
                                    <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M12.79 5.23a.75.75 0 01-.02 1.06L8.832 10l3.938 3.71a.75.75 0 11-1.04 1.08l-4.5-4.25a.75.75 0 010-1.08l4.5-4.25a.75.75 0 011.06.02z" clip-rule="evenodd" /></svg>
                                </button>
                                <button id="nextPageBtn" class="relative inline-flex items-center rounded-r-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0">
                                    <span class="sr-only">Próxima</span>
                                    <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" /></svg>
                                </button>
                            </nav>
                        </div>
                    </div>
                </div>
            </section>

            <section id="trash-section" class="hidden animate-fade-in-up">
                 <h2 class="text-2xl font-bold text-slate-800 mb-6">Lixeira</h2>
                 <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="overflow-x-auto">
                         <table class="min-w-full divide-y divide-slate-200">
                             <thead class="bg-slate-50">
                                 <tr>
                                     <th class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase">Nome/ID</th>
                                     <th class="px-6 py-3 text-left text-xs font-bold text-slate-500 uppercase">Data Exclusão</th>
                                     <th class="px-6 py-3 text-right text-xs font-bold text-slate-500 uppercase">Ações</th>
                                 </tr>
                             </thead>
                             <tbody id="trashList" class="bg-white divide-y divide-slate-200 text-sm"></tbody>
                         </table>
                     </div>
                 </div>
            </section>

            <section id="plans-section" class="hidden animate-fade-in-up">
                 <div class="flex justify-between items-center mb-6">
                     <h2 class="text-2xl font-bold text-slate-800">Planos de Assinatura</h2>
                     <button data-action="open-plan-modal" class="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2.5 px-5 rounded-lg shadow-sm transition-colors">
                         + Novo Plano
                     </button>
                 </div>
                 <div id="plansList" class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden"></div>
            </section>

        </main>
    </div>

    <div id="establishmentSlideOver" class="relative z-50 hidden" aria-labelledby="slide-over-title" role="dialog" aria-modal="true">
        <div id="slideOverBackdrop" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm transition-opacity opacity-0"></div>
        <div class="fixed inset-0 overflow-hidden">
          <div class="absolute inset-0 overflow-hidden">
            <div class="pointer-events-none fixed inset-y-0 right-0 flex max-w-full pl-10">
              <div id="slideOverPanel" class="pointer-events-auto w-screen max-w-xl transform transition ease-in-out duration-500 translate-x-full bg-white shadow-2xl flex flex-col h-full">
                
                <div class="flex h-16 items-center justify-between px-6 bg-slate-900 text-white shadow-md shrink-0">
                  <h2 class="text-lg font-semibold tracking-wide" id="slideOverTitle">Novo Cliente</h2>
                  <button type="button" data-action="close-modal" class="text-slate-400 hover:text-white transition-colors focus:outline-none">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                  </button>
                </div>
    
                <div class="flex-1 overflow-y-auto px-6 py-8 bg-slate-50">
                  <form id="establishmentForm" class="space-y-8">
                    <input type="hidden" id="editEstablishmentId">
                    
                    <div id="access-links-container" class="hidden bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                        <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4">Links de Acesso</h3>
                        <div class="grid gap-4">
                            <div>
                                <label class="block text-xs font-medium text-slate-600 mb-1.5">Agendamento</label>
                                <div class="flex shadow-sm rounded-lg overflow-hidden">
                                    <input type="text" id="schedulingLink" readonly class="w-full p-2 text-xs bg-slate-50 text-slate-600 border border-r-0 border-slate-300">
                                    <button type="button" data-action="copy-link" data-target="schedulingLink" class="px-3 bg-indigo-50 text-indigo-600 hover:bg-indigo-100 border border-l-0 border-indigo-200 font-semibold text-xs transition-colors">Copiar</button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-slate-600 mb-1.5">Painel Admin</label>
                                <div class="flex shadow-sm rounded-lg overflow-hidden">
                                    <input type="text" id="adminLink" readonly class="w-full p-2 text-xs bg-slate-50 text-slate-600 border border-r-0 border-slate-300">
                                    <button type="button" data-action="copy-link" data-target="adminLink" class="px-3 bg-indigo-50 text-indigo-600 hover:bg-indigo-100 border border-l-0 border-indigo-200 font-semibold text-xs transition-colors">Copiar</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                        <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4">Dados Básicos</h3>
                        <div class="space-y-4">
                            <div>
                                <label for="establishmentName" class="block text-sm font-medium text-slate-700 mb-1">Nome do Negócio</label>
                                <input type="text" id="establishmentName" class="w-full p-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-shadow" required>
                            </div>
                            <div>
                                <label for="establishmentId" class="block text-sm font-medium text-slate-700 mb-1">URL Personalizada (Slug)</label>
                                <div class="flex rounded-lg shadow-sm">
                                    <span class="inline-flex items-center px-3 rounded-l-lg border border-r-0 border-slate-300 bg-slate-50 text-slate-500 text-sm">kairos.com/</span>
                                    <input type="text" id="establishmentId" class="flex-1 p-2.5 border border-slate-300 rounded-r-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-shadow" required>
                                </div>
                                <p class="mt-1.5 text-xs text-slate-400">Este ID define o link de acesso. Evite caracteres especiais.</p>
                            </div>
                        </div>
                    </div>

                    <div id="owner-credentials-container" class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                        <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4">Acesso do Proprietário</h3>
                        <div class="grid grid-cols-1 gap-4">
                             <div>
                                <label for="ownerEmail" class="block text-sm font-medium text-slate-700 mb-1">E-mail</label>
                                <input type="email" id="ownerEmail" class="w-full p-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            </div>
                            <div>
                                <label for="ownerPassword" class="block text-sm font-medium text-slate-700 mb-1">Senha Inicial</label>
                                <input type="password" id="ownerPassword" class="w-full p-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                        <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4">Assinatura</h3>
                        <div class="grid grid-cols-2 gap-4">
                             <div class="col-span-2 sm:col-span-1">
                                <label for="subscriptionPlan" class="block text-sm font-medium text-slate-700 mb-1">Plano</label>
                                <select id="subscriptionPlan" class="w-full p-2.5 border border-slate-300 rounded-lg bg-white focus:ring-2 focus:ring-indigo-500"></select>
                            </div>
                            <div class="col-span-2 sm:col-span-1">
                                <label for="subscriptionExpiry" class="block text-sm font-medium text-slate-700 mb-1">Vencimento</label>
                                <input type="date" id="subscriptionExpiry" class="w-full p-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                        <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4">Módulos Liberados</h3>
                        <div id="modulesContainer" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
                    </div>
                  </form>
                </div>
    
                <div class="border-t border-slate-200 px-6 py-4 bg-white shrink-0 flex justify-end gap-3">
                    <button type="button" data-action="close-modal" class="px-4 py-2 text-sm font-semibold text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 transition-colors">Cancelar</button>
                    <button type="submit" form="establishmentForm" class="px-6 py-2 text-sm font-bold text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 shadow-sm transition-colors">Salvar</button>
                </div>
              </div>
            </div>
          </div>
        </div>
    </div>

    <div id="planModal" class="modal fixed inset-0 bg-slate-900/50 backdrop-blur-sm items-center justify-center p-4">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <h2 id="planModalTitle" class="text-xl font-bold text-slate-800 p-6 border-b border-slate-100">Novo Plano</h2>
             <form id="planForm" class="p-6 space-y-6 overflow-y-auto">
                 <input type="hidden" id="editPlanId">
                 <div>
                    <label for="planName" class="block text-sm font-medium text-slate-700 mb-1">Nome do Plano</label>
                    <input type="text" id="planName" class="w-full p-2.5 border border-slate-300 rounded-lg" required>
                 </div>
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                     <div>
                        <label for="planPrice" class="block text-sm font-medium text-slate-700 mb-1">Preço (R$)</label>
                        <input type="number" id="planPrice" step="0.01" class="w-full p-2.5 border border-slate-300 rounded-lg" required>
                    </div>
                    <div>
                        <label for="planMaxProfessionals" class="block text-sm font-medium text-slate-700 mb-1">Máx. Profs</label>
                        <input type="number" id="planMaxProfessionals" class="w-full p-2.5 border border-slate-300 rounded-lg" required>
                    </div>
                     <div>
                        <label for="planMaxUsers" class="block text-sm font-medium text-slate-700 mb-1">Máx. Users</label>
                        <input type="number" id="planMaxUsers" class="w-full p-2.5 border border-slate-300 rounded-lg" required>
                    </div>
                 </div>
                 <div>
                     <h3 class="text-sm font-medium text-slate-700 mb-3">Módulos Permitidos</h3>
                     <div id="planModulesContainer" class="grid grid-cols-2 sm:grid-cols-3 gap-3"></div>
                 </div>
             </form>
            <div class="mt-auto p-6 border-t border-slate-100 flex justify-end gap-3 bg-slate-50 rounded-b-xl">
                <button type="button" data-action="close-plan-modal" class="px-4 py-2 text-sm font-semibold text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-50">Cancelar</button>
                <button type="submit" form="planForm" class="px-6 py-2 text-sm font-bold text-white bg-emerald-600 rounded-lg hover:bg-emerald-700">Salvar Plano</button>
            </div>
        </div>
    </div>

    <div id="toast-container" class="fixed bottom-5 right-5 z-[100] space-y-2"></div>

    <script type="module">
        // --- CONFIGURAÇÃO CORRIGIDA: Apontando para o novo projeto kairos-agenda-us ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBmeKlOJ_kMshsuintO0j8CXOvM9ywBMnk",
            authDomain: "kairos-agenda-us.firebaseapp.com",
            projectId: "kairos-agenda-us",
            storageBucket: "kairos-agenda-us.firebasestorage.app",
            messagingSenderId: "407358446276",
            appId: "1:407358446276:web:c6229ea999b56701558791"
            // measurementId foi removido, não é essencial para auth.
        };

        const GRACE_PERIOD_DAYS = 5;
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        let idToken = null;
        let allEstablishments = [];
        let trashedEstablishments = [];
        let allPlans = [];
        let growthChartInstance = null;

        // Estado da Tabela (DataGrid)
        let tableState = {
            page: 1,
            limit: 10, 
            search: '',
            status: 'active',
            plan: 'all',
            dateRange: 'all',
            sortBy: 'createdAt',
            sortOrder: 'desc'
        };

        // --- CONFIGURAÇÃO DE MÓDULOS ATUALIZADA ---
        const additionalModulesDefinition = {
            'agenda': 'Agenda / Calendário',
            'comandas': 'Comandas / PDV',
            'relatorios': 'Relatórios (Analytics)',
            'sales-report': 'Relatório de Vendas', // Atualizado
            'financial': 'Financeiro',
            'servicos': 'Serviços',
            'produtos': 'Produtos',
            'suppliers': 'Fornecedores', // NOVO
            'profissionais': 'Profissionais',
            'ausencias': 'Ausências e Bloqueios', // NOVO
            'clientes': 'Clientes',
            'packages': 'Pacotes de Serviços', // NOVO
            'commissions': 'Comissões', // NOVO
            'estabelecimento': 'Configurações',
            'users': 'Usuários Internos',
            'mobileApp': 'Acesso App Mobile'
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                let userIsSuperAdmin = false;
                try {
                    const idTokenResult = await user.getIdTokenResult(true);
                    if (idTokenResult.claims.role === 'super-admin') {
                        userIsSuperAdmin = true;
                        idToken = await user.getIdToken();

                        setupSidebar();
                        setupNavigation();
                        setupEventListeners();
                        setupFilters();

                        document.getElementById('userDisplayEmail').textContent = user.email;
                        document.body.style.display = 'block'; // Exibe o corpo apenas após carregar
                        
                        await Promise.all([
                            loadPlatformLogo(),
                            loadPlans(),
                            loadDashboard(),
                            populatePlanFilter().then(() => loadEstablishments())
                        ]);
                    }
                    
                    if (!userIsSuperAdmin && (idTokenResult.claims.role === 'owner' || idTokenResult.claims.role === 'employee')) {
                        window.location.href = '/'; 
                        return;
                    }

                } catch (error) {
                    console.error("Auth error:", error);
                }

                if (!userIsSuperAdmin) {
                    await signOut(auth);
                    window.location.href = '/admin-login';
                    return;
                }
            } else {
                window.location.href = '/admin-login';
            }
        });

        function setupEventListeners() {
            const logoutButtons = document.querySelectorAll('#logoutButton, #logoutButtonFooter');
            logoutButtons.forEach(btn => btn.addEventListener('click', () => signOut(auth)));

            const establishmentForm = document.getElementById('establishmentForm');
            if (establishmentForm) establishmentForm.addEventListener('submit', handleFormSubmit);

            const planForm = document.getElementById('planForm');
            if (planForm) planForm.addEventListener('submit', handlePlanFormSubmit);

            const logoUploadForm = document.getElementById('logoUploadForm');
            if (logoUploadForm) logoUploadForm.addEventListener('submit', handleLogoUpload);
            
            // Nome do arquivo no input file
            const logoInput = document.getElementById('logoFileInput');
            if(logoInput) {
                logoInput.addEventListener('change', (e) => {
                    const fileName = e.target.files[0]?.name || "Nenhum arquivo selecionado";
                    document.getElementById('fileNameDisplay').textContent = fileName;
                });
            }
            
            // --- NOVO: ATUALIZAR MÓDULOS AO MUDAR PLANO ---
            const planSelect = document.getElementById('subscriptionPlan');
            if (planSelect) {
                planSelect.addEventListener('change', updateModuleCheckboxes);
            }
            // ------------------------------------------------

            setupLogoPreview();
            document.body.addEventListener('click', handlePageClick);
        }

        function setupSidebar() {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const mainContent = document.getElementById('main-content-wrapper');
            const header = document.getElementById('fixed-header');
            
            const updateSidebarState = (expanded) => {
                sidebar.classList.toggle('expanded', expanded);
                const marginLeft = expanded ? '17rem' : '5rem';
                const width = expanded ? 'calc(100% - 17rem)' : 'calc(100% - 5rem)';
                
                mainContent.style.marginLeft = marginLeft;
                mainContent.style.width = width;
                header.style.marginLeft = marginLeft;
                header.style.width = width;
            };

            sidebarToggle.addEventListener('click', (e) => {
                e.preventDefault();
                updateSidebarState(!sidebar.classList.contains('expanded'));
            });
        }

        function setupNavigation() {
            const navLinks = document.querySelectorAll('.sidebar-link');
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const href = link.getAttribute('href');

                    if (href.startsWith('#')) {
                        navLinks.forEach(l => l.classList.remove('active', 'bg-slate-800', 'text-white'));
                        link.classList.add('active', 'bg-slate-800', 'text-white');

                        const targetId = href.substring(1);
                        document.querySelectorAll('main > section').forEach(section => section.classList.add('hidden'));
                        
                        // Título da Página
                        const textEl = link.querySelector('.sidebar-text');
                        if(textEl) document.getElementById('pageTitle').textContent = textEl.textContent;

                        const targetSection = document.getElementById(targetId + '-section');
                        if (targetSection) targetSection.classList.remove('hidden');

                        if (targetId === 'dashboard') loadDashboard();
                        if (targetId === 'establishments') loadEstablishments();
                        if (targetId === 'trash') loadTrash();
                    } else {
                        window.location.href = href;
                    }
                });
            });
        }

        // ... (RESTO DO CÓDIGO JS É IGUAL AO ANTERIOR: apiCall, setupFilters, loadEstablishments, etc.) ...
        
        const API_BASE_URL = '';
        const getAuthHeaders = () => ({ 'Content-Type': 'application/json', 'Authorization': `Bearer ${idToken}` });

        async function apiCall(endpoint, options = {}) {
            const response = await fetch(`${API_BASE_URL}${endpoint}`, { headers: getAuthHeaders(), ...options });
            if (!response.ok) {
                const result = await response.json().catch(() => ({ message: response.statusText }));
                throw new Error(result.message || 'Ocorreu um erro.');
            }
            if (response.status === 204 || response.headers.get('content-length') === '0') return null;
            return response.json();
        }

        function setupFilters() {
            const searchInput = document.getElementById('filterSearch');
            const statusInput = document.getElementById('filterStatus');
            const planInput = document.getElementById('filterPlan');
            const clearBtn = document.getElementById('clearFiltersBtn');

            let debounceTimer;
            searchInput.addEventListener('input', (e) => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    tableState.search = e.target.value;
                    tableState.page = 1; 
                    loadEstablishments();
                }, 500);
            });

            [statusInput, planInput].forEach(input => {
                input.addEventListener('change', (e) => {
                    const key = input.id.replace('filter', '').toLowerCase();
                    tableState[key] = e.target.value;
                    tableState.page = 1;
                    loadEstablishments();
                });
            });

            clearBtn.addEventListener('click', () => {
                searchInput.value = '';
                statusInput.value = 'active';
                planInput.value = 'all';
                tableState = { ...tableState, search: '', status: 'active', plan: 'all', page: 1 };
                loadEstablishments();
            });

            document.querySelectorAll('th[data-sort]').forEach(th => {
                th.addEventListener('click', () => {
                    const sortKey = th.dataset.sort;
                    if (tableState.sortBy === sortKey) {
                        tableState.sortOrder = tableState.sortOrder === 'asc' ? 'desc' : 'asc';
                    } else {
                        tableState.sortBy = sortKey;
                        tableState.sortOrder = 'asc';
                    }
                    loadEstablishments();
                });
            });
        }

        function updateSortIcons() {
            document.querySelectorAll('th[data-sort]').forEach(th => {
                const icon = th.querySelector('.sort-icon');
                if (th.dataset.sort === tableState.sortBy) {
                    icon.textContent = tableState.sortOrder === 'asc' ? '↑' : '↓';
                    icon.classList.add('text-indigo-600');
                } else {
                    icon.textContent = '↕';
                    icon.classList.remove('text-indigo-600');
                }
            });
        }

        async function populatePlanFilter() {
            if (allPlans.length === 0) await loadPlans();
            const select = document.getElementById('filterPlan');
            select.innerHTML = '<option value="all">Todos</option>' + 
                allPlans.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
        }

        async function loadEstablishments() {
            const listDiv = document.getElementById('establishmentsList');
            if (!listDiv) return;

            listDiv.innerHTML = `
                <tr><td colspan="6" class="p-4">
                    <div class="animate-pulse flex space-x-4"><div class="flex-1 space-y-4 py-1"><div class="h-4 bg-slate-200 rounded w-3/4"></div><div class="space-y-2"><div class="h-4 bg-slate-200 rounded"></div></div></div></div>
                </td></tr>
            `;

            try {
                const params = new URLSearchParams({
                    page: tableState.page,
                    limit: tableState.limit,
                    search: tableState.search,
                    status: tableState.status,
                    plan: tableState.plan,
                    sortBy: tableState.sortBy,
                    sortOrder: tableState.sortOrder
                });

                const response = await apiCall(`/api/admin/establishments?${params.toString()}`);
                const { data, pagination } = response;

                allEstablishments = data; 
                renderEstablishmentsTable(data);
                renderPagination(pagination);
                updateSortIcons();

            } catch (error) {
                listDiv.innerHTML = '<tr><td colspan="6" class="text-center p-4 text-red-500">Erro ao carregar dados.</td></tr>';
                console.error(error);
            }
        }

        function renderEstablishmentsTable(establishments) {
            const listDiv = document.getElementById('establishmentsList');
            
            if (!establishments || establishments.length === 0) {
                listDiv.innerHTML = `<tr><td colspan="6" class="text-center p-8 text-slate-500">Nenhum registro encontrado.</td></tr>`;
                return;
            }

            listDiv.innerHTML = establishments.map(est => {
                const isActive = est.status === 'active';
                const planName = allPlans.find(p => p.id === est.subscription?.planId)?.name || 'N/A';
                
                const expiryDateRaw = est.subscription?.expiryDate;
                let expiryDate = 'N/A';
                let subStatus = 'N/A';
                let subStatusClass = 'bg-slate-100 text-slate-800';

                if (expiryDateRaw) {
                    const d = new Date(expiryDateRaw._seconds ? expiryDateRaw._seconds * 1000 : expiryDateRaw);
                    expiryDate = d.toLocaleDateString('pt-BR');
                    
                    const today = new Date();
                    const gracePeriodEnd = new Date(d);
                    gracePeriodEnd.setDate(gracePeriodEnd.getDate() + GRACE_PERIOD_DAYS);

                    if (today > gracePeriodEnd) {
                        subStatus = 'VENCIDO';
                        subStatusClass = 'bg-red-100 text-red-800';
                    } else if (today > d) {
                        subStatus = 'CARÊNCIA';
                        subStatusClass = 'bg-amber-100 text-amber-800';
                    } else {
                        subStatus = 'EM DIA';
                        subStatusClass = 'bg-emerald-100 text-emerald-800';
                    }
                }

                return `
                    <tr class="hover:bg-slate-50 transition-colors border-b border-slate-100 last:border-0">
                        <td class="px-6 py-4 cursor-pointer" data-action="edit-establishment" data-id="${est.id}">
                            <div class="text-sm font-medium text-slate-900">${est.name}</div>
                            <div class="text-xs text-slate-500 font-mono bg-slate-100 px-1.5 py-0.5 rounded inline-block mt-1">${est.urlId || est.id}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">
                            <span class="px-2.5 py-0.5 bg-indigo-50 text-indigo-700 rounded-full text-xs font-bold border border-indigo-100">${planName}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${expiryDate}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2.5 py-0.5 text-xs font-bold rounded-full border border-opacity-20 ${subStatusClass}">${subStatus}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right">
                            <label class="relative inline-flex items-center cursor-pointer" data-action="toggle-status" data-id="${est.id}">
                                <input type="checkbox" class="sr-only peer" ${isActive ? 'checked' : ''}>
                                <div class="w-9 h-5 bg-slate-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-indigo-600"></div>
                            </label>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium flex justify-end gap-2 items-center h-full">
                            <button data-action="impersonate-establishment" data-id="${est.id}" title="Aceder Painel" class="p-1.5 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" /></svg>
                            </button>
                            <button data-action="edit-establishment" data-id="${est.id}" title="Editar" class="p-1.5 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                            </button>
                            <button data-action="delete-establishment" data-id="${est.id}" title="Lixeira" class="p-1.5 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m-7-10V4a1 1 0 00-1-1h-2a1 1 0 00-1 1v3M4 7h16" /></svg>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderPagination(pagination) {
            if(!pagination) return;
            const { total, page, limit, totalPages } = pagination;
            
            document.getElementById('totalItems').textContent = total;
            document.getElementById('pageStart').textContent = total === 0 ? 0 : ((page - 1) * limit) + 1;
            document.getElementById('pageEnd').textContent = Math.min(page * limit, total);

            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');

            prevBtn.disabled = page <= 1;
            nextBtn.disabled = page >= totalPages;
            
            prevBtn.classList.toggle('opacity-50', page <= 1);
            nextBtn.classList.toggle('opacity-50', page >= totalPages);
            prevBtn.classList.toggle('cursor-not-allowed', page <= 1);
            nextBtn.classList.toggle('cursor-not-allowed', page >= totalPages);

            const newPrev = prevBtn.cloneNode(true);
            const newNext = nextBtn.cloneNode(true);
            prevBtn.parentNode.replaceChild(newPrev, prevBtn);
            nextBtn.parentNode.replaceChild(newNext, nextBtn);

            newPrev.addEventListener('click', () => {
                if (tableState.page > 1) {
                    tableState.page--;
                    loadEstablishments();
                }
            });

            newNext.addEventListener('click', () => {
                if (tableState.page < totalPages) {
                    tableState.page++;
                    loadEstablishments();
                }
            });
        }

        // --- DASHBOARD FUNCTIONS ---
        async function loadDashboard() {
            try {
                const data = await apiCall('/api/admin/dashboard-stats');
                
                document.getElementById('kpi-mrr').textContent = `R$ ${data.kpis.mrr.toFixed(2).replace('.', ',')}`;
                document.getElementById('kpi-active').textContent = data.kpis.activeUsers;
                document.getElementById('kpi-churn').textContent = `${data.kpis.churnRate}%`;
                document.getElementById('kpi-attention').textContent = data.attentionList.length;

                const attentionTable = document.getElementById('attentionListTable');
                if(data.attentionList.length > 0) {
                    attentionTable.innerHTML = data.attentionList.map(item => `
                        <tr class="hover:bg-slate-50 border-b border-slate-100 last:border-0 transition-colors">
                            <td class="p-3">
                                <div class="font-medium text-slate-800">${item.name}</div>
                                <div class="text-xs text-slate-400 font-mono">${item.id}</div>
                            </td>
                            <td class="p-3 text-right">
                                <span class="px-2 py-1 text-xs font-bold rounded-full ${item.daysLeft < 0 ? 'bg-red-100 text-red-700' : 'bg-amber-100 text-amber-700'}">
                                    ${item.daysLeft < 0 ? 'Vencido' : `${item.daysLeft} dias`}
                                </span>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    attentionTable.innerHTML = '<tr><td colspan="2" class="p-6 text-center text-slate-400 text-sm italic">Nenhuma renovação urgente pendente.</td></tr>';
                }

                renderGrowthChart(data.kpis.newSubscribersData);

            } catch (error) {
                console.error("Erro ao carregar dashboard:", error);
            }
        }

        function renderGrowthChart(dataArray) {
            const ctx = document.getElementById('growthChart').getContext('2d');
            const labels = [];
            for (let i = 29; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                labels.push(d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' }));
            }

            if (growthChartInstance) {
                growthChartInstance.destroy();
            }

            growthChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Novos Assinantes',
                        data: dataArray,
                        borderColor: '#4f46e5', // indigo-600
                        backgroundColor: (context) => {
                            const bg = context.chart.ctx.createLinearGradient(0, 0, 0, 300);
                            bg.addColorStop(0, 'rgba(79, 70, 229, 0.2)');
                            bg.addColorStop(1, 'rgba(79, 70, 229, 0.0)');
                            return bg;
                        },
                        borderWidth: 2,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } },
                    scales: {
                        y: { beginAtZero: true, ticks: { stepSize: 1 }, grid: { borderDash: [4, 4], color: '#e2e8f0' } },
                        x: { grid: { display: false }, ticks: { maxTicksLimit: 5 } }
                    },
                    interaction: { mode: 'nearest', axis: 'x', intersect: false }
                }
            });
        }

        function updateModuleCheckboxes() {
            const planId = document.getElementById('subscriptionPlan').value;
            const selectedPlan = allPlans.find(p => p.id === planId);
            const modulesContainer = document.getElementById('modulesContainer');
            const establishmentModules = JSON.parse(modulesContainer.dataset.modules || '{}');

            modulesContainer.innerHTML = '';

            Object.entries(additionalModulesDefinition).forEach(([key, label]) => {
                const isFromPlan = selectedPlan?.allowedModules?.[key] === true;
                const isManuallyAdded = establishmentModules?.[key] === true;
                const isChecked = isFromPlan || isManuallyAdded;
                const isDisabled = isFromPlan; // Se vem do plano, não pode desmarcar

                const moduleHtml = `
                    <label for="module-${key}" class="flex items-center p-2 rounded-lg border ${isFromPlan ? 'bg-indigo-50 border-indigo-100' : 'bg-white border-slate-200 hover:border-indigo-300'} cursor-pointer transition-colors">
                        <div class="relative flex items-center">
                            <input type="checkbox" id="module-${key}" name="modules" value="${key}" class="sr-only" ${isChecked ? 'checked' : ''} ${isDisabled ? 'disabled' : ''}>
                            <div class="toggle-bg block bg-slate-200 w-9 h-5 rounded-full"></div>
                            <div class="dot absolute left-1 top-1 bg-white w-3 h-3 rounded-full transition"></div>
                        </div>
                        <span class="ml-3 text-sm font-medium ${isFromPlan ? 'text-indigo-700' : 'text-slate-600'}">${label}</span>
                        ${isFromPlan ? '<span class="ml-auto text-[10px] font-bold text-indigo-400 uppercase">Plano</span>' : ''}
                    </label>
                `;
                modulesContainer.innerHTML += moduleHtml;
            });
        }

        // --- SLIDE OVER LOGIC ---
        async function openModal(establishment = null) {
            const form = document.getElementById('establishmentForm');
            form.reset();
            const isEditing = !!establishment;

            const modulesContainer = document.getElementById('modulesContainer');
            modulesContainer.dataset.modules = JSON.stringify(establishment?.modules || {});

            document.getElementById('access-links-container').classList.toggle('hidden', !isEditing);
            if (isEditing) {
                const linkId = establishment.urlId || establishment.id;
                const schedulingLink = `${window.location.origin}/agendar?id=${linkId}`;
                const adminLink = `${window.location.origin}/login`;
                document.getElementById('schedulingLink').value = schedulingLink;
                document.getElementById('adminLink').value = adminLink;
            }

            document.getElementById('slideOverTitle').textContent = isEditing ? "Editar Cliente" : "Novo Cliente";
            document.getElementById('editEstablishmentId').value = establishment?.id || '';
            document.getElementById('establishmentName').value = establishment?.name || '';
            
            const displayId = establishment?.urlId || establishment?.id || '';
            document.getElementById('establishmentId').value = displayId;
            document.getElementById('establishmentId').disabled = false;

            const ownerEmailInput = document.getElementById('ownerEmail');
            const ownerPasswordInput = document.getElementById('ownerPassword');
            const credentialsContainer = document.getElementById('owner-credentials-container');

            ownerEmailInput.value = establishment?.ownerEmail || '';
            
            // Se estiver editando, esconde a senha (só mostra campos vazios se quiser alterar, mas aqui simplificamos para bloquear)
            if (isEditing) {
                credentialsContainer.style.display = 'none'; // Oculta credenciais na edição por segurança
                ownerEmailInput.removeAttribute('required');
                ownerPasswordInput.removeAttribute('required');
            } else {
                credentialsContainer.style.display = 'block';
                ownerEmailInput.setAttribute('required', 'required');
                ownerPasswordInput.setAttribute('required', 'required');
                ownerEmailInput.disabled = false;
            }

            const planSelect = document.getElementById('subscriptionPlan');
            planSelect.innerHTML = allPlans.map(plan => `<option value="${plan.id}">${plan.name}</option>`).join('');
            if (establishment?.subscription?.planId) {
                planSelect.value = establishment.subscription.planId;
            } else if (allPlans.length > 0) {
                 planSelect.value = allPlans[0].id;
            }

            updateModuleCheckboxes();

            // Animação de Entrada
            const wrapper = document.getElementById('establishmentSlideOver');
            const backdrop = document.getElementById('slideOverBackdrop');
            const panel = document.getElementById('slideOverPanel');

            wrapper.classList.remove('hidden');
            setTimeout(() => {
                backdrop.classList.remove('opacity-0');
                panel.classList.remove('translate-x-full');
                panel.classList.add('translate-x-0');
            }, 10);
        }

        function closeModal() {
            const wrapper = document.getElementById('establishmentSlideOver');
            const backdrop = document.getElementById('slideOverBackdrop');
            const panel = document.getElementById('slideOverPanel');

            backdrop.classList.add('opacity-0');
            panel.classList.remove('translate-x-0');
            panel.classList.add('translate-x-full');

            setTimeout(() => {
                wrapper.classList.add('hidden');
            }, 500);
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            const editId = document.getElementById('editEstablishmentId').value;
            const isEditing = !!editId;
            const inputIdValue = document.getElementById('establishmentId').value;

            const modules = {};
            document.querySelectorAll('input[name="modules"]').forEach(checkbox => {
                modules[checkbox.value] = checkbox.checked;
            });

            const data = {
                establishmentId: inputIdValue, 
                name: document.getElementById('establishmentName').value,
                ownerEmail: document.getElementById('ownerEmail').value,
                modules: modules
            };

            if (!isEditing) {
                data.ownerPassword = document.getElementById('ownerPassword').value;
            }

            const planId = document.getElementById('subscriptionPlan').value;
            const expiryDate = document.getElementById('subscriptionExpiry').value;
            if (planId && expiryDate) {
                 data.subscription = { planId, expiryDate };
            }

            try {
                if (isEditing) {
                    await apiCall(`/api/admin/establishments/${editId}/modules`, { method: 'PATCH', body: JSON.stringify({ modules: data.modules }) });
                    
                    await apiCall(`/api/admin/establishments/${editId}/details`, { 
                        method: 'PUT', 
                        body: JSON.stringify({ 
                            name: data.name, 
                            urlId: inputIdValue 
                        }) 
                    });

                    if (planId && expiryDate) {
                         await apiCall(`/api/subscriptions/assign/${editId}`, { method: 'PATCH', body: JSON.stringify({ planId, expiryDate }) });
                    }

                    showToast('Cliente atualizado com sucesso!', 'success');
                } else {
                    await apiCall('/api/admin/establishments', { method: 'POST', body: JSON.stringify(data) });
                    showToast('Cliente criado com sucesso!', 'success');
                }
                closeModal();
                loadEstablishments();
                loadDashboard(); 
            } catch (error) {
                showToast(`Erro: ${error.message}`, 'error');
            }
        }

        // --- Trash & Plans & Outros (Mantidos Simples) ---
        async function loadTrash() {
            const trashList = document.getElementById('trashList');
            if (!trashList) return;
            trashList.innerHTML = '<tr><td colspan="3" class="p-6 text-center"><div class="loader mx-auto"></div></td></tr>';
            try {
                trashedEstablishments = await apiCall('/api/admin/establishments?includeDeleted=true');
                renderTrashTable();
            } catch (error) {
                trashList.innerHTML = '<tr><td colspan="3" class="p-6 text-center text-red-500">Erro ao carregar lixeira.</td></tr>';
            }
        }

        function renderTrashTable() {
            const trashList = document.getElementById('trashList');
            if (trashedEstablishments.length > 0) {
                trashList.innerHTML = trashedEstablishments.map(est => {
                    const deletedDate = est.deletedAt ? new Date(est.deletedAt._seconds * 1000).toLocaleDateString('pt-BR') : 'N/A';
                    return `
                        <tr class="hover:bg-slate-50 border-b border-slate-100 last:border-0">
                            <td class="px-6 py-4 text-sm text-slate-900 font-medium">${est.name}</td>
                            <td class="px-6 py-4 text-sm text-slate-600">${deletedDate}</td>
                            <td class="px-6 py-4 text-right">
                                <button data-action="restore-establishment" data-id="${est.id}" class="text-emerald-600 hover:text-emerald-800 text-sm font-bold transition-colors">Restaurar</button>
                            </td>
                        </tr>
                    `;
                }).join('');
            } else {
                trashList.innerHTML = `<tr><td colspan="3" class="p-8 text-center text-slate-400 text-sm italic">A lixeira está vazia.</td></tr>`;
            }
        }

        async function loadPlans() {
            const listDiv = document.getElementById('plansList');
            if (!listDiv) return;
            try {
                allPlans = await apiCall('/api/subscriptions/plans');
                renderPlansTable();
            } catch (error) {
                 listDiv.innerHTML = '<div class="p-6 text-center text-red-500">Erro ao carregar planos.</div>';
            }
        }

        function renderPlansTable() {
            const listDiv = document.getElementById('plansList');
            let tableHTML = `<div class="overflow-x-auto"><table class="w-full text-sm text-left text-slate-500">
                <thead class="text-xs text-slate-700 uppercase bg-slate-50"><tr>
                    <th class="px-6 py-3 font-bold">Nome</th>
                    <th class="px-6 py-3 font-bold">Preço</th>
                    <th class="px-6 py-3 font-bold">Limites (Prof/User)</th>
                    <th class="px-6 py-3 font-bold">Ações</th>
                </tr></thead><tbody class="divide-y divide-slate-100">`;

            if (allPlans.length > 0) {
                allPlans.forEach(plan => {
                    tableHTML += `
                        <tr class="bg-white hover:bg-slate-50 transition-colors">
                            <td class="px-6 py-4 font-bold text-slate-900">${plan.name}</td>
                            <td class="px-6 py-4 text-slate-600">R$ ${plan.price.toFixed(2)}</td>
                            <td class="px-6 py-4 text-slate-600">${plan.maxProfessionals} / ${plan.maxUsers}</td>
                            <td class="px-6 py-4 flex gap-3">
                                <button data-action="edit-plan" data-id="${plan.id}" class="font-medium text-indigo-600 hover:text-indigo-800">Editar</button>
                                <button data-action="delete-plan" data-id="${plan.id}" class="font-medium text-red-600 hover:text-red-800">Excluir</button>
                            </td>
                        </tr>`;
                });
            } else {
                tableHTML += `<tr><td colspan="4" class="p-6 text-center text-slate-400 italic">Nenhum plano cadastrado.</td></tr>`;
            }
            tableHTML += '</tbody></table></div>';
            listDiv.innerHTML = tableHTML;
        }

        function openPlanModal(plan = null) {
            const form = document.getElementById('planForm');
            form.reset();
            const isEditing = !!plan;
            document.getElementById('planModalTitle').textContent = isEditing ? "Editar Plano" : "Novo Plano";
            document.getElementById('editPlanId').value = plan?.id || '';
            document.getElementById('planName').value = plan?.name || '';
            document.getElementById('planPrice').value = plan?.price || '';
            document.getElementById('planMaxProfessionals').value = plan?.maxProfessionals || '';
            document.getElementById('planMaxUsers').value = plan?.maxUsers || '';

            const modulesContainer = document.getElementById('planModulesContainer');
            modulesContainer.innerHTML = Object.entries(additionalModulesDefinition).map(([key, label]) => `
                <label for="plan-module-${key}" class="flex items-center p-2 rounded border border-slate-200 hover:border-indigo-300 cursor-pointer transition-colors">
                    <input type="checkbox" id="plan-module-${key}" name="plan-modules" value="${key}" class="rounded text-indigo-600 focus:ring-indigo-500 mr-2" ${plan?.allowedModules?.[key] ? 'checked' : ''}>
                    <span class="text-xs font-medium text-slate-700">${label}</span>
                </label>
            `).join('');

            const planModal = document.getElementById('planModal');
            planModal.classList.add('flex');
            setTimeout(() => planModal.style.opacity = "1", 10);
        }

        function closePlanModal() {
            const planModal = document.getElementById('planModal');
            planModal.style.opacity = "0";
            setTimeout(() => planModal.classList.remove('flex'), 300);
        }

        async function handlePlanFormSubmit(e) {
            e.preventDefault();
            const editPlanId = document.getElementById('editPlanId').value;
            const isEditing = !!editPlanId;

            const allowedModules = {};
            document.querySelectorAll('input[name="plan-modules"]').forEach(checkbox => { allowedModules[checkbox.value] = checkbox.checked; });

            const data = {
                name: document.getElementById('planName').value,
                price: parseFloat(document.getElementById('planPrice').value),
                maxProfessionals: parseInt(document.getElementById('planMaxProfessionals').value),
                maxUsers: parseInt(document.getElementById('planMaxUsers').value),
                allowedModules
            };

            try {
                if (isEditing) {
                    await apiCall(`/api/subscriptions/plans/${editPlanId}`, { method: 'PUT', body: JSON.stringify(data) });
                    showToast('Plano atualizado!', 'success');
                } else {
                    await apiCall('/api/subscriptions/plans', { method: 'POST', body: JSON.stringify(data) });
                    showToast('Plano criado!', 'success');
                }
                closePlanModal();
                loadPlans();
            } catch (error) {
                showToast(`Erro: ${error.message}`, 'error');
            }
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const colors = { success: 'bg-emerald-500', error: 'bg-rose-500', info: 'bg-blue-500' };
            toast.className = `px-4 py-3 text-white font-medium text-sm rounded-lg shadow-lg ${colors[type]} animate-fade-in-out flex items-center gap-2`;
            toast.innerHTML = `<span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        async function handleLogoUpload(e) {
            e.preventDefault();
            const fileInput = document.getElementById('logoFileInput');
            const button = document.getElementById('logoUploadButton');
            const statusEl = document.getElementById('logoUploadStatus');
            const file = fileInput.files[0];
            if (!file) return;
            
            button.disabled = true; button.textContent = 'Enviando...';
            statusEl.textContent = 'Processando...'; statusEl.className = 'text-sm mt-2 text-slate-500';

            try {
                const token = await auth.currentUser.getIdToken();
                const formData = new FormData();
                formData.append('logoFile', file);
                const response = await fetch(`${API_BASE_URL}/api/admin/config/logo`, {
                    method: 'POST', headers: { 'Authorization': `Bearer ${token}` }, body: formData
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.message || 'Erro');
                
                statusEl.textContent = 'Sucesso!'; statusEl.className = 'text-sm mt-2 text-emerald-600';
                const logoUrl = data.logoUrl + `?t=${new Date().getTime()}`;
                document.getElementById('logoUploadPreview').src = logoUrl;
                document.getElementById('platformLogoDisplay').src = logoUrl; 
                document.getElementById('platformLogoDisplay').classList.remove('hidden');
            } catch (error) {
                statusEl.textContent = 'Falha no upload.'; statusEl.className = 'text-sm mt-2 text-rose-600';
            } finally {
                button.disabled = false; button.textContent = 'Salvar';
            }
        }

        function setupLogoPreview() {
            const fileInput = document.getElementById('logoFileInput');
            const previewEl = document.getElementById('logoUploadPreview');
            if(!fileInput) return;
            fileInput.addEventListener('change', () => {
                const file = fileInput.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => { previewEl.src = e.target.result; previewEl.classList.remove('hidden'); };
                    reader.readAsDataURL(file);
                }
            });
        }

        async function loadPlatformLogo() {
            try {
                const response = await apiCall('/api/admin/config', { method: 'GET' });
                if (response && response.logoUrl) {
                    const platformLogo = document.getElementById('platformLogoDisplay');
                    platformLogo.src = response.logoUrl; platformLogo.classList.remove('hidden');
                }
            } catch (error) { console.warn('Logo load error', error); }
        }

        async function handlePageClick(e) {
            const target = e.target.closest('[data-action]');
            if (!target) return;
            e.stopPropagation();
            const action = target.dataset.action;
            const id = target.dataset.id;

            switch(action) {
                case 'open-create-modal': openModal(); break;
                case 'close-modal': closeModal(); break;
                case 'open-plan-modal': openPlanModal(); break;
                case 'close-plan-modal': closePlanModal(); break;
                case 'edit-establishment': {
                    const establishment = allEstablishments.find(est => est.id === id);
                    if (establishment) openModal(establishment);
                    break;
                }
                case 'delete-establishment': {
                    if(confirm("Mover para lixeira?")) {
                        await apiCall(`/api/admin/establishments/${id}`, { method: 'DELETE' });
                        showToast("Movido para lixeira.", "success");
                        loadEstablishments(); loadDashboard();
                    }
                    break;
                }
                case 'restore-establishment': {
                    await apiCall(`/api/admin/establishments/${id}/restore`, { method: 'POST' });
                    showToast("Restaurado!", "success");
                    loadTrash(); loadEstablishments();
                    break;
                }
                case 'impersonate-establishment': {
                    if (confirm('Acessar painel deste cliente?')) {
                        const response = await apiCall(`/api/admin/establishments/${id}/impersonate`, { method: 'POST' });
                        if (response?.token) {
                            await signInWithCustomToken(auth, response.token);
                            window.location.href = '/';
                        }
                    }
                    break;
                }
                case 'copy-link': {
                    const input = document.getElementById(target.dataset.target);
                    input.select(); document.execCommand('copy');
                    showToast("Link copiado!", "info");
                    break;
                }
                case 'edit-plan': {
                    const plan = allPlans.find(p => p.id === id);
                    if(plan) openPlanModal(plan);
                    break;
                }
                case 'delete-plan': {
                    if(confirm("Excluir plano?")) {
                        await apiCall(`/api/subscriptions/plans/${id}`, { method: 'DELETE' });
                        showToast("Plano excluído.", "success");
                        loadPlans();
                    }
                    break;
                }
            }
        }
    </script>
</body>
</html>