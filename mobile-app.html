<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App de Gestão</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        window.initializeApp = initializeApp;
    </script>
    <script type="module">
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        window.getAuth = getAuth;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.onAuthStateChanged = onAuthStateChanged;
        window.signOut = signOut;
    </script>
    <script type="module">
        import { getFirestore, collection, query, where, onSnapshot, orderBy, Timestamp, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        window.getFirestore = getFirestore;
        window.collection = collection;
        window.query = query;
        window.where = where;
        window.onSnapshot = onSnapshot;
        window.orderBy = orderBy;
        window.Timestamp = Timestamp;
        window.doc = doc;
        window.getDoc = getDoc;
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        .toggle-bg:after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            background: white;
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 9999px;
            transition: transform 0.2s ease-in-out;
        }
        input:checked + .toggle-bg:after {
            transform: translateX(100%);
        }
        input:checked + .toggle-bg {
            background-color: #4f46e5;
        }
        .modal-enter {
            opacity: 0;
        }
        .modal-enter-active {
            opacity: 1;
            transition: opacity 200ms ease-in-out;
        }
        .modal-content-enter {
            transform: scale(0.95) translateY(10px);
        }
        .modal-content-enter-active {
            transform: scale(1) translateY(0);
            transition: transform 200ms ease-in-out;
        }
        .day-schedule-card.disabled .time-inputs {
            opacity: 0.5;
            pointer-events: none;
        }
        /* Estilos adicionais para a agenda semanal */
        .agenda-week-view {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* Alterado para 3 colunas */
            gap: 0.5rem;
        }
        .day-column {
            background-color: #fff;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .day-header {
            text-align: center;
            padding: 0.5rem;
            background-color: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
        }
        .day-header.current-day {
            background-color: #eef2ff;
        }
        .day-content {
            flex-grow: 1;
            padding: 0.5rem;
            overflow-y: auto;
            max-height: 50vh; /* Ajuste conforme necessário */
        }
        .view-btn {
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
            border: none;
            background-color: transparent;
            color: #4b5563;
            cursor: pointer;
        }
        .view-btn.active {
            background-color: white;
            color: #111827;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.06);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- INÍCIO DA APLICAÇÃO REACT ---

        const { useState, useEffect, useCallback, useRef } = React;
        const { Chart: ChartJS, CategoryScale, LinearScale, BarElement, Title, Tooltip, Legend } = window.Chart;

        ChartJS.register(CategoryScale, LinearScale, BarElement, Title, Tooltip, Legend);

        // --- 1. CONFIGURAÇÃO E SERVIÇOS GLOBAIS ---

        const firebaseConfig = {
            apiKey: "AIzaSyAlJaPEW5-yOb-8wkB8EJZhAML2M2yI8Ao",
            authDomain: "kairos-system.firebaseapp.com",
            projectId: "kairos-system",
            storageBucket: "kairos-system.appspot.com",
            messagingSenderId: "603994960586",
            appId: "1:603994960586:web:30d2c030eed3c55eccfa33",
            measurementId: "G-SVHFXKV5EC"
        };

        const app = window.initializeApp(firebaseConfig);
        const auth = window.getAuth(app);
        const db = window.getFirestore(app);

        const API_BASE_URL = window.location.origin;

        async function authenticatedFetch(endpoint, options = {}, user) {
            if (!user || !user.token) {
                await window.signOut(auth);
                throw new Error("Utilizador não autenticado.");
            }

            const headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${user.token}` };
            const response = await fetch(`${API_BASE_URL}${endpoint}`, { ...options, headers: { ...headers, ...options.headers } });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ message: response.statusText }));
                throw new Error(errorData.message || `Erro na API: ${response.status}`);
            }
            
            if (response.status === 204 || (response.status === 200 && response.headers.get('content-length') === '0')) {
                return null;
            }
            return response.json();
        }

        const icons = {
            agenda: (c) => (<svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke={c} strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>),
            comandas: (c) => (<svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke={c} strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>),
            relatorios: (c) => (<svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke={c} strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>),
            gestao: (c) => (<svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke={c} strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.096 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>),
            plus: (c) => (<svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke={c} strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" /></svg>),
            dots: (c = 'currentColor') => (<svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke={c} strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M5 12h.01M12 12h.01M19 12h.01M5 12a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0z" /></svg>),
            back: (c = 'currentColor') => (<svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke={c} strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>),
            edit: (c = 'currentColor') => (<svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill={c}><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fillRule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clipRule="evenodd" /></svg>),
            trash: (c = 'currentColor') => (<svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill={c}><path fillRule="evenodd" d="M9 2a1 1 0 00-1-1h2a1 1 0 001 1v1h3.5a1 1 0 011 1v1a1 1 0 01-1-1H2.5a1 1 0 01-1-1v-1a1 1 0 011-1H6V2zM10 5H3.25l-.25 13.5A2.75 2.75 0 005.75 21h8.5A2.75 2.75 0 0017 18.5V5H10zm1.5 5.25a.75.75 0 00-1.5 0v5a.75.75 0 001.5 0v-5zm3.25-.75a.75.75 0 011.5 0v5a.75.75 0 01-1.5 0v-5zM6 10a.75.75 0 011.5 0v5a.75.75 0 01-1.5 0v-5z" clipRule="evenodd" /></svg>),
            photo: (c = 'currentColor') => (<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill={c} className="h-5 w-5"><path fillRule="evenodd" d="M1 9.5A1.5 1.5 0 012.5 8h15a1.5 1.5 0 011.5 1.5v6a1.5 1.5 0 01-1.5 1.5h-15A1.5 1.5 0 011 15.5v-6zM3.5 10a.5.5 0 00-.5.5v2a.5.5 0 00.5.5h13a.5.5 0 00.5-.5v-2a.5.5 0 00-.5-.5h-13z" clipRule="evenodd" /><path d="M16.5 13.5a1 1 0 11-2 0 1 1 0 012 0zM17 17a1 1 0 100-2 1 1 0 000 2zM3 13a1 1 0 100-2 1 1 0 000 2zM3 17a1 1 0 100-2 1 1 0 000 2z" /></svg>),
            absent: (c = 'currentColor') => (<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke={c} className="h-5 w-5"><path strokeLinecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>),
            batchDelete: (c = 'currentColor') => (<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke={c} className="h-5 w-5"><path strokeLinecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.757 6.75m11.129-3.21l-.317-.995a.992.992 0 00-.895-.695H11.5a.992.992 0 00-.895.695l-.317.995M15 9V7m0-2v2m1-2v2m-3 4V7m0-2v2m-4 4V7m0-2v2" /></svg>),
            establishment: (c) => (<svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke={c} strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg>),
            whatsapp: (c = '#25D366') => (<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill={c} className="w-5 h-5"><path d="M12.036 2a10 10 0 100 20 10 10 0 000-20zM17.5 14.8c-.24.125-1.465.716-1.696.804-.23.09-.49.135-.75.045-.26-.09-.982-.322-1.87-.965-.888-.643-1.474-1.442-1.64-1.748-.166-.307-.015-.467.106-.615.116-.149.23-.388.344-.582.113-.193.15-.327.1-.462-.05-.136-.264-.322-.544-.654-.28-.332-.572-.782-.828-.958-.255-.176-.438-.158-.61-.158-.173 0-.374-.022-.574-.022-.2 0-.54.075-.826.375-.285.3-.99.965-.99 2.355 0 1.43 1.018 2.872 1.16 3.072.14.2 2 3.047 4.86 4.218 2.86 1.17 2.86.786 3.376 1.054.516.268 1.49.462 1.696.406.206-.057 1.463-.615 1.67-.887.2-.27.2-.504.14-.615-.058-.11-.23-.166-.48-.306z"/></svg>),
        };

        // --- 2. COMPONENTES REUTILIZÁVEIS ---

        const LoadingScreen = () => (
            <div className="h-screen w-full flex flex-col items-center justify-center bg-gray-900">
                <div className="text-2xl font-bold text-white mb-4">Kairos App</div>
                <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-white"></div>
            </div>
        );

        const NotificationModal = ({ isOpen, onClose, title, message }) => {
            if (!isOpen) return null;
            return (
                <div className="modal-enter fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onClick={onClose}>
                    <div className="modal-content-enter bg-white rounded-lg shadow-xl w-full max-w-sm m-4 p-6 text-center" onClick={e => e.stopPropagation()}>
                        <h3 className="text-xl font-bold text-gray-800">{title}</h3>
                        <p className="text-gray-600 my-4">{message}</p>
                        <button onClick={onClose} className="w-full py-2 px-4 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700">OK</button>
                    </div>
                </div>
            );
        };
        
        const AppointmentModal = ({ isOpen, onClose, onSave, appointmentToEdit, user, showNotification }) => {
            if (!isOpen) return null;

            const [clientName, setClientName] = useState(appointmentToEdit?.clientName || '');
            const [clientPhone, setClientPhone] = useState(appointmentToEdit?.clientPhone || '');
            const [selectedServices, setSelectedServices] = useState(appointmentToEdit?.services?.map(s => s.id) || []);
            const [professionalId, setProfessionalId] = useState(appointmentToEdit?.professionalId || user.professionalId || '');
            const [date, setDate] = useState(appointmentToEdit ? new Date(appointmentToEdit.startTime).toISOString().split('T')[0] : new Date().toISOString().split('T')[0]);
            const [time, setTime] = useState(appointmentToEdit ? new Date(appointmentToEdit.startTime).toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'}) : '');

            const [availableServices, setAvailableServices] = useState([]);
            const [availableProfessionals, setAvailableProfessionals] = useState([]);
            const [availableTimes, setAvailableTimes] = useState([]);
            const [isLoadingData, setIsLoadingData] = useState(true);

            const [isSaving, setIsSaving] = useState(false);
            const isFormValid = clientName && clientPhone && selectedServices.length > 0 && professionalId && time;
            const isEditing = !!appointmentToEdit;
            const isEmployee = user.role === 'employee';

            useEffect(() => {
                const fetchData = async () => {
                    setIsLoadingData(true);
                    try {
                        const [servicesData, professionalsData] = await Promise.all([
                            authenticatedFetch(`/api/services/public/${user.establishmentId}`, {}, user),
                            authenticatedFetch(`/api/professionals/${user.establishmentId}`, {}, user)
                        ]);
                        setAvailableServices(servicesData);
                        setAvailableProfessionals(professionalsData.filter(p => !isEmployee || p.id === user.professionalId));
                    } catch (error) {
                        showNotification('Erro', 'Não foi possível carregar os dados necessários.');
                    } finally {
                        setIsLoadingData(false);
                    }
                };
                fetchData();
            }, [user, showNotification, isEmployee]);

            useEffect(() => {
                const fetchAvailability = async () => {
                    if (selectedServices.length > 0 && professionalId && date) {
                        setAvailableTimes([]);
                        try {
                            const endpoint = `/api/availability?establishmentId=${user.establishmentId}&professionalId=${professionalId}&serviceIds=${selectedServices.join(',')}&date=${date}`;
                            const times = await authenticatedFetch(endpoint, {}, user);
                            setAvailableTimes(times);
                        } catch(error) {
                            showNotification("Erro", "Não foi possível buscar horários disponíveis.");
                        }
                    }
                };
                fetchAvailability();
            }, [selectedServices, professionalId, date, user, showNotification]);

            const handleSubmit = async () => {
                if (!isFormValid) return;
                setIsSaving(true);

                const servicesDataForSave = availableServices.filter(s => selectedServices.includes(s.id)).map(service => ({
                    id: service.id, name: service.name, price: service.price, duration: service.duration, bufferTime: service.bufferTime || 0, photo: service.photo || null
                }));

                const startTimeISO = new Date(`${date}T${time}:00`).toISOString();

                const appointmentData = {
                    id: isEditing ? appointmentToEdit.id : null,
                    clientName, clientPhone, services: servicesDataForSave,
                    professionalId, startTime: startTimeISO,
                    establishmentId: user.establishmentId,
                };

                try {
                    await onSave(appointmentData);
                    showNotification('Sucesso!', `Agendamento ${isEditing ? 'atualizado' : 'criado'} com sucesso.`);
                    onClose();
                } catch (error) {
                    showNotification("Erro", `Não foi possível salvar o agendamento: ${error.message}`);
                } finally {
                    setIsSaving(false);
                }
            };

            const handleServiceToggle = (serviceId) => {
                setSelectedServices(prev =>
                    prev.includes(serviceId)
                        ? prev.filter(id => id !== serviceId)
                        : [...prev, serviceId]
                );
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-sm m-4 flex flex-col" style={{maxHeight: '90vh'}}>
                        <div className="p-4 border-b"><h3 className="text-xl font-bold text-gray-800">{isEditing ? 'Editar Agendamento' : 'Novo Agendamento'}</h3></div>
                        <div className="p-4 space-y-4 flex-1 overflow-y-auto">
                            {isLoadingData ? <p>A carregar...</p> : (
                                <>
                                <div><label className="text-sm font-medium text-gray-700 mb-1 block">Nome do Cliente</label><input type="text" value={clientName} onChange={(e) => setClientName(e.target.value)} className="w-full p-2 border border-gray-300 rounded-md" /></div>
                                <div><label className="text-sm font-medium text-gray-700 mb-1 block">Telemóvel do Cliente</label><input type="tel" value={clientPhone} onChange={(e) => setClientPhone(e.target.value)} className="w-full p-2 border border-gray-300 rounded-md" /></div>
                                <div>
                                    <label className="text-sm font-medium text-gray-700 mb-1 block">Serviços</label>
                                    <div className="space-y-1 max-h-24 overflow-y-auto p-2 border rounded-md">
                                        {availableServices.map(s => (
                                            <label key={s.id} className="flex items-center"><input type="checkbox" value={s.id} checked={selectedServices.includes(s.id)} onChange={() => handleServiceToggle(s.id)} className="mr-2" />{s.name}</label>
                                        ))}
                                    </div>
                                </div>
                                <div><label className="text-sm font-medium text-gray-700 mb-1 block">Profissional</label><select value={professionalId} onChange={(e) => setProfessionalId(e.target.value)} className="w-full p-2 border border-gray-300 rounded-md bg-white" disabled={isEmployee}><option value="">Selecione...</option>{availableProfessionals.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}</select></div>
                                <div><label className="text-sm font-medium text-gray-700 mb-1 block">Data</label><input type="date" value={date} onChange={e => setDate(e.target.value)} className="w-full p-2 border border-gray-300 rounded-md" /></div>
                                <div>
                                    <label className="text-sm font-medium text-gray-700 mb-1 block">Horário</label>
                                    <div className="grid grid-cols-4 gap-2">
                                        {availableTimes.length > 0 ? availableTimes.map(t => <button key={t} onClick={() => setTime(t)} className={`p-2 rounded-md text-sm ${time === t ? 'bg-blue-600 text-white' : 'bg-gray-100'}`}>{t}</button>) : <p className="col-span-4 text-center text-sm text-gray-500">Selecione os campos acima.</p>}
                                    </div>
                                </div>
                                </>
                            )}
                        </div>
                        <div className="p-4 bg-gray-50 flex gap-4"><button onClick={onClose} className="flex-1 py-2 px-4 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300">Cancelar</button><button onClick={handleSubmit} disabled={!isFormValid || isSaving} className="flex-1 py-2 px-4 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 disabled:bg-gray-400">{isSaving ? 'A salvar...' : (isEditing ? 'Salvar' : 'Agendar')}</button></div>
                    </div>
                </div>
            );
        };
        
        const ConfirmationModal = ({ isOpen, onClose, onConfirm, title, message }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100]" onClick={onClose}>
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-sm m-4 p-6 text-center" onClick={e => e.stopPropagation()}>
                        <h3 className="text-xl font-bold text-gray-800">{title}</h3>
                        <p className="text-gray-600 my-4">{message}</p>
                        <div className="flex gap-4">
                            <button onClick={onClose} className="flex-1 py-2 px-4 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300">Cancelar</button>
                            <button onClick={onConfirm} className="flex-1 py-2 px-4 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700">Confirmar</button>
                        </div>
                    </div>
                </div>
            );
        };


        // --- ECRÃ DA AGENDA ---
        const AgendaScreen = ({ user, showNotification, appointments, isLoading, error, refreshData, onNavigateToComanda }) => {
            const [currentDate, setCurrentDate] = useState(new Date());
            const [modalState, setModalState] = useState({ isOpen: false, appointment: null });
            const [confirmState, setConfirmState] = useState({ isOpen: false, appointmentId: null });
            const [actionMenuOpenId, setActionMenuOpenId] = useState(null);
            const [view, setView] = useState('list'); // 'list' ou 'week'
            const [professionals, setProfessionals] = useState([]);
            
            // LÓGICA DE ALÇADA: Permissão para ver a agenda de todos
            const canViewAll = user.role === 'owner' || user.permissions?.['agenda-section']?.view_all_prof === true;
            
            // Seleciona o professionalId do usuário se não puder ver todos
            const defaultProf = (!canViewAll && user.professionalId) ? user.professionalId : 'all';
            const [selectedProfessional, setSelectedProfessional] = useState(defaultProf);
            
            const [weekOffset, setWeekOffset] = useState(0); 
            const isEmployee = user.role === 'employee';

            const getDateToFetch = useCallback((date, offset, currentView) => {
                const d = new Date(date);
                d.setHours(0, 0, 0, 0);

                if (currentView === 'list') {
                    return d;
                } else { 
                    const displayDays = 3;
                    
                    const day = d.getDay();
                    const diff = d.getDate() - day + (day === 0 ? -6 : 1); 
                    d.setDate(diff);
                    
                    d.setDate(d.getDate() + offset * displayDays);
                    return d;
                }
            }, []);

            const fetchProfessionals = useCallback(async () => {
                try {
                    const data = await authenticatedFetch(`/api/professionals/${user.establishmentId}`, {}, user);
                    setProfessionals(data);
                } catch (error) {
                    showNotification('Erro', 'Não foi possível carregar a lista de profissionais.');
                }
            }, [user, showNotification]);

            useEffect(() => {
                fetchProfessionals();
            }, [fetchProfessionals]);
            
            useEffect(() => {
                if (refreshData) {
                    const startDateToFetch = getDateToFetch(currentDate, weekOffset, view);
                    refreshData(startDateToFetch, view, selectedProfessional);
                }
            }, [currentDate, view, selectedProfessional, refreshData, weekOffset, getDateToFetch]);


            const handleSaveAppointment = async (appointmentData) => {
                const isEditing = !!appointmentData.id;
                const url = isEditing ? `/api/appointments/${appointmentData.id}` : '/api/appointments';
                const method = isEditing ? 'PUT' : 'POST';
                try {
                    await authenticatedFetch(url, { method, body: JSON.stringify(appointmentData) }, user);
                    showNotification('Sucesso!', `Agendamento ${isEditing ? 'atualizado' : 'criado'} com sucesso.`);
                    setModalState({ isOpen: false, appointment: null });
                    await refreshData(getDateToFetch(currentDate, weekOffset, view), view, selectedProfessional);
                } catch (err) {
                    showNotification("Erro", `Não foi possível salvar o agendamento: ${err.message}`);
                }
            };

            const handleDelete = async (appointmentId) => {
                try {
                    await authenticatedFetch(`/api/appointments/${appointmentId}`, { method: 'DELETE' }, user);
                    showNotification('Sucesso!', 'Agendamento apagado com sucesso.');
                    await refreshData(getDateToFetch(currentDate, weekOffset, view), view, selectedProfessional);
                } catch(err) {
                    showNotification("Erro", `Não foi possível apagar o agendamento: ${err.message}`);
                } finally {
                    setConfirmState({ isOpen: false, appointmentId: null });
                }
            };

            const changeDate = (amount) => {
                if (view === 'list') {
                    setCurrentDate(prevDate => {
                        const newDate = new Date(prevDate);
                        newDate.setDate(newDate.getDate() + amount);
                        return newDate;
                    });
                } else { 
                    setWeekOffset(prevOffset => prevOffset + amount);
                }
            };

            const handleSetView = (newView) => {
                setView(newView);
                setWeekOffset(0); 
                if (newView === 'week') {
                     setCurrentDate(prevDate => getDateToFetch(prevDate, 0, 'week'));
                }
            };
            
            const formatDate = (date) => new Intl.DateTimeFormat('pt-BR', { weekday: 'long', day: 'numeric', month: 'long' }).format(date);
            
            const getDaysToDisplay = (startOfView) => {
                const days = [];
                const numDays = view === 'list' ? 1 : 3;
                for (let i = 0; i < numDays; i++) {
                    const day = new Date(startOfView);
                    day.setDate(startOfView.getDate() + i);
                    days.push(day);
                }
                return days;
            };
            
            const getWeekRangeString = () => {
                const startOfView = getDateToFetch(currentDate, weekOffset, view);
                const endOfView = new Date(startOfView);
                endOfView.setDate(startOfView.getDate() + 2); 
                return `${startOfView.toLocaleDateString('pt-BR', { day: 'numeric', month: 'short' })} - ${endOfView.toLocaleDateString('pt-BR', { day: 'numeric', month: 'short' })}`;
            };
            
            // --- NOVA FUNÇÃO: Cria o link do WhatsApp ---
            const createWhatsAppLink = (appt) => {
                const phone = appt.clientPhone.replace(/\D/g, ''); // Remove caracteres não numéricos
                const date = new Date(appt.startTime).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
                const time = new Date(appt.startTime).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                const serviceName = Array.isArray(appt.services) ? appt.services.map(s => s.name).join(', ') : (appt.serviceName || 'Serviço');
                
                const professionalName = appt.professionalName || 'o profissional';

                const message = `Olá, ${appt.clientName}! Seu agendamento de ${serviceName} com ${professionalName} para ${date} às ${time} está confirmado. Podemos te esperar nesse dia e horário?.`;

                return `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
            };

            
            const renderContentList = () => {
                const filteredAppointments = appointments.filter(appt => selectedProfessional === 'all' || appt.professionalId === selectedProfessional);
                if (isLoading) return <div className="text-center p-10 text-gray-500">A carregar agendamentos...</div>;
                if (error) return <div className="text-center p-10 text-red-500">{error}</div>;
                if (filteredAppointments.length === 0) return <div className="text-center p-10 text-gray-500">Nenhum agendamento para este dia.</div>;
                
                return filteredAppointments.map(appt => {
                    const serviceName = Array.isArray(appt.services) ? appt.services.map(s => s.name).join(', ') : (appt.serviceName || 'Serviço');
                    const isCompleted = appt.status === 'completed';
                    const whatsappLink = createWhatsAppLink(appt);
                    
                    return (
                        <div key={appt.id} onClick={() => onNavigateToComanda(appt.id)} className={`bg-white p-4 rounded-lg shadow-md border-l-4 ${isCompleted ? 'border-green-500 opacity-70' : 'border-blue-500'} cursor-pointer`}>
                            <div className="flex items-start justify-between">
                                <div>
                                    <span className="font-bold text-lg text-gray-800">{new Date(appt.startTime).toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'})}</span>
                                    <span className={`ml-2 text-xs font-semibold px-2 py-1 rounded-full ${isCompleted ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}`}>{isCompleted ? 'Finalizado' : 'Confirmado'}</span>
                                </div>
                                <div className="relative flex items-center gap-2">
                                    {/* BOTÃO DO WHATSAPP */}
                                    {!isCompleted && (
                                        <a href={whatsappLink} target="_blank" rel="noopener noreferrer" onClick={(e) => e.stopPropagation()} className="p-1 rounded-full hover:bg-green-100 transition-colors" title="Enviar Confirmação WhatsApp">
                                            {icons.whatsapp()}
                                        </a>
                                    )}
                                
                                    <button onClick={(e) => { e.stopPropagation(); setActionMenuOpenId(actionMenuOpenId === appt.id ? null : appt.id) }} className="p-1 rounded-full hover:bg-gray-100">{icons.dots()}</button>
                                    {actionMenuOpenId === appt.id && (
                                        <div className="absolute right-0 top-full mt-2 w-32 bg-white rounded-md shadow-lg border z-10">
                                            <button onClick={(e) => { e.stopPropagation(); setModalState({ isOpen: true, appointment: appt }); setActionMenuOpenId(null); }} className="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Editar</button>
                                            <button onClick={(e) => { e.stopPropagation(); setConfirmState({ isOpen: true, appointmentId: appt.id }); setActionMenuOpenId(null); }} className="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100">Apagar</button>
                                        </div>
                                    )}
                                </div>
                            </div>
                            <div className="mt-2"><p className="font-bold text-gray-900">{appt.clientName}</p><p className="text-sm text-gray-600">{serviceName}</p><p className="text-sm text-gray-500 mt-1">com {appt.professionalName}</p></div>
                        </div>
                    )
                });
            };

            const renderContentWeek = () => {
                const filteredAppointments = appointments.filter(appt => selectedProfessional === 'all' || appt.professionalId === selectedProfessional);
                if (isLoading) return <div className="text-center p-10 text-gray-500 col-span-full">A carregar agendamentos...</div>;
                if (error) return <div className="text-center p-10 text-red-500 col-span-full">{error}</div>;

                const startOfView = getDateToFetch(currentDate, weekOffset, view);
                const daysToDisplay = getDaysToDisplay(startOfView);
                const today = new Date();
                today.setHours(0,0,0,0);

                return daysToDisplay.map(day => {
                    const isCurrentDay = day.toDateString() === today.toDateString();
                    const dayEvents = filteredAppointments.filter(appt => new Date(appt.startTime).toDateString() === day.toDateString());
                    
                    return (
                        <div key={day.toISOString()} className="day-column">
                            <div className={`day-header ${isCurrentDay ? 'current-day text-indigo-600' : ''}`}>
                                <p className="font-bold">{day.toLocaleDateString('pt-BR', { weekday: 'short' })}</p>
                                <p className="text-sm">{day.getDate()}/{day.getMonth() + 1}</p>
                            </div>
                            <div className="day-content p-2 space-y-2">
                                {dayEvents.length > 0 ? dayEvents.map(appt => {
                                    const serviceName = Array.isArray(appt.services) ? appt.services.map(s => s.name).join(', ') : (appt.serviceName || 'Serviço');
                                    const isCompleted = appt.status === 'completed';
                                    const whatsappLink = createWhatsAppLink(appt);
                                    
                                    return (
                                        <div key={appt.id} onClick={() => onNavigateToComanda(appt.id)} className={`bg-white p-2 rounded-lg shadow-sm border-l-4 ${isCompleted ? 'border-green-500 opacity-70' : 'border-blue-500'} cursor-pointer`}>
                                            <div className="flex justify-between items-center">
                                                <div className="flex-1">
                                                    <p className="text-xs font-bold text-gray-800">{new Date(appt.startTime).toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'})}</p>
                                                    <p className="text-xs text-gray-600">{appt.clientName}</p>
                                                    <p className="text-xs text-gray-500 truncate">{serviceName}</p>
                                                </div>
                                                {/* BOTÃO DO WHATSAPP para a visão semanal */}
                                                {!isCompleted && (
                                                    <a href={whatsappLink} target="_blank" rel="noopener noreferrer" onClick={(e) => e.stopPropagation()} className="p-1 rounded-full hover:bg-green-100 transition-colors" title="Enviar Confirmação WhatsApp">
                                                        {icons.whatsapp('currentColor')}
                                                    </a>
                                                )}
                                            </div>
                                        </div>
                                    );
                                }) : <p className="text-xs text-gray-400 text-center">Nenhum evento</p>}
                            </div>
                        </div>
                    );
                });
            };

            return (
                <div className="relative h-full flex flex-col">
                    <div className="flex-shrink-0 p-4 bg-white border-b border-gray-200">
                        <div className="flex justify-center mb-4">
                            <div className="flex items-center gap-1 rounded-lg bg-gray-200 p-1">
                                <button onClick={() => handleSetView('list')} className={`view-btn ${view === 'list' ? 'active' : ''}`}>Dia</button>
                                <button onClick={() => handleSetView('week')} className={`view-btn ${view === 'week' ? 'active' : ''}`}>Semana</button>
                            </div>
                        </div>
                        <div className="flex items-center justify-between mb-4">
                            <button onClick={() => changeDate(-1)} className="p-2 rounded-full hover:bg-gray-100">&lt;</button>
                            <h3 className="font-semibold text-gray-800">
                                {view === 'list' ? formatDate(currentDate) : getWeekRangeString()}
                            </h3>
                            <button onClick={() => changeDate(1)} className="p-2 rounded-full hover:bg-gray-100">&gt;</button>
                        </div>
                        {/* LÓGICA DE ALÇADA: Desabilita e esconde a opção 'Todos' se o usuário não puder ver todos */}
                        <select onChange={e => setSelectedProfessional(e.target.value)} value={selectedProfessional} className="w-full p-2 border border-gray-300 rounded-md bg-white text-sm" disabled={!canViewAll}>
                            {canViewAll && <option value="all">Todos os Profissionais</option>}
                            {professionals.map(p => (
                                <option key={p.id} value={p.id}>{p.name}</option>
                            ))}
                        </select>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4">
                        {view === 'list' ? (
                            <div className="space-y-4">{renderContentList()}</div>
                        ) : (
                            <div className="agenda-week-view h-full">{renderContentWeek()}</div>
                        )}
                    </div>
                    <button onClick={() => setModalState({ isOpen: true, appointment: null })} className="fixed bottom-6 right-6 bg-blue-600 text-white w-14 h-14 rounded-full flex items-center justify-center shadow-lg hover:bg-blue-700">{icons.plus('white')}</button>
                    <AppointmentModal isOpen={modalState.isOpen} onClose={() => setModalState({ isOpen: false, appointment: null })} onSave={handleSaveAppointment} appointmentToEdit={modalState.appointment} user={user} showNotification={showNotification} />
                    <ConfirmationModal isOpen={confirmState.isOpen} onClose={() => setConfirmState({ isOpen: false, appointmentId: null })} onConfirm={() => handleDelete(confirmState.appointmentId)} title="Apagar Agendamento" message="Tem a certeza que deseja apagar este agendamento?" />
                </div>
            );
        };

        // --- Modal para Adicionar Itens à Comanda ---
        const AddItemModal = ({ isOpen, onClose, onAddItem, user, showNotification }) => {
            if (!isOpen) return null;
            const [searchTerm, setSearchTerm] = useState('');
            const [items, setItems] = useState({ services: [], products: [] });
            const [isLoading, setIsLoading] = useState(true);

            useEffect(() => {
                const fetchData = async () => {
                    setIsLoading(true);
                    try {
                        const [servicesData, productsData] = await Promise.all([
                            authenticatedFetch(`/api/services/${user.establishmentId}`, {}, user),
                            authenticatedFetch(`/api/products/${user.establishmentId}`, {}, user)
                        ]);
                        setItems({ services: servicesData, products: productsData });
                    } catch (error) {
                        showNotification('Erro', 'Não foi possível carregar o catálogo de itens.');
                        console.error('Erro ao carregar catálogo de itens:', error);
                    } finally {
                        setIsLoading(false);
                    }
                };
                fetchData();
            }, [user, showNotification]);
            
            const handleItemClick = (item) => {
                onAddItem(item);
                onClose();
            };

            const filteredServices = items.services.filter(s => s.name.toLowerCase().includes(searchTerm.toLowerCase()));
            const filteredProducts = items.products.filter(p => p.name.toLowerCase().includes(searchTerm.toLowerCase()));

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-sm m-4 flex flex-col" style={{maxHeight: '90vh'}}>
                        <div className="p-4 border-b flex justify-between items-center">
                            <h3 className="text-xl font-bold text-gray-800">Adicionar Item</h3>
                            <button onClick={onClose} className="text-2xl font-bold">&times;</button>
                        </div>
                        <div className="p-4 border-b">
                            <input
                                type="text"
                                placeholder="Pesquisar..."
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                                className="w-full p-2 border border-gray-300 rounded-md"
                            />
                        </div>
                        <div className="flex-1 p-4 overflow-y-auto">
                            {isLoading ? <p>A carregar catálogo...</p> : (
                                <>
                                    {filteredServices.length > 0 && (
                                        <>
                                            <h4 className="font-semibold text-gray-700 mb-2">Serviços</h4>
                                            <div className="space-y-2">
                                                {filteredServices.map(item => (
                                                    <button key={item.id} onClick={() => handleItemClick({ ...item, type: 'service' })} className="w-full text-left flex justify-between items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100">
                                                        <span>{item.name}</span>
                                                        <span className="font-semibold">R$ {item.price.toFixed(2)}</span>
                                                    </button>
                                                ))}
                                            </div>
                                        </>
                                    )}
                                    {filteredProducts.length > 0 && (
                                        <>
                                            <h4 className="font-semibold text-gray-700 mt-4 mb-2">Produtos</h4>
                                            <div className="space-y-2">
                                                {filteredProducts.map(item => (
                                                    <button key={item.id} onClick={() => handleItemClick({ ...item, type: 'product' })} className="w-full text-left flex justify-between items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100">
                                                        <span>{item.name}</span>
                                                        <span className="font-semibold">R$ {item.price.toFixed(2)}</span>
                                                    </button>
                                                ))}
                                            </div>
                                        </>
                                    )}
                                    {filteredServices.length === 0 && filteredProducts.length === 0 && <p className="text-center text-gray-500">Nenhum item encontrado.</p>}
                                </>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- Modal de Checkout ---
        const CheckoutModal = ({ isOpen, onClose, onSave, comanda, total, user, showNotification }) => {
            if (!isOpen) return null;
        
            const [payments, setPayments] = useState([]);
            const [currentMethod, setCurrentMethod] = useState('dinheiro');
            const [currentValue, setCurrentValue] = useState('');
            const [amountReceived, setAmountReceived] = useState('');
            const [isSaving, setIsSaving] = useState(false);
        
            const totalPaid = payments.reduce((acc, p) => acc + p.value, 0);
            const remainingAmount = total - totalPaid;
            const change = (currentMethod === 'dinheiro' && amountReceived && remainingAmount > 0) ? parseFloat(amountReceived) - remainingAmount : 0;
        
            const handleAddPayment = () => {
                const value = parseFloat(currentValue);
                if (!value || value <= 0 || value > remainingAmount + 0.001) {
                    showNotification('Valor Inválido', 'Por favor, insira um valor de pagamento válido e que não exceda o valor em falta.');
                    return;
                }
                setPayments([...payments, { method: currentMethod, value }]);
                setCurrentValue('');
            };
        
            const handleRemovePayment = (index) => {
                setPayments(payments.filter((_, i) => i !== index));
            };
        
            const handleFinalizeCheckout = async () => {
                setIsSaving(true);
                try {
                    const paymentData = {
                        payments,
                        totalAmount: total,
                        items: [...(comanda.services || []), ...(comanda.comandaItems || [])],
                    };
                    await authenticatedFetch(`/api/appointments/${comanda.id}/checkout`, { method: 'POST', body: JSON.stringify(paymentData) }, user);
                    showNotification('Sucesso!', 'Pagamento finalizado com sucesso.');
                    onSave();
                    onClose();
                } catch (error) {
                    showNotification("Erro", `Não foi possível finalizar o pagamento: ${error.message}`);
                } finally {
                    setIsSaving(false);
                }
            };
        
            useEffect(() => {
                if (remainingAmount > 0) {
                    setCurrentValue(remainingAmount.toFixed(2));
                } else {
                    setCurrentValue('');
                }
            }, [remainingAmount]);
        
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60]">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-sm m-4 flex flex-col" style={{maxHeight: '90vh'}}>
                        <div className="p-4 border-b"><h3 className="text-xl font-bold text-gray-800">Finalizar Pagamento</h3></div>
                        <div className="p-4 flex-1 overflow-y-auto">
                            <div className="text-center mb-4">
                                <p className="text-lg text-gray-600">Valor Total</p>
                                <p className="text-5xl font-bold text-gray-800 my-2">R$ ${total.toFixed(2)}</p>
                            </div>
                            <div className="space-y-2 mb-4">
                                {payments.map((p, index) => (
                                    <div key={index} className="flex justify-between items-center bg-gray-100 p-2 rounded-md">
                                        <span>{p.method.charAt(0).toUpperCase() + p.method.slice(1)}</span>
                                        <span>R$ {p.value.toFixed(2)}</span>
                                        <button data-payment-index="${index}" className="text-red-500 font-bold">&times;</button>
                                    </div>
                                ))}
                            </div>
                            {remainingAmount > 0.001 && (
                                <div className="flex items-center gap-2 mb-4">
                                    <select value={currentMethod} onChange={e => setCurrentMethod(e.target.value)} className="p-2 border rounded-md w-1/2 bg-white"><option value="dinheiro">Dinheiro</option><option value="pix">PIX</option><option value="credito">Crédito</option><option value="debito">Débito</option></select>
                                    <input type="number" step="0.01" value={currentValue} onChange={e => setCurrentValue(e.target.value)} placeholder="Valor" className="p-2 border rounded-md w-1/2" />
                                    <button onClick={handleAddPayment} className="p-2 bg-blue-500 text-white rounded-md font-bold">+</button>
                                </div>
                            )}
                            <p className={`text-xl font-bold text-center mb-4 ${remainingAmount > 0.001 ? 'text-red-600' : 'text-green-600'}`}>
                                {remainingAmount > 0.001 ? `Faltam R$ ${remainingAmount.toFixed(2)}` : 'Total Pago!'}
                            </p>
                            {currentMethod === 'dinheiro' && remainingAmount > 0.001 && (
                                <div className="mt-4 p-4 bg-blue-50 rounded-lg space-y-2">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700">Valor Recebido (Dinheiro)</label>
                                        <input type="number" step="0.01" value={amountReceived} onChange={e => setAmountReceived(e.target.value)} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm text-2xl p-2 text-center" />
                                    </div>
                                    <p className="flex justify-between text-lg font-semibold">
                                        <span>Troco:</span>
                                        <strong className="text-blue-600">R$ {change > 0 ? change.toFixed(2) : '0.00'}</strong>
                                    </p>
                                </div>
                            )}
                        </div>
                        <div className="p-4 bg-gray-50 flex gap-4">
                            <button onClick={onClose} className="flex-1 py-2 px-4 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300">Cancelar</button>
                            <button onClick={handleFinalizeCheckout} disabled={remainingAmount > 0.001 || isSaving} className="flex-1 py-2 px-4 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 disabled:bg-gray-400">
                                {isSaving ? 'A finalizar...' : 'Confirmar Pagamento'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Modal de Detalhes da Comanda ---
        const ComandaDetailModal = ({ comanda, isOpen, onClose, onUpdate, user, showNotification }) => {
            if (!isOpen) return null;

            const [isAddItemModalOpen, setIsAddItemModalOpen] = useState(false);
            const [isCheckoutModalOpen, setIsCheckoutModalOpen] = useState(false);
            const [isSaving, setIsSaving] = useState(false);
            const [confirmationState, setConfirmationState] = useState({ isOpen: false, action: null });

            const allDisplayItems = [...(comanda.services || []), ...(comanda.comandaItems || [])];
            const total = allDisplayItems.reduce((acc, item) => acc + (item.price || 0), 0);
            
            const handleActionConfirm = async () => {
                const { action } = confirmationState;
                setIsSaving(true);
                setConfirmationState({ isOpen: false, action: null });
        
                try {
                    if (action === 'reopen') {
                        const endpoint = comanda.type === 'appointment' ? `/api/appointments/${comanda.id}/reopen` : `/api/sales/${comanda.id}/reopen`;
                        await authenticatedFetch(endpoint, { method: 'POST' }, user);
                        showNotification('Sucesso!', 'Comanda foi reaberta para edição.');
                    } else if (action === 'awaiting_payment') {
                        await authenticatedFetch(`/api/appointments/${comanda.id}/awaiting-payment`, { method: 'POST' }, user);
                        showNotification('Sucesso!', 'Comanda movida para aguardar pagamento.');
                    }
                    onUpdate();
                    onClose();
                } catch (error) {
                    showNotification("Erro", `Ação falhou: ${error.message}`);
                } finally {
                    setIsSaving(false);
                }
            };

            const handleAddItem = async (newItem) => {
                const updatedItems = [...(comanda.comandaItems || []), { itemId: newItem.id, name: newItem.name, price: newItem.price, type: newItem.type }];
                try {
                    await authenticatedFetch(`/api/appointments/${comanda.id}/comanda`, { method: 'POST', body: JSON.stringify({ items: updatedItems }) }, user);
                    setIsAddItemModalOpen(false);
                    onUpdate();
                } catch (error) {
                    showNotification("Erro", `Não foi possível adicionar o item: ${error.message}`);
                }
            };
            
            const renderFooter = () => {
                if (comanda.status === 'completed') {
                    return (
                        <div className="p-4 bg-gray-50 space-y-2">
                             <button onClick={() => setConfirmationState({ isOpen: true, action: 'reopen' })} disabled={isSaving} className="w-full py-2 px-4 bg-yellow-500 text-white font-semibold rounded-lg hover:bg-yellow-600 disabled:bg-gray-400">
                                 {isSaving ? 'Aguarde...' : 'Reabrir Comanda'}
                             </button>
                             <button onClick={onClose} className="w-full py-2 px-4 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300">
                                Fechar
                            </button>
                        </div>
                    );
                }

                const commonButtons = (
                    <div className="flex gap-4">
                        <button onClick={onClose} className="flex-1 py-2 px-4 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300">Fechar</button>
                        <button onClick={() => setIsCheckoutModalOpen(true)} disabled={isSaving} className="flex-1 py-2 px-4 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 disabled:bg-gray-400">
                            Finalizar Pagamento
                        </button>
                    </div>
                );

                if (comanda.status === 'awaiting_payment') {
                    return (
                        <div className="p-4 bg-gray-50 space-y-2">
                            <button onClick={() => setIsAddItemModalOpen(true)} className="w-full py-2 px-4 bg-blue-100 text-blue-700 font-semibold rounded-lg hover:bg-blue-200">Adicionar Item</button>
                            {commonButtons}
                        </div>
                    );
                }

                return (
                    <div className="p-4 bg-gray-50 space-y-2">
                        <button onClick={() => setIsAddItemModalOpen(true)} className="w-full py-2 px-4 bg-blue-100 text-blue-700 font-semibold rounded-lg hover:bg-blue-200">Adicionar Item</button>
                        <button onClick={() => setConfirmationState({ isOpen: true, action: 'awaiting_payment' })} disabled={isSaving} className="w-full py-2 px-4 bg-yellow-500 text-white font-semibold rounded-lg hover:bg-yellow-600">
                            Aguardar Pagamento
                        </button>
                        {commonButtons}
                    </div>
                );
            };

            const confirmationDetails = {
                reopen: { title: 'Reabrir Comanda', message: 'Tem a certeza que deseja reabrir esta comanda? O pagamento será revertido.' },
                awaiting_payment: { title: 'Mover Comanda', message: 'Deseja mover esta comanda para a lista de "Aguardando Pagamento"? O cliente poderá pagar mais tarde.' }
            };

            return (
                <>
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onClick={onClose}>
                        <div className="bg-white rounded-lg shadow-xl w-full max-w-sm m-4" onClick={e => e.stopPropagation()}>
                            <div className="p-4 border-b">
                                <h3 className="text-xl font-bold text-gray-800">{comanda.clientName}</h3>
                                <p className="text-sm text-gray-600">
                                    {new Date(comanda.startTime).toLocaleString('pt-BR', { day: '2-digit', month: 'long', hour: '2-digit', minute: '2-digit' })}
                                </p>
                                <p className="text-sm text-gray-500">com {comanda.professionalName}</p>
                            </div>
                            <div className="p-4 space-y-2 max-h-64 overflow-y-auto">{allDisplayItems.map((item, index) => (<div key={index} className="flex justify-between items-center"><div><p className="font-semibold text-gray-800">{item.name}</p></div><p className="text-gray-700">R$ {(item.price || 0).toFixed(2)}</p></div>))}</div>
                            <div className="p-4 border-t flex justify-between items-center"><span className="font-bold text-lg">Total</span><span className="font-bold text-xl text-gray-900">R$ {total.toFixed(2)}</span></div>
                            {renderFooter()}
                        </div>
                    </div>
                    <AddItemModal isOpen={isAddItemModalOpen} onClose={() => setIsAddItemModalOpen(false)} onAddItem={handleAddItem} user={user} showNotification={showNotification} />
                    <CheckoutModal isOpen={isCheckoutModalOpen} onClose={() => setIsCheckoutModalOpen(false)} onSave={onUpdate} comanda={comanda} total={total} user={user} showNotification={showNotification} />
                    <ConfirmationModal
                        isOpen={confirmationState.isOpen}
                        onClose={() => setConfirmationState({ isOpen: false, action: null })}
                        onConfirm={handleActionConfirm}
                        title={confirmationDetails[confirmationState.action] ? confirmationDetails[confirmationState.action].title : ''}
                        message={confirmationDetails[confirmationState.action] ? confirmationDetails[confirmationState.action].message : ''}
                    />
                </>
            );
        };


        // --- Ecrã de Comandas ---
        const ComandasScreen = ({ user, showNotification, refreshAgenda, selectedComandaId, onComandaOpened, activeTab }) => {
            const [activeFilter, setActiveFilter] = useState('atendimento');
            const [selectedComanda, setSelectedComanda] = useState(null);
            const [allComandas, setAllComandas] = useState([]);
            const [isLoadingComandas, setIsLoadingComandas] = useState(true);
            const [errorComandas, setErrorComandas] = useState(null);
            const isEmployee = user.role === 'employee';

            // LÓGICA DE ALÇADA: Permissão para ver comandas de todos
            const canViewAll = user.role === 'owner' || user.permissions?.['comandas-section']?.view_all_prof === true;

            const fetchComandas = useCallback(async () => {
                if (!user) return;
                setIsLoadingComandas(true);
                setErrorComandas(null);
                try {
                    let endpoint = `/api/comandas/${user.establishmentId}`;
                    // CORREÇÃO: Envia o professionalId apenas se for funcionário E não puder ver todos
                    if (isEmployee && !canViewAll && user.professionalId) {
                         endpoint += `?professionalId=${user.professionalId}`;
                    }
                    const data = await authenticatedFetch(endpoint, {}, user);
                    setAllComandas(data);
                } catch (err) {
                    setErrorComandas('Falha ao carregar a lista completa de comandas.');
                    showNotification('Erro', 'Falha ao carregar a lista completa de comandas.');
                } finally {
                    setIsLoadingComandas(false);
                }
            }, [user, showNotification, isEmployee, canViewAll]);

            useEffect(() => {
                if (activeTab === 'Comandas') {
                    fetchComandas();
                }
            }, [activeTab, fetchComandas]);
            
            useEffect(() => {
                if (selectedComandaId && allComandas.length > 0) {
                    const comandaToOpen = allComandas.find(c => c.id === selectedComandaId);
                    if (comandaToOpen) {
                        setSelectedComanda(comandaToOpen);
                        onComandaOpened();
                    }
                }
            }, [selectedComandaId, allComandas, onComandaOpened]);


            const statusMap = {
                atendimento: { label: 'Em Atendimento', statusValue: 'confirmed' },
                pagamento: { label: 'Aguardando Pagamento', statusValue: 'awaiting_payment' },
                finalizada: { label: 'Finalizadas', statusValue: 'completed' },
            };
            
            const handleUpdate = async () => {
                await fetchComandas(); 
                refreshAgenda();
                setSelectedComanda(null);
            };

            const renderContent = () => {
                if (isLoadingComandas) return <div className="text-center py-10"><p className="text-gray-500">A carregar comandas...</p></div>;
                if (errorComandas) return <div className="text-center py-10"><p className="text-red-500">{errorComandas}</p></div>;

                const currentStatus = statusMap[activeFilter].statusValue;
                const filteredComandas = allComandas.filter(c => c.status === currentStatus);

                if (filteredComandas.length === 0) return <div className="text-center py-10"><p className="text-gray-500">Nenhuma comanda encontrada para este filtro.</p></div>;

                return filteredComandas.map(comanda => {
                    const total = [...(comanda.services || []), ...(comanda.comandaItems || [])].reduce((acc, item) => acc + (item.price || 0), 0);
                    return (
                        <div key={comanda.id} onClick={() => setSelectedComanda(comanda)} className={`bg-white p-4 rounded-lg shadow-md border-l-4 ${activeFilter === 'atendimento' ? 'border-blue-500' : activeFilter === 'pagamento' ? 'border-yellow-500' : 'border-green-500'} cursor-pointer`}>
                            <div className="flex justify-between items-start">
                                <div><p className="font-bold text-gray-900">{comanda.clientName}</p><p className="text-sm text-gray-500">com {comanda.professionalName}</p></div>
                                <div className="text-right"><p className="font-bold text-lg text-gray-800">R$ {total.toFixed(2)}</p><p className="text-xs text-gray-500">{new Date(comanda.startTime).toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'})}</p></div>
                            </div>
                        </div>
                    )
                });
            };

            return (
                <div className="h-full flex flex-col">
                    <div className="p-2 bg-white border-b border-gray-200"><div className="flex bg-gray-100 rounded-lg p-1">{Object.keys(statusMap).map(key => (<button key={key} onClick={() => setActiveFilter(key)} className={`flex-1 text-sm font-semibold py-2 rounded-md transition-colors ${activeFilter === key ? 'bg-white text-blue-600 shadow' : 'text-gray-600'}`}>{statusMap[key].label}</button>))}</div></div>
                    <div className="flex-1 overflow-y-auto p-4 space-y-3">{renderContent()}</div>
                    <ComandaDetailModal comanda={selectedComanda} isOpen={!!selectedComanda} onClose={() => setSelectedComanda(null)} onUpdate={handleUpdate} user={user} showNotification={showNotification} />
                </div>
            );
        };

        // --- Ecrã de Relatórios ---
        const RelatoriosScreen = ({ user, showNotification }) => {
            const [kpis, setKpis] = useState(null);
            const [chartData, setChartData] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const [error, setError] = useState(null);

            useEffect(() => {
                const fetchReports = async () => {
                    if (!user) return;
                    setIsLoading(true);
                    setError(null);
                    const endDate = new Date();
                    const startDate = new Date();
                    startDate.setDate(endDate.getDate() - 30);

                    try {
                        // FILTRO: A rota /api/analytics/:establishmentId já aplica o filtro pelo professionalId
                        const url = `/api/analytics/${user.establishmentId}?startDate=${startDate.toISOString().split('T')[0]}&endDate=${endDate.toISOString().split('T')[0]}`;
                        const data = await authenticatedFetch(url, {}, user);

                        setKpis(data.kpis);
                        setChartData({
                            labels: data.transactionsByMonth.map(item => item.month),
                            datasets: [{
                                label: 'Vendas',
                                data: data.transactionsByMonth.map(item => item.revenue),
                                backgroundColor: 'rgba(59, 130, 246, 0.5)',
                                borderColor: 'rgba(59, 130, 246, 1)',
                                borderWidth: 1,
                            }]
                        });

                    } catch (err) {
                        setError('Falha ao carregar os relatórios.');
                        console.error(err);
                    } finally {
                        setIsLoading(false);
                    }
                };
                fetchReports();
            }, [user]);

            const chartOptions = { responsive: true, plugins: { legend: { display: false }, title: { display: false }, }, scales: { y: { beginAtZero: true } } };

            const ChartCanvas = () => {
                const canvasRef = useRef(null);

                useEffect(() => {
                    if (canvasRef.current && chartData) {
                        const chartInstance = new ChartJS(canvasRef.current, {
                            type: 'bar',
                            data: chartData,
                            options: chartOptions
                        });
                        return () => chartInstance.destroy();
                    }
                }, [chartData]);

                return <canvas ref={canvasRef}></canvas>;
            };
            
            if (error) return <div className="text-center p-10 text-red-500">{error}</div>;

            return (
                <div className={`p-4 space-y-6 ${isLoading ? 'animate-pulse' : ''}`}>
                    <div className={`p-4 space-y-6 ${!isLoading && 'animate-none'}`}>
                        <div className="grid grid-cols-2 gap-4">
                            <div className="bg-white p-4 rounded-lg shadow-md text-center">
                                <p className="text-sm text-gray-500">Receita Total</p>
                                {isLoading ? <div className="h-8 bg-gray-200 rounded-md mt-1"></div> : <p className="text-2xl font-bold text-green-600">R$ {(kpis?.totalRevenue || 0).toFixed(2)}</p>}
                            </div>
                            <div className="bg-white p-4 rounded-lg shadow-md text-center">
                                <p className="text-sm text-gray-500">Vendas Totais</p>
                                {isLoading ? <div className="h-8 bg-gray-200 rounded-md mt-1"></div> : <p className="text-2xl font-bold text-blue-600">{kpis?.totalTransactions || 0}</p>}
                            </div>
                        </div>
                        <div className="bg-white p-4 rounded-lg shadow-md text-center">
                            <p className="text-sm text-gray-500">Item Mais Popular</p>
                            {isLoading ? <div className="h-7 bg-gray-200 rounded-md mt-1 w-3/4 mx-auto"></div> : <p className="text-xl font-bold text-indigo-600">{kpis?.mostPopularItem || 'N/A'}</p>}
                        </div>
                        <div className="bg-white p-4 rounded-lg shadow-md">
                            <h3 className="font-semibold text-gray-800 mb-4">Receita por Mês</h3>
                            {isLoading || !chartData ? <div className="h-48 bg-gray-200 rounded-md"></div> : <ChartCanvas />}
                        </div>
                    </div>
                </div>
            );
        };

        // --- NOVO: Ecrã de Meu Perfil ---
        const MeuPerfilScreen = ({ user, onLogout, onNavigate }) => {
            const [professionalData, setProfessionalData] = useState(null);
            const [isLoading, setIsLoading] = useState(true);

            useEffect(() => {
                const fetchData = async () => {
                    if (user.professionalId) {
                        try {
                            const data = await authenticatedFetch(`/api/professionals/${user.establishmentId}`, {}, user);
                            const prof = data.find(p => p.id === user.professionalId);
                            setProfessionalData(prof);
                        } catch(e) {
                             console.error("Failed to fetch professional data:", e);
                        }
                    }
                    setIsLoading(false);
                };
                fetchData();
            }, [user]);

            const managementLinks = [
                 { key: 'servicos-section', name: 'Gerir Serviços', nav: 'Servicos' },
                 { key: 'produtos-section', name: 'Gerir Produtos', nav: 'Produtos' },
                 { key: 'profissionais-section', name: 'Gerir Equipa', nav: 'Profissionais' },
            ].filter(link => user.permissions?.[link.key]?.view === true);

            return (
                 <div className="p-4 space-y-6">
                    <div className="bg-white p-6 rounded-lg shadow-md text-center">
                        {isLoading ? (
                            <div className="h-20 bg-gray-200 rounded-md animate-pulse"></div>
                        ) : (
                            <>
                                <div className="w-16 h-16 rounded-full bg-blue-500 flex items-center justify-center text-white font-bold text-3xl mx-auto mb-3">
                                    {user.name.charAt(0).toUpperCase()}
                                </div>
                                <h3 className="font-bold text-xl text-gray-900">{user.name}</h3>
                                <p className="text-gray-600">{user.email}</p>
                            </>
                        )}
                        {professionalData && (
                            <div className="mt-4 pt-4 border-t border-gray-100 space-y-1">
                                <p className="text-sm font-semibold text-indigo-600">{professionalData.specialty}</p>
                                <p className="text-xs text-gray-500">ID Profissional: {user.professionalId}</p>
                                <p className="text-xs text-gray-500">Função: Funcionário</p>
                            </div>
                        )}
                    </div>
                    
                     {managementLinks.length > 0 && (
                        <div className="bg-white rounded-lg shadow-md">
                             <h4 className="p-4 font-semibold text-gray-700 border-b">Acesso Rápido (Gerir)</h4>
                             {managementLinks.map((link, index) => (
                                 <button key={link.key} onClick={() => onNavigate(link.nav)} className="w-full text-left p-4 border-b last:border-b-0 text-gray-700 hover:bg-gray-50">
                                     {link.name}
                                 </button>
                             ))}
                        </div>
                     )}

                    <div className="pt-4">
                         <button onClick={onLogout} className="w-full bg-red-500 text-white font-bold py-3 rounded-lg hover:bg-red-600 transition-colors">Sair</button>
                    </div>
                </div>
            );
        };
        
        // --- Ecrã de Gestão (Controla o Menu) ---
        const GestaoScreen = ({ user, onLogout, onNavigate }) => {
            const isOwner = user.role === 'owner';
            
            const ownerLinks = [
                 { key: 'servicos-section', name: 'Gerir Serviços', nav: 'Servicos', visible: true },
                 { key: 'produtos-section', name: 'Gerir Produtos', nav: 'Produtos', visible: true },
                 { key: 'profissionais-section', name: 'Gerir Equipa', nav: 'Profissionais', visible: true },
                 { key: 'estabelecimento-section', name: 'Dados do Estabelecimento', nav: 'Estabelecimento', visible: true },
            ];

            const filteredOwnerLinks = ownerLinks.filter(link => 
                user.permissions?.[link.key]?.view === true || isOwner
            );

            return (
                <div className="p-4 space-y-6">
                    {isOwner ? (
                        <>
                            <div className="bg-white p-6 rounded-lg shadow-md flex items-center space-x-4">
                                <div className="w-16 h-16 rounded-full bg-indigo-500 flex items-center justify-center text-white font-bold text-3xl">
                                    {user.name.charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <h3 className="font-bold text-xl text-gray-900">Painel do Dono</h3>
                                    <p className="text-gray-600">{user.email}</p>
                                </div>
                            </div>

                            <div className="bg-white rounded-lg shadow-md">
                                {filteredOwnerLinks.map(link => (
                                    <button key={link.key} onClick={() => onNavigate(link.nav)} className="w-full text-left p-4 border-b last:border-b-0 text-gray-700 hover:bg-gray-50">
                                        {link.name}
                                    </button>
                                ))}
                            </div>
                            <div className="pt-4">
                                <button onClick={onLogout} className="w-full bg-red-500 text-white font-bold py-3 rounded-lg hover:bg-red-600 transition-colors">Sair</button>
                            </div>
                        </>
                    ) : (
                        <MeuPerfilScreen user={user} onLogout={onLogout} onNavigate={onNavigate} />
                    )}
                </div>
            );
        };
        
        // --- ECRÃ: ESTABELECIMENTO ---
        const EstablishmentScreen = ({ user, showNotification, onBack, onUpdate }) => {
            const [establishmentData, setEstablishmentData] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const [isSaving, setIsSaving] = useState(false);
            const fileInputRef = useRef(null);

            const daysOfWeek = { monday: 'Segunda', tuesday: 'Terça', wednesday: 'Quarta', thursday: 'Quinta', friday: 'Sexta', saturday: 'Sábado', sunday: 'Domingo' };

            const fetchEstablishmentData = useCallback(async () => {
                setIsLoading(true);
                try {
                    const data = await authenticatedFetch(`/api/establishments/${user.establishmentId}/details`, {}, user);
                    setEstablishmentData(data);
                } catch (error) {
                    showNotification('Erro', 'Não foi possível carregar os dados do estabelecimento.');
                } finally {
                    setIsLoading(false);
                }
            }, [user, showNotification]);

            useEffect(() => { fetchEstablishmentData(); }, [fetchEstablishmentData]);

            const handleSave = async (e) => {
                e.preventDefault();
                setIsSaving(true);
                
                const form = e.target;
                
                const workingHours = {};
                Object.keys(daysOfWeek).forEach(dayKey => {
                    const active = form[`est-${dayKey}-active`]?.checked || false;
                    workingHours[dayKey] = {
                        active: active,
                        start: active ? form[`est-${dayKey}-start`]?.value : null,
                        end: active ? form[`est-${dayKey}-end`]?.value : null,
                        breakStart: active ? form[`est-${dayKey}-breakStart`]?.value : null,
                        breakEnd: active ? form[`est-${dayKey}-breakEnd`]?.value : null,
                    };
                });
                
                const loyaltyTiers = [];
                const tierRows = form.querySelectorAll('.loyalty-tier-row');
                tierRows.forEach(row => {
                    const points = parseInt(row.querySelector('[name="loyalty-points"]').value, 10);
                    const reward = row.querySelector('[name="loyalty-reward"]').value;
                    const discount = parseFloat(row.querySelector('[name="loyalty-discount"]').value);
                    if (points && reward) {
                        loyaltyTiers.push({ points, reward, discount });
                    }
                });

                const dataToSave = {
                    name: form.establishmentName.value,
                    document: form.establishmentCnpjCpf.value,
                    phone: form.establishmentPhone.value,
                    email: form.establishmentEmail.value,
                    address: form.establishmentAddress.value,
                    website: form.establishmentWebsite.value,
                    welcomeMessage: form.establishmentWelcomeMessage.value,
                    logo: form.establishmentLogoBase64.value,
                    workingHours: workingHours,
                    loyaltyProgram: {
                        enabled: form.loyaltyEnabled.checked,
                        pointsPerCurrency: parseFloat(form.loyaltyPointsPerCurrency.value) || 0,
                        tiers: loyaltyTiers,
                    },
                };
                
                try {
                    await authenticatedFetch(`/api/establishments/${user.establishmentId}/details`, { method: 'PUT', body: JSON.stringify(dataToSave) }, user);
                    showNotification('Sucesso!', 'Dados do estabelecimento atualizados com sucesso.');
                    onUpdate();
                } catch (error) {
                    showNotification('Erro', `Não foi possível salvar: ${error.message}`);
                } finally {
                    setIsSaving(false);
                }
            };
            
            const handlePhotoUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        const photoPreview = document.getElementById('establishmentLogoPreview');
                        const photoBase64 = document.getElementById('establishmentLogoBase64');
                        if (photoPreview) photoPreview.src = reader.result;
                        if (photoBase64) photoBase64.value = reader.result;
                    };
                    reader.readAsDataURL(file);
                }
            };
            
            const addLoyaltyTier = () => {
                const container = document.getElementById('loyaltyTiersContainer');
                const newRow = document.createElement('div');
                newRow.className = "loyalty-tier-row grid grid-cols-[1fr_2fr_1fr_auto] items-center gap-2 mb-2";
                newRow.innerHTML = `
                    <input type="number" placeholder="Pontos" name="loyalty-points" class="w-full p-2 border rounded-md text-sm">
                    <input type="text" placeholder="Descrição do Prémio" name="loyalty-reward" class="w-full p-2 border rounded-md text-sm">
                    <input type="number" placeholder="Valor (R$)" name="loyalty-discount" class="w-full p-2 border rounded-md text-sm">
                    <button type="button" class="remove-loyalty-tier-btn bg-red-100 text-red-700 p-2 rounded-md hover:bg-red-200 text-sm">&times;</button>
                `;
                container.appendChild(newRow);
                newRow.querySelector('.remove-loyalty-tier-btn').onclick = () => newRow.remove();
            };
            
            useEffect(() => {
                if (establishmentData) {
                    const container = document.getElementById('loyaltyTiersContainer');
                    if (container) {
                        container.innerHTML = '';
                        (establishmentData.loyaltyProgram?.tiers || []).forEach(tier => {
                            const newRow = document.createElement('div');
                            newRow.className = "loyalty-tier-row grid grid-cols-[1fr_2fr_1fr_auto] items-center gap-2 mb-2";
                            newRow.innerHTML = `
                                <input type="number" placeholder="Pontos" name="loyalty-points" defaultValue={tier.points} className="w-full p-2 border rounded-md text-sm">
                                <input type="text" placeholder="Descrição do Prémio" name="loyalty-reward" defaultValue={tier.reward} className="w-full p-2 border rounded-md text-sm">
                                <input type="number" placeholder="Valor (R$)" name="loyalty-discount" defaultValue={tier.discount || 0} className="w-full p-2 border rounded-md text-sm">
                                <button type="button" onClick={(e) => e.target.closest('.loyalty-tier-row').remove()} className="remove-loyalty-tier-btn bg-red-100 text-red-700 p-2 rounded-md hover:bg-red-200 text-sm">&times;</button>
                            `;
                            container.appendChild(newRow);
                            newRow.querySelector('.remove-loyalty-tier-btn').onclick = () => newRow.remove();
                        });
                    }
                }
            }, [establishmentData]);
            
            const renderLoyaltyTiers = () => {
                if (!establishmentData?.loyaltyProgram?.tiers) return null;
                return (
                    <div id="loyaltyTiersContainer">
                        {establishmentData.loyaltyProgram.tiers.map((tier, index) => (
                            <div key={index} className="loyalty-tier-row grid grid-cols-[1fr_2fr_1fr_auto] items-center gap-2 mb-2">
                                <input type="number" placeholder="Pontos" name="loyalty-points" defaultValue={tier.points} className="w-full p-2 border rounded-md text-sm" />
                                <input type="text" placeholder="Descrição do Prémio" name="loyalty-reward" defaultValue={tier.reward} className="w-full p-2 border rounded-md text-sm" />
                                <input type="number" placeholder="Valor (R$)" name="loyalty-discount" defaultValue={tier.discount || 0} className="w-full p-2 border rounded-md text-sm" />
                                <button type="button" onClick={(e) => e.target.closest('.loyalty-tier-row').remove()} className="remove-loyalty-tier-btn bg-red-100 text-red-700 p-2 rounded-md hover:bg-red-200 text-sm">&times;</button>
                            </div>
                        ))}
                    </div>
                );
            };


            return (
                <div className="flex flex-col h-full">
                    <header className="flex-shrink-0 bg-white p-4 flex items-center shadow-md">
                        <button onClick={onBack} className="p-2 rounded-full hover:bg-gray-100 mr-2">{icons.back()}</button>
                        <h2 className="text-xl font-bold text-gray-800">Dados do Estabelecimento</h2>
                    </header>
                    {isLoading ? (
                        <div className="p-4 text-center text-gray-500">A carregar...</div>
                    ) : (
                        <main className="flex-1 overflow-y-auto p-4 space-y-4">
                            <form onSubmit={handleSave} className="bg-white p-4 rounded-xl shadow-md space-y-4">
                                <div className="space-y-4">
                                    <h3 className="text-lg font-semibold border-b pb-2">Identidade Visual</h3>
                                    <div className="flex items-center gap-4">
                                        <img id="establishmentLogoPreview" src={establishmentData?.logo || 'https://placehold.co/80x80'} alt="Logotipo do Estabelecimento" className="w-20 h-20 object-contain rounded-lg border p-1" />
                                        <div>
                                            <input type="file" id="establishmentLogoInput" ref={fileInputRef} onChange={handlePhotoUpload} className="hidden" />
                                            <input type="hidden" id="establishmentLogoBase64" name="establishmentLogoBase64" defaultValue={establishmentData?.logo || ''} />
                                            <button type="button" onClick={() => fileInputRef.current.click()} className="py-2 px-4 bg-gray-200 text-gray-700 font-semibold rounded-lg text-sm">Alterar Logotipo</button>
                                        </div>
                                    </div>
                                    <div><label className="text-sm font-medium text-gray-700 block">Mensagem de Boas-Vindas</label><input type="text" id="establishmentWelcomeMessage" name="establishmentWelcomeMessage" defaultValue={establishmentData?.welcomeMessage || ''} className="w-full p-2 border border-gray-300 rounded-md" /></div>
                                </div>
                                <div className="space-y-4">
                                    <h3 className="text-lg font-semibold border-b pb-2">Informações Gerais</h3>
                                    <div><label className="text-sm font-medium text-gray-700 block">Nome</label><input type="text" id="establishmentName" name="establishmentName" defaultValue={establishmentData?.name || ''} className="w-full p-2 border border-gray-300 rounded-md" /></div>
                                    <div><label className="text-sm font-medium text-gray-700 block">CNPJ / CPF</label><input type="text" id="establishmentCnpjCpf" name="establishmentCnpjCpf" defaultValue={establishmentData?.document || ''} className="w-full p-2 border border-gray-300 rounded-md" /></div>
                                    <div><label className="text-sm font-medium text-gray-700 block">Telefone</label><input type="tel" id="establishmentPhone" name="establishmentPhone" defaultValue={establishmentData?.phone || ''} className="w-full p-2 border border-gray-300 rounded-md" /></div>
                                    <div><label className="text-sm font-medium text-gray-700 block">E-mail</label><input type="email" id="establishmentEmail" name="establishmentEmail" defaultValue={establishmentData?.email || ''} className="w-full p-2 border border-gray-300 rounded-md" /></div>
                                    <div><label className="text-sm font-medium text-gray-700 block">Endereço</label><input type="text" id="establishmentAddress" name="establishmentAddress" defaultValue={establishmentData?.address || ''} className="w-full p-2 border border-gray-300 rounded-md" /></div>
                                    <div><label className="text-sm font-medium text-gray-700 block">Website</label><input type="url" id="establishmentWebsite" name="establishmentWebsite" defaultValue={establishmentData?.website || ''} className="w-full p-2 border border-gray-300 rounded-md" /></div>
                                </div>
                                <div className="space-y-4">
                                    <h3 className="text-lg font-semibold border-b pb-2">Programa de Fidelidade</h3>
                                    <div className="flex items-center space-x-2">
                                        <input type="checkbox" id="loyaltyEnabled" name="loyaltyEnabled" defaultChecked={establishmentData?.loyaltyProgram?.enabled || false} />
                                        <label htmlFor="loyaltyEnabled" className="text-sm">Habilitar programa</label>
                                    </div>
                                    <div>
                                        <label className="text-sm font-medium text-gray-700 block">Pontos por Real Gasto</label>
                                        <input type="number" id="loyaltyPointsPerCurrency" name="loyaltyPointsPerCurrency" defaultValue={establishmentData?.loyaltyProgram?.pointsPerCurrency || 1} className="w-full p-2 border rounded-md text-sm" />
                                    </div>
                                    <div>
                                        <h4 className="text-sm font-semibold mb-2">Prémios por Pontos</h4>
                                        <div className="grid grid-cols-[1fr_2fr_1fr_auto] items-center gap-2 mb-1 text-xs font-bold text-gray-500 px-2">
                                            <span>Pontos</span>
                                            <span>Descrição</span>
                                            <span>Valor (R$)</span>
                                            <span></span>
                                        </div>
                                        <div id="loyaltyTiersContainer">
                                            {establishmentData?.loyaltyProgram?.tiers.map((tier, index) => (
                                                <div key={index} className="loyalty-tier-row grid grid-cols-[1fr_2fr_1fr_auto] items-center gap-2 mb-2">
                                                    <input type="number" placeholder="Pontos" name="loyalty-points" defaultValue={tier.points} className="w-full p-2 border rounded-md text-sm" />
                                                    <input type="text" placeholder="Descrição do Prémio" name="loyalty-reward" defaultValue={tier.reward} className="w-full p-2 border rounded-md text-sm" />
                                                    <input type="number" placeholder="Valor (R$)" name="loyalty-discount" defaultValue={tier.discount || 0} className="w-full p-2 border rounded-md text-sm" />
                                                    <button type="button" onClick={(e) => e.target.closest('.loyalty-tier-row').remove()} className="remove-loyalty-tier-btn bg-red-100 text-red-700 p-2 rounded-md hover:bg-red-200 text-sm">&times;</button>
                                                </div>
                                            ))}
                                        </div>
                                        <button type="button" onClick={addLoyaltyTier} className="mt-2 text-sm font-semibold text-blue-600">+ Adicionar prémio</button>
                                    </div>
                                </div>
                                <div className="space-y-4">
                                    <h3 className="text-lg font-semibold border-b pb-2">Horário de Funcionamento</h3>
                                    {Object.entries(daysOfWeek).map(([dayKey, dayName]) => {
                                        const dayData = establishmentData?.workingHours?.[dayKey] || {};
                                        const isActive = dayData.active !== false;
                                        return (
                                            <div key={dayKey} className={`p-3 rounded-lg border ${isActive ? 'bg-gray-50' : 'bg-gray-100 opacity-70'}`}>
                                                <div className="flex justify-between items-center mb-2">
                                                    <span className="font-bold text-gray-800">{dayName}</span>
                                                    <label className="flex items-center cursor-pointer">
                                                        <div className="relative">
                                                            <input type="checkbox" id={`est-${dayKey}-active`} name={`est-${dayKey}-active`} defaultChecked={isActive} className="sr-only" />
                                                            <div className="toggle-bg block bg-gray-300 w-10 h-6 rounded-full"></div>
                                                        </div>
                                                    </label>
                                                </div>
                                                <div className="time-inputs space-y-2">
                                                    <div className="flex items-center gap-2"><label className="w-16">Início:</label><input type="time" id={`est-${dayKey}-start`} name={`est-${dayKey}-start`} defaultValue={dayData.start || ''} className="w-full p-1 border rounded-md text-sm" disabled={!isActive} /></div>
                                                    <div className="flex items-center gap-2"><label className="w-16">Fim:</label><input type="time" id={`est-${dayKey}-end`} name={`est-${dayKey}-end`} defaultValue={dayData.end || ''} className="w-full p-1 border rounded-md text-sm" disabled={!isActive} /></div>
                                                    <div className="flex items-center gap-2"><label className="w-16">Int. Início:</label><input type="time" id={`est-${dayKey}-breakStart`} name={`est-${dayKey}-breakStart`} defaultValue={dayData.breakStart || ''} className="w-full p-1 border rounded-md text-sm" disabled={!isActive} /></div>
                                                    <div className="flex items-center gap-2"><label className="w-16">Int. Fim:</label><input type="time" id={`est-${dayKey}-breakEnd`} name={`est-${dayKey}-breakEnd`} defaultValue={dayData.breakEnd || ''} className="w-full p-1 border rounded-md text-sm" disabled={!isActive} /></div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                                <button type="submit" disabled={isSaving} className="w-full py-2 px-4 bg-blue-600 text-white font-semibold rounded-lg shadow-lg hover:bg-blue-700 disabled:bg-gray-400">
                                    {isSaving ? 'A salvar...' : 'Salvar Alterações'}
                                </button>
                            </form>
                        </main>
                    )}
                </div>
            );
        };
        
        // --- ECRÃ: SERVIÇOS ---
        const ServicosScreen = ({ user, showNotification, onBack, onUpdate }) => {
            const [services, setServices] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [serviceToEdit, setServiceToEdit] = useState(null);
            const [confirmState, setConfirmState] = useState({ isOpen: false, serviceId: null });
            const hasEditPermission = user.role === 'owner' || user.permissions?.['servicos-section']?.edit === true;

            const fetchServices = useCallback(async () => {
                setIsLoading(true);
                try {
                    const data = await authenticatedFetch(`/api/services/${user.establishmentId}`, {}, user);
                    setServices(data);
                } catch (error) {
                    showNotification('Erro', 'Não foi possível carregar os serviços.');
                } finally {
                    setIsLoading(false);
                }
            }, [user, showNotification]);

            useEffect(() => { fetchServices(); }, [fetchServices]);

            const handleSaveService = () => {
                fetchServices();
                onUpdate(); // Gatilho de atualização para o MainScreen
            };

            const handleDeleteService = async (serviceId) => {
                try {
                    await authenticatedFetch(`/api/services/${serviceId}`, { method: 'DELETE' }, user);
                    showNotification('Sucesso!', 'Serviço apagado com sucesso.');
                    fetchServices();
                    onUpdate(); // Gatilho de atualização para o MainScreen
                } catch (error) {
                    showNotification('Erro', `Não foi possível apagar: ${error.message}`);
                } finally {
                    setConfirmState({ isOpen: false, serviceId: null });
                }
            };
            
            const ItemFormModal = ({ isOpen, onClose, onSave, itemToEdit, itemType, user, showNotification, servicesList }) => {
                if (!isOpen) return null;

                const isEditing = !!itemToEdit;
                const [name, setName] = useState(itemToEdit?.name || '');
                const [price, setPrice] = useState(itemToEdit?.price || '');
                const [duration, setDuration] = useState(itemToEdit?.duration || '');
                const [bufferTime, setBufferTime] = useState(itemToEdit?.bufferTime || '');
                const [photo, setPhoto] = useState(itemToEdit?.photo || '');
                const [isSaving, setIsSaving] = useState(false);
                const fileInputRef = useRef(null);
                
                // Adaptação: Se for Produto, o modal de serviço não deve ser usado. Simplificando a lógica para este componente.
                const isFormValid = name && (price !== '' && !isNaN(parseFloat(price))) && (duration !== '' && !isNaN(parseInt(duration)));

                const handlePhotoUpload = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onloadend = () => {
                            setPhoto(reader.result);
                        };
                        reader.readAsDataURL(file);
                    }
                };
                
                const handleSave = async () => {
                    if (!isFormValid) {
                        showNotification('Erro', 'Por favor, preencha o Nome, Preço e Duração.');
                        return;
                    }
                    
                    setIsSaving(true);
                    const itemData = {
                        name,
                        price: parseFloat(price),
                        duration: parseInt(duration),
                        bufferTime: parseInt(bufferTime) || 0,
                        photo: photo,
                        establishmentId: user.establishmentId,
                    };
                    
                    try {
                        const endpoint = isEditing ? `/api/services/${itemToEdit.id}` : `/api/services`;
                        const method = isEditing ? 'PUT' : 'POST';

                        await authenticatedFetch(endpoint, { method, body: JSON.stringify(itemData) }, user);
                        showNotification('Sucesso!', `Serviço ${isEditing ? 'atualizado' : 'criado'} com sucesso.`);
                        onSave();
                    } catch (error) {
                        showNotification('Erro', error.message);
                    } finally {
                        setIsSaving(false);
                        onClose();
                    }
                };
                
                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onClick={onClose}>
                        <div className="bg-white rounded-lg shadow-xl w-full max-w-sm m-4 flex flex-col" style={{maxHeight: '90vh'}} onClick={e => e.stopPropagation()}>
                            <div className="p-4 border-b flex justify-between items-center">
                                <h3 className="text-xl font-bold text-gray-800">{isEditing ? 'Editar Serviço' : 'Novo Serviço'}</h3>
                                <button onClick={onClose} className="text-2xl font-bold">&times;</button>
                            </div>
                            <div className="p-4 space-y-4 flex-1 overflow-y-auto">
                                <div className="flex flex-col items-center">
                                    <img src={photo || `https://placehold.co/100x100?text=Serv`} alt="Serviço" className="w-24 h-24 object-cover rounded-md border-2 border-gray-200 mb-2" />
                                    <input type="file" ref={fileInputRef} onChange={handlePhotoUpload} accept="image/*" className="hidden" />
                                    <button onClick={() => fileInputRef.current.click()} className="py-1 px-3 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 text-sm">Carregar Imagem</button>
                                </div>
                                <div><label className="text-sm font-medium text-gray-700 block">Nome</label><input type="text" value={name} onChange={e => setName(e.target.value)} className="w-full p-2 border border-gray-300 rounded-md" required /></div>
                                <div><label className="text-sm font-medium text-gray-700 block">Preço</label><input type="number" step="0.01" value={price} onChange={e => setPrice(e.target.value)} className="w-full p-2 border border-gray-300 rounded-md" required /></div>
                                <div><label className="text-sm font-medium text-gray-700 block">Duração (minutos)</label><input type="number" value={duration} onChange={e => setDuration(e.target.value)} className="w-full p-2 border border-gray-300 rounded-md" required /></div>
                                <div><label className="text-sm font-medium text-gray-700 block">Tempo Extra/Buffer (minutos)</label><input type="number" value={bufferTime} onChange={e => setBufferTime(e.target.value)} placeholder="Opcional" className="w-full p-2 border border-gray-300 rounded-md" /></div>
                            </div>
                            <div className="p-4 bg-gray-50 flex gap-4">
                                <button onClick={onClose} className="flex-1 py-2 px-4 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300">Cancelar</button>
                                <button onClick={handleSave} disabled={!isFormValid || isSaving} className="flex-1 py-2 px-4 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 disabled:bg-gray-400">
                                    {isSaving ? 'A salvar...' : 'Salvar'}
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="flex flex-col h-full">
                    <header className="flex-shrink-0 bg-white p-4 flex items-center shadow-md">
                        <button onClick={onBack} className="p-2 rounded-full hover:bg-gray-100 mr-2">{icons.back()}</button>
                        <h2 className="text-xl font-bold text-gray-800">Gerir Serviços</h2>
                    </header>
                    <main className="flex-1 overflow-y-auto p-4 space-y-4">
                        {isLoading ? <p className="text-center text-gray-500">A carregar serviços...</p> : services.length > 0 ? services.map(service => (
                            <div key={service.id} className={`bg-white p-4 rounded-xl shadow-md flex items-center justify-between transition-transform duration-200 transform hover:scale-[1.01] ${service.active ? 'border-l-4 border-blue-500' : 'border-l-4 border-gray-300 opacity-70'}`}>
                                <div className="flex items-center space-x-4 flex-1 min-w-0">
                                    <img src={service.photo || 'https://placehold.co/60x60'} alt="Serviço" className="w-12 h-12 rounded-md object-cover" />
                                    <div className="min-w-0">
                                        <p className="font-bold text-gray-800 truncate">{service.name}</p>
                                        <p className="text-sm text-green-600 font-semibold">R$ {service.price.toFixed(2)}</p>
                                    </div>
                                </div>
                                {hasEditPermission && (
                                    <div className="flex items-center space-x-2 ml-4 flex-shrink-0">
                                        <button onClick={() => { setServiceToEdit(service); setIsModalOpen(true); }} className="p-2 rounded-full hover:bg-blue-100 transition-colors">{icons.edit('rgb(59 130 246)')}</button>
                                        <button onClick={() => setConfirmState({ isOpen: true, serviceId: service.id })} className="p-2 rounded-full hover:bg-red-100 transition-colors">{icons.trash('rgb(239 68 68)')}</button>
                                    </div>
                                )}
                            </div>
                        )) : <p className="text-center text-gray-500 pt-10">Nenhum serviço encontrado. Adicione um para começar.</p>}
                    </main>
                    {hasEditPermission && (
                        <footer className="p-4">
                            <button onClick={() => { setServiceToEdit(null); setIsModalOpen(true); }} className="w-full bg-blue-600 text-white font-bold py-3 rounded-lg shadow-lg hover:bg-blue-700 transition-colors">+ Novo Serviço</button>
                        </footer>
                    )}
                    <ItemFormModal
                        isOpen={isModalOpen}
                        onClose={() => setIsModalOpen(false)}
                        onSave={handleSaveService}
                        itemToEdit={serviceToEdit}
                        itemType="service"
                        user={user}
                        showNotification={showNotification}
                        servicesList={services}
                    />
                    <ConfirmationModal
                        isOpen={confirmState.isOpen}
                        onClose={() => setConfirmState({ isOpen: false, serviceId: null })}
                        onConfirm={() => handleDeleteService(confirmState.serviceId)}
                        title="Apagar Serviço"
                        message="Tem a certeza que deseja apagar este serviço?"
                    />
                </div>
            );
        };
        
        // --- ECRÃ: PRODUTOS ---
        const ProdutosScreen = ({ user, showNotification, onBack, onUpdate }) => {
            const [products, setProducts] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [productToEdit, setProductToEdit] = useState(null);
            const [confirmState, setConfirmState] = useState({ isOpen: false, productId: null });
            const hasEditPermission = user.role === 'owner' || user.permissions?.['produtos-section']?.edit === true;

            const fetchProducts = useCallback(async () => {
                setIsLoading(true);
                try {
                    const data = await authenticatedFetch(`/api/products/${user.establishmentId}`, {}, user);
                    setProducts(data);
                } catch (error) {
                    showNotification('Erro', 'Não foi possível carregar os produtos.');
                } finally {
                    setIsLoading(false);
                }
            }, [user, showNotification]);

            useEffect(() => { fetchProducts(); }, [fetchProducts]);

            const handleSaveProduct = async () => {
                fetchProducts();
                onUpdate(); // Gatilho de atualização para o MainScreen
            };

            const handleDeleteProduct = async (productId) => {
                try {
                    await authenticatedFetch(`/api/products/${productId}`, { method: 'DELETE' }, user);
                    showNotification('Sucesso!', 'Produto apagado com sucesso.');
                    fetchProducts();
                    onUpdate(); // Gatilho de atualização para o MainScreen
                } catch (error) {
                    showNotification('Erro', `Não foi possível apagar: ${error.message}`);
                } finally {
                    setConfirmState({ isOpen: false, productId: null });
                }
            };
            
            const ItemFormModal = ({ isOpen, onClose, onSave, itemToEdit, itemType, user, showNotification }) => {
                if (!isOpen) return null;

                const isEditing = !!itemToEdit;
                const [name, setName] = useState(itemToEdit?.name || '');
                const [price, setPrice] = useState(itemToEdit?.price || '');
                const [extraField, setExtraField] = useState(itemToEdit ? (itemType === 'service' ? itemToEdit.duration : itemToEdit.currentStock) : '');
                const [photo, setPhoto] = useState(itemToEdit?.photo || '');
                const [isSaving, setIsSaving] = useState(false);
                const fileInputRef = useRef(null);
                
                const isFormValid = name && (price !== '' && !isNaN(parseFloat(price))) && (extraField !== '' && !isNaN(parseFloat(extraField)));

                const handlePhotoUpload = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onloadend = () => {
                            setPhoto(reader.result);
                        };
                        reader.readAsDataURL(file);
                    }
                };
                
                const handleSave = async () => {
                    if (!isFormValid) {
                        showNotification('Erro', 'Por favor, preencha todos os campos obrigatórios.');
                        return;
                    }
                    
                    setIsSaving(true);
                    const itemData = {
                        name,
                        price: parseFloat(price),
                        photo: photo,
                        establishmentId: user.establishmentId,
                        ...(itemType === 'service' ? { duration: parseInt(extraField) } : { currentStock: parseInt(extraField) }),
                    };
                    
                    try {
                        const endpoint = isEditing ? `/api/${itemType}s/${itemToEdit.id}` : `/api/${itemType}s`;
                        const method = isEditing ? 'PUT' : 'POST';

                        await authenticatedFetch(endpoint, { method, body: JSON.stringify(itemData) }, user);
                        showNotification('Sucesso!', `Item ${isEditing ? 'atualizado' : 'criado'} com sucesso.`);
                        onSave();
                    } catch (error) {
                        showNotification('Erro', error.message);
                    } finally {
                        setIsSaving(false);
                        onClose();
                    }
                };
                
                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onClick={onClose}>
                        <div className="bg-white rounded-lg shadow-xl w-full max-w-sm m-4 flex flex-col" style={{maxHeight: '90vh'}} onClick={e => e.stopPropagation()}>
                            <div className="p-4 border-b flex justify-between items-center">
                                <h3 className="text-xl font-bold text-gray-800">{isEditing ? 'Editar' : 'Novo'} {itemType === 'service' ? 'Serviço' : 'Produto'}</h3>
                                <button onClick={onClose} className="text-2xl font-bold">&times;</button>
                            </div>
                            <div className="p-4 space-y-4 flex-1 overflow-y-auto">
                                <div className="flex flex-col items-center">
                                    <img src={photo || `https://placehold.co/100x100?text=${itemType.charAt(0).toUpperCase()}`} alt="Item" className="w-24 h-24 object-cover rounded-md border-2 border-gray-200 mb-2" />
                                    <input type="file" ref={fileInputRef} onChange={handlePhotoUpload} accept="image/*" className="hidden" />
                                    <button onClick={() => fileInputRef.current.click()} className="py-1 px-3 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 text-sm">Carregar Imagem</button>
                                </div>
                                <div><label className="text-sm font-medium text-gray-700 block">Nome</label><input type="text" value={name} onChange={e => setName(e.target.value)} className="w-full p-2 border border-gray-300 rounded-md" /></div>
                                <div><label className="text-sm font-medium text-gray-700 block">Preço</label><input type="number" step="0.01" value={price} onChange={e => setPrice(e.target.value)} className="w-full p-2 border border-gray-300 rounded-md" /></div>
                                <div><label className="text-sm font-medium text-gray-700 block">{itemType === 'service' ? 'Duração (minutos)' : 'Stock Atual'}</label><input type="number" value={extraField} onChange={e => setExtraField(e.target.value)} className="w-full p-2 border border-gray-300 rounded-md" /></div>
                            </div>
                            <div className="p-4 bg-gray-50 flex gap-4">
                                <button onClick={onClose} className="flex-1 py-2 px-4 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300">Cancelar</button>
                                <button onClick={handleSave} disabled={!isFormValid || isSaving} className="flex-1 py-2 px-4 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 disabled:bg-gray-400">
                                    {isSaving ? 'A salvar...' : 'Salvar'}
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="flex flex-col h-full">
                    <header className="flex-shrink-0 bg-white p-4 flex items-center shadow-md">
                        <button onClick={onBack} className="p-2 rounded-full hover:bg-gray-100 mr-2">{icons.back()}</button>
                        <h2 className="text-xl font-bold text-gray-800">Gerir Produtos</h2>
                    </header>
                    <main className="flex-1 overflow-y-auto p-4 space-y-4">
                        {isLoading ? <p className="text-center text-gray-500">A carregar...</p> : products.length > 0 ? products.map(product => {
                             const stockLevel = (product.maxStock > 0) ? (product.currentStock / product.maxStock) * 100 : 0;
                             let stockColor = 'bg-green-500';
                             if (stockLevel < 50) stockColor = 'bg-yellow-500';
                             if (stockLevel < 20) stockColor = 'bg-red-500';
                             
                             return (
                                 <div key={product.id} className="bg-white p-4 rounded-xl shadow-md flex items-center justify-between transition-transform duration-200 transform hover:scale-[1.01]">
                                    <div className="flex items-center space-x-4 flex-1 min-w-0">
                                         <img src={product.photo || 'https://placehold.co/60x60'} alt="Produto" className="w-12 h-12 rounded-md object-cover" />
                                        <div className="min-w-0">
                                            <p className="font-bold text-gray-800 truncate">{product.name}</p>
                                            <p className="text-sm text-gray-600 mt-1">R$ {product.price.toFixed(2)}</p>
                                            <div className="w-full bg-gray-200 rounded-full h-1.5 mt-2">
                                                <div className={`${stockColor} h-1.5 rounded-full`} style={{ width: `${stockLevel}%` }}></div>
                                            </div>
                                            <p className="text-xs text-gray-500 mt-1">{product.currentStock} em stock</p>
                                        </div>
                                    </div>
                                    {hasEditPermission && (
                                        <div className="flex items-center space-x-2 ml-4 flex-shrink-0">
                                            <button onClick={() => { setProductToEdit(product); setIsModalOpen(true); }} className="p-2 rounded-full hover:bg-blue-100 transition-colors">{icons.edit('rgb(59 130 246)')}</button>
                                            <button onClick={() => setConfirmState({ isOpen: true, productId: product.id })} className="p-2 rounded-full hover:bg-red-100 transition-colors">{icons.trash('rgb(239 68 68)')}</button>
                                        </div>
                                    )}
                                 </div>
                             );
                        }) : <p className="text-center text-gray-500 pt-10">Nenhum produto encontrado. Adicione um para começar.</p>}
                    </main>
                    {hasEditPermission && (
                        <footer className="p-4">
                            <button onClick={() => { setProductToEdit(null); setIsModalOpen(true); }} className="w-full bg-blue-600 text-white font-bold py-3 rounded-lg shadow-lg hover:bg-blue-700 transition-colors">+ Novo Produto</button>
                        </footer>
                    )}
                    <ItemFormModal
                        isOpen={isModalOpen}
                        onClose={() => setIsModalOpen(false)}
                        onSave={handleSaveProduct}
                        itemToEdit={productToEdit}
                        itemType="product"
                        user={user}
                        showNotification={showNotification}
                    />
                    <ConfirmationModal
                        isOpen={confirmState.isOpen}
                        onClose={() => setConfirmState({ isOpen: false, productId: null })}
                        onConfirm={() => handleDeleteProduct(confirmState.productId)}
                        title="Apagar Produto"
                        message="Tem a certeza que deseja apagar este produto?"
                    />
                </div>
            );
        };
        
        // --- ECRÃ DE PROFISSIONAIS ---
        const ProfessionalsScreen = ({ user, showNotification, onBack, onUpdate }) => {
            const [professionals, setProfessionals] = useState([]);
            const [services, setServices] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [isBlockageModalOpen, setIsBlockageModalOpen] = useState(false);
            const [isBatchBlockageModalOpen, setIsBatchBlockageModalOpen] = useState(false);
            const [professionalToEdit, setProfessionalToEdit] = useState(null);
            const [professionalForBlockage, setProfessionalForBlockage] = useState(null);
            const [confirmState, setConfirmState] = useState({ isOpen: false, professionalId: null });
            const hasEditPermission = user.role === 'owner' || user.permissions?.['profissionais-section']?.edit === true;

            const fetchProfessionalsAndServices = useCallback(async () => {
                setIsLoading(true);
                try {
                    const [professionalsData, servicesData] = await Promise.all([
                        authenticatedFetch(`/api/professionals/${user.establishmentId}`, {}, user),
                        authenticatedFetch(`/api/services/${user.establishmentId}`, {}, user)
                    ]);
                    setProfessionals(professionalsData);
                    setServices(servicesData);
                } catch (error) {
                    showNotification('Erro', 'Não foi possível carregar os dados dos profissionais.');
                } finally {
                    setIsLoading(false);
                }
            }, [user, showNotification]);

            useEffect(() => { fetchProfessionalsAndServices(); }, [fetchProfessionalsAndServices]);

            const handleSaveProfessional = () => {
                fetchProfessionalsAndServices();
                setIsModalOpen(false);
                onUpdate(); // Gatilho de atualização para o MainScreen
            };

            const handleDeleteProfessional = async (professionalId) => {
                try {
                    await authenticatedFetch(`/api/professionals/${professionalId}`, { method: 'DELETE' }, user);
                    showNotification('Sucesso!', 'Profissional apagado com sucesso.');
                    fetchProfessionalsAndServices();
                    onUpdate(); // Gatilho de atualização para o MainScreen
                } catch (error) {
                    showNotification('Erro', `Não foi possível apagar: ${error.message}`);
                } finally {
                    setConfirmState({ isOpen: false, professionalId: null });
                }
            };
            
            return (
                <div className="flex flex-col h-full">
                    <header className="flex-shrink-0 bg-white p-4 flex items-center shadow-md">
                        <button onClick={onBack} className="p-2 rounded-full hover:bg-gray-100 mr-2">{icons.back()}</button>
                        <h2 className="text-xl font-bold text-gray-800">Gerir Equipa</h2>
                    </header>
                    <div className="flex flex-col sm:flex-row justify-between items-center p-4">
                        <h3 className="text-lg font-semibold text-gray-700">Profissionais</h3>
                        {hasEditPermission && (
                            <button onClick={() => setIsBatchBlockageModalOpen(true)} className="mt-2 sm:mt-0 py-2 px-4 bg-orange-500 text-white font-semibold rounded-lg shadow-md hover:bg-orange-600">
                                 Bloquear em Lote
                            </button>
                        )}
                    </div>
                    <main className="flex-1 overflow-y-auto p-4 space-y-4">
                        {isLoading ? <p className="text-center text-gray-500">A carregar...</p> : professionals.length > 0 ? professionals.map(prof => (
                            <div key={prof.id} className="bg-white p-4 rounded-xl shadow-md flex items-center justify-between transition-transform duration-200 transform hover:scale-[1.01]">
                                <div className="flex items-center space-x-4 flex-1 min-w-0">
                                    <img src={prof.photo || 'https://placehold.co/60x60'} alt="Profissional" className="w-12 h-12 rounded-full object-cover" />
                                    <div className="min-w-0">
                                        <p className="font-bold text-gray-800 truncate">{prof.name}</p>
                                        <p className="text-sm text-gray-600">{prof.specialty || 'N/A'}</p>
                                    </div>
                                </div>
                                <div className="flex items-center space-x-2 ml-4 flex-shrink-0">
                                    <button onClick={(e) => { e.stopPropagation(); setProfessionalForBlockage(prof); setIsBlockageModalOpen(true); }} className="p-2 rounded-full hover:bg-red-100 transition-colors" title="Gerir Ausências">{icons.absent('rgb(239 68 68)')}</button>
                                    {hasEditPermission && (
                                        <>
                                            <button onClick={() => { setProfessionalToEdit(prof); setIsModalOpen(true); }} className="p-2 rounded-full hover:bg-blue-100 transition-colors">{icons.edit('rgb(59 130 246)')}</button>
                                            <button onClick={() => setConfirmState({ isOpen: true, professionalId: prof.id })} className="p-2 rounded-full hover:bg-red-100 transition-colors">{icons.trash('rgb(239 68 68)')}</button>
                                        </>
                                    )}
                                </div>
                            </div>
                        )) : <p className="text-center text-gray-500 pt-10">Nenhum profissional encontrado. Adicione um para começar.</p>}
                    </main>
                    {hasEditPermission && (
                        <footer className="p-4">
                            <button onClick={() => { setProfessionalToEdit(null); setIsModalOpen(true); }} className="w-full bg-blue-600 text-white font-bold py-3 rounded-lg shadow-lg hover:bg-blue-700 transition-colors">+ Novo Profissional</button>
                        </footer>
                    )}
                    <ProfessionalFormModal
                        isOpen={isModalOpen}
                        onClose={() => setIsModalOpen(false)}
                        onSave={handleSaveProfessional}
                        professionalToEdit={professionalToEdit}
                        user={user}
                        showNotification={showNotification}
                        servicesList={services}
                    />
                    <BlockagesModal
                        isOpen={isBlockageModalOpen}
                        onClose={() => { setIsBlockageModalOpen(false); setProfessionalForBlockage(null); }}
                        professional={professionalForBlockage}
                        user={user}
                        showNotification={showNotification}
                    />
                    <BatchBlockagesModal
                        isOpen={isBatchBlockageModalOpen}
                        onClose={() => setIsBatchBlockageModalOpen(false)}
                        professionalsList={professionals}
                        user={user}
                        showNotification={showNotification}
                    />
                    <ConfirmationModal
                        isOpen={confirmState.isOpen}
                        onClose={() => setConfirmState({ isOpen: false, professionalId: null })}
                        onConfirm={() => handleDeleteProfessional(confirmState.professionalId)}
                        title="Apagar Profissional"
                        message="Tem a certeza que deseja apagar este profissional? Isso pode afetar agendamentos futuros."
                    />
                </div>
            );
        };
        
        // --- NOVO: MODAL DE FORMULÁRIO PARA PROFISSIONAIS ---
        const ProfessionalFormModal = ({ isOpen, onClose, onSave, professionalToEdit, user, showNotification, servicesList }) => {
            if (!isOpen) return null;

            const isEditing = !!professionalToEdit;
            const [name, setName] = useState(professionalToEdit?.name || '');
            const [specialty, setSpecialty] = useState(professionalToEdit?.specialty || '');
            const [photo, setPhoto] = useState(professionalToEdit?.photo || '');
            const [selectedServices, setSelectedServices] = useState(professionalToEdit?.services || []);
            const [workingHours, setWorkingHours] = useState(
                professionalToEdit?.workingHours || {
                    'monday': { active: true, start: '09:00', end: '18:00', breakStart: '12:00', breakEnd: '13:00' },
                    'tuesday': { active: true, start: '09:00', end: '18:00', breakStart: '12:00', breakEnd: '13:00' },
                    'wednesday': { active: true, start: '09:00', end: '18:00', breakStart: '12:00', breakEnd: '13:00' },
                    'thursday': { active: true, start: '09:00', end: '18:00', breakStart: '12:00', breakEnd: '13:00' },
                    'friday': { active: true, start: '09:00', end: '18:00', breakStart: '12:00', breakEnd: '13:00' },
                    'saturday': { active: false, start: '09:00', end: '13:00', breakStart: null, breakEnd: null },
                    'sunday': { active: false, start: null, end: null, breakStart: null, breakEnd: null },
                }
            );

            const [isSaving, setIsSaving] = useState(false);
            const fileInputRef = useRef(null);
            
            const isFormValid = name && specialty && selectedServices.length > 0;
            const daysOfWeek = { monday: 'Segunda', tuesday: 'Terça', wednesday: 'Quarta', thursday: 'Quinta', friday: 'Sexta', saturday: 'Sábado', sunday: 'Domingo' };


            const handlePhotoUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setPhoto(reader.result);
                    };
                    reader.readAsDataURL(file);
                }
            };
            
            const handleServiceToggle = (serviceId) => {
                setSelectedServices(prev =>
                    prev.includes(serviceId)
                        ? prev.filter(id => id !== serviceId)
                        : [...prev, serviceId]
                );
            };

            const handleWorkingHoursChange = (day, field, value) => {
                setWorkingHours(prev => ({
                    ...prev,
                    [day]: { ...prev[day], [field]: value }
                }));
            };


            const handleSave = async () => {
                if (!isFormValid) {
                    showNotification('Erro', 'Por favor, preencha todos os campos obrigatórios e selecione pelo menos um serviço.');
                    return;
                }
                
                setIsSaving(true);
                const professionalData = {
                    name, specialty, photo, services: selectedServices, establishmentId: user.establishmentId, workingHours,
                };
                
                try {
                    const endpoint = isEditing ? `/api/professionals/${professionalToEdit.id}` : `/api/professionals`;
                    const method = isEditing ? 'PUT' : 'POST';

                    await authenticatedFetch(endpoint, { method, body: JSON.stringify(professionalData) }, user);
                    showNotification('Sucesso!', `Profissional ${isEditing ? 'atualizado' : 'criado'} com sucesso.`);
                    onSave();
                } catch (error) {
                    showNotification('Erro', error.message);
                } finally {
                    setIsSaving(false);
                }
            };
            
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onClick={onClose}>
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-lg m-4 flex flex-col" style={{maxHeight: '90vh'}} onClick={e => e.stopPropagation()}>
                        <div className="p-4 border-b flex justify-between items-center">
                            <h3 className="text-xl font-bold text-gray-800">{isEditing ? 'Editar Profissional' : 'Novo Profissional'}</h3>
                            <button onClick={onClose} className="text-2xl font-bold">&times;</button>
                        </div>
                        <div className="p-4 space-y-6 flex-1 overflow-y-auto">
                            <div className="flex flex-col items-center">
                                <img src={photo || 'https://placehold.co/100x100?text=Prof'} alt="Profissional" className="w-24 h-24 object-cover rounded-full border-2 border-gray-200 mb-2" />
                                <input type="file" ref={fileInputRef} onChange={handlePhotoUpload} accept="image/*" className="hidden" />
                                <button onClick={() => fileInputRef.current.click()} className="py-1 px-3 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 text-sm">Carregar Imagem</button>
                            </div>
                            <div className="space-y-4">
                                <div><label className="text-sm font-medium text-gray-700 block">Nome</label><input type="text" value={name} onChange={e => setName(e.target.value)} className="w-full p-2 border border-gray-300 rounded-md" required /></div>
                                <div><label className="text-sm font-medium text-gray-700 block">Especialidade</label><input type="text" value={specialty} onChange={e => setSpecialty(e.target.value)} className="w-full p-2 border border-gray-300 rounded-md" required /></div>
                                <div>
                                    <label className="text-sm font-medium text-gray-700 block">Serviços que Realiza</label>
                                    <div className="space-y-1 max-h-24 overflow-y-auto p-2 border rounded-md">
                                        {servicesList.map(s => (
                                            <label key={s.id} className="flex items-center"><input type="checkbox" value={s.id} checked={selectedServices.includes(s.id)} onChange={() => handleServiceToggle(s.id)} className="mr-2" />{s.name}</label>
                                        ))}
                                    </div>
                                </div>
                            </div>
                            <div className="border-t pt-4">
                                <h3 class="font-semibold text-gray-800 mb-2">Horário de Trabalho</h3>
                                <div className="grid grid-cols-1 gap-4">
                                    {Object.entries(daysOfWeek).map(([dayKey, dayName]) => (
                                        <div key={dayKey} className={`p-3 rounded-lg border ${workingHours[dayKey]?.active ? 'bg-gray-50' : 'bg-gray-100 disabled'}`}>
                                            <div className="flex justify-between items-center mb-2">
                                                <span className="font-bold text-gray-800">{dayName}</span>
                                                <label className="flex items-center cursor-pointer">
                                                    <div className="relative">
                                                        <input type="checkbox" checked={!!workingHours[dayKey]?.active} onChange={e => handleWorkingHoursChange(dayKey, 'active', e.target.checked)} className="sr-only" />
                                                        <div className="toggle-bg block bg-gray-300 w-10 h-6 rounded-full"></div>
                                                    </div>
                                                </label>
                                            </div>
                                            <div className="time-inputs space-y-2">
                                                <div className="flex items-center gap-2"><label className="w-16 text-sm text-gray-600">Início:</label><input type="time" value={workingHours[dayKey]?.start || ''} onChange={e => handleWorkingHoursChange(dayKey, 'start', e.target.value)} className="w-full rounded-md border-gray-300 shadow-sm text-sm p-1" /></div>
                                                <div className="flex items-center gap-2"><label className="w-16 text-sm text-gray-600">Fim:</label><input type="time" value={workingHours[dayKey]?.end || ''} onChange={e => handleWorkingHoursChange(dayKey, 'end', e.target.value)} className="w-full rounded-md border-gray-300 shadow-sm text-sm p-1" /></div>
                                                <div className="flex items-center gap-2"><label className="w-16 text-sm text-gray-600">Intervalo:</label><input type="time" value={workingHours[dayKey]?.breakStart || ''} onChange={e => handleWorkingHoursChange(dayKey, 'breakStart', e.target.value)} className="w-full rounded-md border-gray-300 shadow-sm text-sm p-1" /></div>
                                                <div className="flex items-center gap-2"><label className="w-16 text-sm text-gray-600">Fim Int:</label><input type="time" value={workingHours[dayKey]?.breakEnd || ''} onChange={e => handleWorkingHoursChange(dayKey, 'breakEnd', e.target.value)} className="w-full rounded-md border-gray-300 shadow-sm text-sm p-1" /></div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                        <div className="p-4 bg-gray-50 flex gap-4">
                            <button onClick={onClose} className="flex-1 py-2 px-4 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300">Cancelar</button>
                            <button onClick={handleSave} disabled={!isFormValid || isSaving} className="flex-1 py-2 px-4 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 disabled:bg-gray-400">
                                {isSaving ? 'A salvar...' : 'Salvar'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- MODAL DE BLOQUEIOS INDIVIDUAIS ---
        const BlockagesModal = ({ isOpen, onClose, professional, user, showNotification }) => {
            if (!isOpen) return null;
            
            const [blockages, setBlockages] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [isSaving, setIsSaving] = useState(false);
            const [newBlockage, setNewBlockage] = useState({ startDate: '', endDate: '', startTime: '', endTime: '', reason: '' });

            const fetchBlockages = useCallback(async () => {
                setIsLoading(true);
                try {
                    const data = await authenticatedFetch(`/api/blockages/${user.establishmentId}?professionalId=${professional.id}`, {}, user);
                    setBlockages(data);
                } catch (error) {
                    showNotification('Erro', 'Não foi possível carregar os bloqueios.');
                } finally {
                    setIsLoading(false);
                }
            }, [professional, user, showNotification]);

            useEffect(() => {
                fetchBlockages();
            }, [fetchBlockages]);

            const handleCreateBlockage = async (e) => {
                e.preventDefault();
                setIsSaving(true);
                try {
                    const data = {
                        professionalId: professional.id,
                        establishmentId: user.establishmentId,
                        startTime: `${newBlockage.startDate}T${newBlockage.startTime}:00`,
                        endTime: `${newBlockage.endDate || newBlockage.startDate}T${newBlockage.endTime}:00`,
                        reason: newBlockage.reason,
                    };
                    await authenticatedFetch('/api/blockages', { method: 'POST', body: JSON.stringify(data) }, user);
                    setNewBlockage({ startDate: '', endDate: '', startTime: '', endTime: '', reason: '' });
                    showNotification('Sucesso!', 'Bloqueio adicionado com sucesso.');
                    fetchBlockages();
                } catch (error) {
                    showNotification('Erro', `Não foi possível criar o bloqueio: ${error.message}`);
                } finally {
                    setIsSaving(false);
                }
            };
            
            const handleDeleteBlockage = async (blockageId) => {
                if (window.confirm('Tem certeza que deseja apagar este bloqueio?')) {
                    try {
                        await authenticatedFetch(`/api/blockages/${blockageId}`, { method: 'DELETE' }, user);
                        showNotification('Sucesso!', 'Bloqueio removido.');
                        fetchBlockages();
                    } catch (error) {
                        showNotification('Erro', `Não foi possível remover o bloqueio: ${error.message}`);
                    }
                }
            };
            
            const renderBlockages = () => {
                if (isLoading) return <p className="text-center text-gray-500">A carregar bloqueios...</p>;
                if (blockages.length === 0) return <p className="text-center text-gray-500">Nenhum bloqueio encontrado.</p>;

                // Agrupa os bloqueios por motivo
                const groupedByReason = blockages.reduce((acc, b) => {
                    const reason = b.reason || 'Sem motivo';
                    if (!acc[reason]) acc[reason] = [];
                    acc[reason].push(b);
                    return acc;
                }, {});

                return Object.entries(groupedByReason).map(([reason, group]) => (
                    <div key={reason} className="bg-gray-100 rounded-lg p-3 my-2 space-y-2">
                        <div className="flex justify-between items-center pb-2 border-b border-gray-200">
                             <h4 className="font-bold text-gray-700">{reason} ({group.length})</h4>
                            {group.length > 1 && (
                                <button onClick={() => handleBatchDelete(group.map(b => b.id))} className="text-xs text-red-600 hover:text-red-800 font-semibold flex items-center gap-1">
                                    Apagar Lote {icons.trash('rgb(220 38 38)')}
                                </button>
                            )}
                        </div>
                        {group.map(b => (
                             <div key={b.id} className="bg-white p-3 rounded-md flex items-center justify-between shadow-sm">
                                <div>
                                    <p className="font-medium text-gray-800 text-sm">
                                        {new Date(b.startTime).toLocaleString('pt-BR')} - {new Date(b.endTime).toLocaleString('pt-BR')}
                                    </p>
                                </div>
                                <button onClick={() => handleDeleteBlockage(b.id)} className="p-1 rounded-full text-gray-500 hover:bg-gray-100 hover:text-red-600">{icons.trash()}</button>
                            </div>
                        ))}
                    </div>
                ));
            };
            
            const handleBatchDelete = async (ids) => {
                const confirmed = window.confirm(`Tem certeza que deseja apagar ${ids.length} bloqueios de uma vez?`);
                if (confirmed) {
                    try {
                        await authenticatedFetch(`/api/blockages/batch-delete`, { method: 'POST', body: JSON.stringify({ ids }) }, user);
                        showNotification('Sucesso!', `${ids.length} bloqueios foram removidos.`);
                        fetchBlockages();
                    } catch (error) {
                        showNotification('Erro', `Não foi possível remover os bloqueios: ${error.message}`);
                    }
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[70]" onClick={onClose}>
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-lg m-4 flex flex-col" style={{maxHeight: '90vh'}} onClick={e => e.stopPropagation()}>
                        <div className="p-4 border-b flex justify-between items-center">
                            <h3 className="text-xl font-bold text-gray-800">Ausências de {professional.name}</h3>
                            <button onClick={onClose} className="text-2xl font-bold">&times;</button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 space-y-4">
                            <div className="p-4 bg-gray-50 rounded-lg">
                                <h4 className="font-semibold text-gray-800 mb-2">Adicionar Novo Bloqueio</h4>
                                <form onSubmit={handleCreateBlockage} className="space-y-3">
                                    <div>
                                        <label className="text-sm block text-gray-600">Data de Início</label>
                                        <input type="date" value={newBlockage.startDate} onChange={e => setNewBlockage({...newBlockage, startDate: e.target.value})} className="w-full p-2 border rounded-md" required />
                                    </div>
                                    <div>
                                        <label className="text-sm block text-gray-600">Data de Fim (opcional)</label>
                                        <input type="date" value={newBlockage.endDate} onChange={e => setNewBlockage({...newBlockage, endDate: e.target.value})} className="w-full p-2 border rounded-md" />
                                    </div>
                                    <div className="flex gap-2">
                                        <div className="flex-1">
                                            <label className="text-sm block text-gray-600">Hora de Início</label>
                                            <input type="time" value={newBlockage.startTime} onChange={e => setNewBlockage({...newBlockage, startTime: e.target.value})} className="w-full p-2 border rounded-md" required />
                                        </div>
                                        <div className="flex-1">
                                            <label className="text-sm block text-gray-600">Hora de Fim</label>
                                            <input type="time" value={newBlockage.endTime} onChange={e => setNewBlockage({...newBlockage, endTime: e.target.value})} className="w-full p-2 border rounded-md" required />
                                    </div>
                                </div>
                                <div><label className="text-sm block text-gray-600">Motivo</label><input type="text" value={newBlockage.reason} onChange={e => setNewBlockage({...newBlockage, reason: e.target.value})} className="w-full p-2 border rounded-md" placeholder="Ex: Feriado, Evento" /></div>
                                <button type="submit" disabled={isSaving} className="w-full py-2 px-4 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 disabled:bg-gray-400">
                                    {isSaving ? 'A criar...' : 'Adicionar Bloqueio'}
                                </button>
                            </form>
                            </div>
                            <div className="space-y-2">{renderBlockages()}</div>
                        </div>
                    </div>
                </div>
            );
        };
        
        // --- NOVO: MODAL DE BLOQUEIOS EM LOTE ---
        const BatchBlockagesModal = ({ isOpen, onClose, professionalsList, user, showNotification }) => {
            if (!isOpen) return null;
            
            const [selectedProfs, setSelectedProfs] = useState([]);
            const [newBlockage, setNewBlockage] = useState({ startDate: '', endDate: '', startTime: '', endTime: '', reason: '' });
            const [isSaving, setIsSaving] = useState(false);

            const handleToggleProf = (profId) => {
                setSelectedProfs(prev =>
                    prev.includes(profId)
                        ? prev.filter(id => id !== profId)
                        : [...prev, profId]
                );
            };

            const handleSelectAll = (e) => {
                if (e.target.checked) {
                    setSelectedProfs(professionalsList.map(p => p.id));
                } else {
                    setSelectedProfs([]);
                }
            };

            const handleCreateBatchBlockage = async (e) => {
                 e.preventDefault();
                if (selectedProfs.length === 0) {
                    showNotification('Atenção', 'Selecione pelo menos um profissional.', 'error');
                    return;
                }
                setIsSaving(true);
                try {
                     const blockagePromises = selectedProfs.map(profId => {
                         const data = {
                             professionalId: profId,
                             establishmentId: user.establishmentId,
                             startTime: `${newBlockage.startDate}T${newBlockage.startTime}:00`,
                             endTime: `${newBlockage.endDate || newBlockage.startDate}T${newBlockage.endTime}:00`,
                             reason: newBlockage.reason,
                         };
                         return authenticatedFetch('/api/blockages', { method: 'POST', body: JSON.stringify(data) }, user);
                     });
                     await Promise.all(blockagePromises);
                     showNotification('Sucesso!', `${selectedProfs.length} bloqueios foram criados com sucesso!`);
                     onClose();
                } catch (error) {
                    showNotification('Erro', `Não foi possível criar os bloqueios: ${error.message}`);
                } finally {
                    setIsSaving(false);
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[70]" onClick={onClose}>
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-lg m-4 flex flex-col" style={{maxHeight: '90vh'}} onClick={e => e.stopPropagation()}>
                         <div className="p-4 border-b flex justify-between items-center">
                            <h3 className="text-xl font-bold text-gray-800">Bloqueio em Lote</h3>
                            <button onClick={onClose} className="text-2xl font-bold">&times;</button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 space-y-4">
                            <div>
                                <label className="flex items-center space-x-2 text-sm font-medium text-gray-700 mb-2">
                                    <input type="checkbox" onChange={handleSelectAll} checked={selectedProfs.length === professionalsList.length && professionalsList.length > 0} className="rounded" />
                                    <span>Selecionar Todos os Profissionais</span>
                                </label>
                                <div className="space-y-1 max-h-40 overflow-y-auto p-2 border rounded-md">
                                    {professionalsList.map(p => (
                                        <label key={p.id} className="flex items-center space-x-2">
                                            <input type="checkbox" value={p.id} checked={selectedProfs.includes(p.id)} onChange={() => handleToggleProf(p.id)} className="rounded" />
                                            <span>{p.name}</span>
                                        </label>
                                    ))}
                                </div>
                            </div>
                            <form onSubmit={handleCreateBatchBlockage} className="space-y-3">
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div><label className="text-sm block text-gray-600">Data de Início</label><input type="date" value={newBlockage.startDate} onChange={e => setNewBlockage({...newBlockage, startDate: e.target.value})} className="w-full p-2 border rounded-md" required /></div>
                                    <div><label for="batchBlockageEndDate" class="block text-sm font-medium text-gray-700">Data de Fim (opcional)</label><input type="date" id="batchBlockageEndDate" value={newBlockage.endDate} onChange={e => setNewBlockage({...newBlockage, endDate: e.target.value})} className="w-full p-2 border rounded-md" /></div>
                                </div>
                                <div className="flex gap-2">
                                    <div className="flex-1">
                                        <label className="text-sm block text-gray-600">Hora de Início</label>
                                        <input type="time" value={newBlockage.startTime} onChange={e => setNewBlockage({...newBlockage, startTime: e.target.value})} className="w-full p-2 border rounded-md" required />
                                    </div>
                                    <div className="flex-1">
                                        <label className="text-sm block text-gray-600">Hora de Fim</label>
                                        <input type="time" value={newBlockage.endTime} onChange={e => setNewBlockage({...newBlockage, endTime: e.target.value})} className="w-full p-2 border rounded-md" required />
                                    </div>
                                </div>
                                <div><label className="text-sm block text-gray-600">Motivo</label><input type="text" value={newBlockage.reason} onChange={e => setNewBlockage({...newBlockage, reason: e.target.value})} className="w-full p-2 border rounded-md" placeholder="Ex: Feriado, Evento" /></div>
                                <button type="submit" disabled={isSaving || selectedProfs.length === 0} className="w-full py-2 px-4 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 disabled:bg-gray-400">
                                    {isSaving ? 'A criar...' : 'Adicionar Bloqueio em Lote'}
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            );
        };

        // --- 4. COMPONENTE PRINCIPAL (ROTEADOR) ---
        const MainScreen = ({ user, onLogout, showNotification, appData, isLoading, error, refreshData }) => {
            const [activeTab, setActiveTab] = useState('Agenda');
            const [currentManagementScreen, setCurrentManagementScreen] = useState(user.role === 'employee' ? 'menu' : 'menu');
            const [selectedComandaIdFromAgenda, setSelectedComandaIdFromAgenda] = useState(null);

            const refreshAgendaData = useCallback(() => {
                refreshData();
            }, [refreshData]);


            const handleNavigateToComanda = (appointmentId) => {
                setSelectedComandaIdFromAgenda(appointmentId);
                setActiveTab('Comandas');
            };
            
            const handleComandaOpened = () => {
                setSelectedComandaIdFromAgenda(null);
            };
            
            const canViewModule = useCallback((key) => {
                 if (user.role === 'owner') return true;
                 if (user.permissions && user.permissions[`${key}-section`]) {
                     return user.permissions[`${key}-section`].view === true;
                 }
                 return false;
             }, [user.role, user.permissions]);

            const tabs = [
                { name: 'Agenda', icon: 'agenda', key: 'agenda', visible: canViewModule('agenda') },
                { name: 'Comandas', icon: 'comandas', key: 'comandas', visible: canViewModule('comandas') },
                { name: 'Relatórios', icon: 'relatorios', key: 'relatorios', visible: canViewModule('relatorios') },
                { name: 'Gestão', icon: 'gestao', key: 'gestao', visible: true },
            ].filter(tab => tab.visible);

            const handleManagementNavigation = (screen) => {
                setCurrentManagementScreen(screen);
            };

            const renderContent = () => {
                switch (activeTab) {
                    case 'Agenda': return <AgendaScreen user={user} showNotification={showNotification} appointments={appData.appointments} isLoading={isLoading} error={error} refreshData={refreshData} onNavigateToComanda={handleNavigateToComanda} />;
                    case 'Comandas': return <ComandasScreen user={user} showNotification={showNotification} refreshAgenda={refreshAgendaData} selectedComandaId={selectedComandaIdFromAgenda} onComandaOpened={handleComandaOpened} activeTab={activeTab} />;
                    case 'Relatórios': return <RelatoriosScreen user={user} showNotification={showNotification}/>;
                    case 'Gestão':
                        switch (currentManagementScreen) {
                            case 'menu':
                                return <GestaoScreen user={user} onLogout={onLogout} onNavigate={handleManagementNavigation} />;
                            case 'Servicos':
                                return <ServicosScreen user={user} showNotification={showNotification} onBack={() => setCurrentManagementScreen('menu')} onUpdate={refreshData} />;
                            case 'Produtos':
                                return <ProdutosScreen user={user} showNotification={showNotification} onBack={() => setCurrentManagementScreen('menu')} onUpdate={refreshData} />;
                            case 'Profissionais':
                                return <ProfessionalsScreen user={user} showNotification={showNotification} onBack={() => setCurrentManagementScreen('menu')} onUpdate={refreshData} />;
                            case 'Estabelecimento':
                                return <EstablishmentScreen user={user} showNotification={showNotification} onBack={() => setCurrentManagementScreen('menu')} onUpdate={refreshData} />;
                            default:
                                return <GestaoScreen user={user} onLogout={onLogout} onNavigate={handleManagementNavigation} />;
                        }
                    default: return null;
                }
            };

            return (
                <div className="h-screen w-full flex flex-col bg-gray-100 font-sans">
                    <header className="bg-white shadow-md p-4">
                        <h1 className="text-xl font-bold text-gray-900 text-center">
                            {activeTab === 'Gestão' ? (currentManagementScreen === 'menu' ? 'Gestão' : currentManagementScreen) : activeTab}
                        </h1>
                    </header>

                    <main className="flex-1 overflow-y-auto">
                        {renderContent()}
                    </main>

                    <nav className="bg-white border-t border-gray-200">
                        <div className="flex justify-around max-w-md mx-auto">
                            {tabs.map(tab => (
                                <button key={tab.name} onClick={() => { setActiveTab(tab.name); setCurrentManagementScreen('menu'); }} className="flex-1 flex flex-col items-center justify-center py-2 transition-colors">
                                    {icons[tab.icon](activeTab === tab.name ? '#3B82F6' : '#6B7280')}
                                    <span className={`text-xs mt-1 ${activeTab === tab.name ? 'text-blue-600 font-bold' : 'text-gray-500'}`}>{tab.name}</span>
                                </button>
                            ))}
                        </div>
                    </nav>
                </div>
            );
        };

        // --- 5. COMPONENTE RAIZ (APP) ---
        const App = () => {
            const [loggedInUser, setLoggedInUser] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const [notification, setNotification] = useState({ isOpen: false, title: '', message: '' });
            const [updateTrigger, setUpdateTrigger] = useState(0);

            const [appData, setAppData] = useState({ appointments: [] }); 
            const [appIsLoading, setAppIsLoading] = useState(true);
            const [appError, setAppError] = useState(null);

            const showNotification = useCallback((title, message) => {
                setNotification({ isOpen: true, title, message });
            }, []);
            
            const forceRefresh = useCallback(() => {
                setUpdateTrigger(prev => prev + 1);
            }, []);

            const refreshData = useCallback(async (date = new Date(), view = 'list', professionalId = 'all') => {
                if (!loggedInUser) return;
                setAppIsLoading(true);
                setAppError(null);
                try {
                    let startDate, endDate;
                    if (view === 'list') {
                        startDate = new Date(date);
                        startDate.setHours(0, 0, 0, 0);
                        endDate = new Date(date);
                        endDate.setHours(23, 59, 59, 999);
                    } else { // 'week' view
                        const displayDays = 3;
                        
                        startDate = new Date(date);
                        startDate.setHours(0, 0, 0, 0);

                        endDate = new Date(startDate);
                        endDate.setDate(startDate.getDate() + displayDays - 1); 
                        endDate.setHours(23, 59, 59, 999);
                    }

                    let appointmentsEndpoint = `/api/appointments/${loggedInUser.establishmentId}?startDate=${startDate.toISOString()}&endDate=${endDate.toISOString()}`;
                    
                    const canViewAll = loggedInUser.role === 'owner' || loggedInUser.permissions?.['agenda-section']?.view_all_prof === true;
                    
                    // LÓGICA DE ALÇADA: Envia o professionalId apenas se o usuário NÃO PUDER ver todos
                    const targetProfessionalId = canViewAll ? professionalId : loggedInUser.professionalId;
                    
                    if (targetProfessionalId && targetProfessionalId !== 'all') {
                        appointmentsEndpoint += `&professionalId=${targetProfessionalId}`;
                    }

                    const appointmentsData = await authenticatedFetch(appointmentsEndpoint, {}, loggedInUser);
                    
                    setAppData(prev => ({ 
                        ...prev,
                        appointments: appointmentsData
                    }));
                    
                } catch (err) {
                    setAppError('Falha ao sincronizar dados com o servidor.');
                    showNotification('Erro de Sincronização', err.message);
                } finally {
                    setAppIsLoading(false);
                }
            }, [loggedInUser, showNotification]);

            useEffect(() => {
                if (loggedInUser) {
                    refreshData();
                }
            }, [loggedInUser, refreshData, updateTrigger]);
            
            useEffect(() => {
                if (!loggedInUser) return;

                const notificationsRef = window.collection(db, 'establishments', loggedInUser.establishmentId, 'notifications');
                const q = window.query(notificationsRef, window.where("timestamp", ">=", window.Timestamp.now()), window.orderBy("timestamp", "desc"));

                const unsubscribe = window.onSnapshot(q, (snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === "added") {
                            const notification = change.doc.data();
                            
                            notifications.unshift({
                                title: notification.title,
                                message: notification.message,
                                time: notification.timestamp.toDate().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }),
                                read: false
                            });

                            showNotification(notification.message, 'info', true);
                            // NOTE: Since we are in React, we don't need to call renderNotificationPanel() or loadAgendaPage() directly here. The use of React state/props would handle the re-render. However, since the notification logic is currently outside the React context and relies on global variables (notifications), this part of the logic might need refactoring if it were a pure React app. For the purpose of maintaining the existing flow and structure, we leave it as is, knowing the agenda/comanda screens will refresh on state change/re-navigation.
                        }
                    });
                });

                return () => unsubscribe();
            }, [loggedInUser, forceRefresh, showNotification]);


            useEffect(() => {
                const unsubscribe = window.onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        try {
                            const idTokenResult = await user.getIdTokenResult(true);
                            const claims = idTokenResult.claims;
                            if ((claims.role === 'owner' || claims.role === 'employee') && claims.establishmentId) {
                                
                                let employeeData = {};
                                if (claims.role === 'employee') {
                                    const userDocRef = window.doc(db, 'users', user.uid);
                                    const userDoc = await window.getDoc(userDocRef);
                                    if (userDoc.exists()) {
                                        employeeData = userDoc.data();
                                    }
                                }

                                const userData = {
                                    name: employeeData.name || user.displayName,
                                    email: user.email,
                                    uid: user.uid,
                                    token: idTokenResult.token,
                                    establishmentId: claims.establishmentId,
                                    role: claims.role,
                                    professionalId: employeeData.professionalId || null, 
                                    permissions: employeeData.permissions || null 
                                };
                                setLoggedInUser(userData);
                            } else { await window.signOut(auth); }
                        } catch (error) {
                            console.error("Auth state error:", error);
                            await window.signOut(auth);
                        }
                    } else { setLoggedInUser(null); }
                    setIsLoading(false);
                });
                return () => unsubscribe();
            }, []);
            
            const LoginScreen = ({ onLoginSuccess }) => {
              const [email, setEmail] = useState('');
              const [password, setPassword] = useState('');
              const [isLoading, setIsLoading] = useState(false);
              const [errorMessage, setErrorMessage] = useState(null);

              const handleLogin = async () => {
                setIsLoading(true);
                setErrorMessage(null);
                try {
                    const userCredential = await window.signInWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    const idTokenResult = await user.getIdTokenResult();
                    const claims = idTokenResult.claims;

                    if ((claims.role === 'owner' || claims.role === 'employee') && claims.establishmentId) {
                        
                        let employeeData = {};
                        if (claims.role === 'employee') {
                            const userDocRef = window.doc(db, 'users', user.uid);
                            const userDoc = await window.getDoc(userDocRef);
                            if (userDoc.exists()) {
                                employeeData = userDoc.data();
                            }
                        }

                        const userData = { 
                            name: employeeData.name || user.displayName, 
                            email: user.email,
                            uid: user.uid,
                            token: await user.getIdToken(),
                            establishmentId: claims.establishmentId,
                            role: claims.role,
                            professionalId: employeeData.professionalId || null,
                            permissions: employeeData.permissions || null
                        };

                        onLoginSuccess(userData);
                    } else {
                        setErrorMessage('Acesso negado. Permissões insuficientes.');
                        await window.signOut(auth);
                    }
                } catch (error) {
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                        setErrorMessage('E-mail ou senha inválidos.');
                    } else {
                        setErrorMessage('Ocorreu um erro ao tentar entrar.');
                        console.error("Erro de login:", error);
                    }
                } finally {
                    setIsLoading(false);
                }
              };

              return (
                <div className="flex-1 bg-gray-900 h-screen flex justify-center items-center font-sans">
                  <div className="w-full max-w-md">
                    <div className="text-center mb-12 px-6">
                      <h1 className="text-3xl font-bold text-gray-50">Acesso ao Painel</h1>
                      <p className="text-base text-gray-400 mt-2">Administre o seu estabelecimento</p>
                    </div>
                    <div className="px-6">
                      <div className="mb-5">
                        <label className="text-sm font-medium text-gray-300 mb-2 block">E-mail</label>
                        <input type="email" className="bg-gray-700 text-gray-50 w-full px-4 py-3 rounded-lg text-base border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="seu@email.com" value={email} onChange={(e) => setEmail(e.target.value)} />
                      </div>
                      <div className="mb-4">
                        <label className="text-sm font-medium text-gray-300 mb-2 block">Senha</label>
                        <input type="password" className="bg-gray-700 text-gray-50 w-full px-4 py-3 rounded-lg text-base border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="••••••••" value={password} onChange={(e) => setPassword(e.target.value)} />
                      </div>
                      {errorMessage && (<p className="text-red-400 text-center mb-4 text-sm">{errorMessage}</p>)}
                      <button className={`w-full bg-blue-600 text-white font-bold py-4 rounded-lg text-base mt-4 transition-colors ${isLoading ? 'bg-blue-400' : 'hover:bg-blue-700'}`} onClick={handleLogin} disabled={isLoading}>
                        {isLoading ? (
                          <div className="flex justify-center items-center">
                            <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                            A entrar...
                          </div>
                        ) : ('Entrar')}
                      </button>
                    </div>
                  </div>
                </div>
              );
            };

            const handleLogout = useCallback(() => {
                window.signOut(auth);
                setLoggedInUser(null);
                setAppData({ appointments: [] }); 
            }, []);

            return (
                <React.Fragment>
                    {isLoading ? <LoadingScreen /> : loggedInUser ?
                        <MainScreen 
                            user={loggedInUser} 
                            onLogout={handleLogout} 
                            showNotification={showNotification}
                            appData={appData}
                            isLoading={appIsLoading}
                            error={appError}
                            refreshData={refreshData}
                        /> :
                        <LoginScreen onLoginSuccess={setLoggedInUser} />
                    }
                    <NotificationModal
                        isOpen={notification.isOpen}
                        title={notification.title}
                        message={notification.message}
                        onClose={() => setNotification({ isOpen: false, title: '', message: '' })}
                    />
                </React.Fragment>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
