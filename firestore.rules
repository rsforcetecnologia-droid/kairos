rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- FUNÇÕES AUXILIARES DE SEGURANÇA ---

    // Verifica se o usuário está logado
    function isSignedIn() {
      return request.auth != null;
    }

    // Obtém o cargo (role) do token de autenticação (Custom Claim)
    function getRole() {
      return request.auth.token.role;
    }

    // Verifica se o usuário pertence ao estabelecimento do documento alvo
    // Requer que o 'establishmentId' esteja definido nos Custom Claims do Auth
    function isMemberOf(establishmentId) {
      return isSignedIn() && request.auth.token.establishmentId == establishmentId;
    }

    // Verifica se o usuário é DONO do estabelecimento alvo
    function isOwner(establishmentId) {
      return isMemberOf(establishmentId) && getRole() == 'owner';
    }

    // Verifica se campos sensíveis foram alterados na requisição
    function isNotChangingSensitiveFields() {
      return !request.resource.data.diff(resource.data).affectedKeys()
        .hasAny(['role', 'permissions', 'establishmentId', 'subscription']);
    }

    // --- COLEÇÕES DE SISTEMA ---

    // USUÁRIOS (Correção Tópico 1: Escalada de Privilégios)
    match /users/{userId} {
      // LEITURA: O próprio usuário OU colegas do mesmo estabelecimento
      allow read: if isSignedIn() && (request.auth.uid == userId || isMemberOf(resource.data.establishmentId));
      
      // CRIAÇÃO/EXCLUSÃO: Apenas o DONO do estabelecimento
      allow create: if isSignedIn() && isMemberOf(request.resource.data.establishmentId) && getRole() == 'owner';
      allow delete: if isSignedIn() && isMemberOf(resource.data.establishmentId) && getRole() == 'owner';

      // ATUALIZAÇÃO (BLINDADA):
      // 1. O próprio usuário pode editar seus dados, MAS NÃO PODE mudar cargo, permissões ou estabelecimento.
      // 2. O Dono pode editar tudo.
      allow update: if isSignedIn() && (
        (request.auth.uid == userId && isNotChangingSensitiveFields()) 
        || 
        (isMemberOf(resource.data.establishmentId) && getRole() == 'owner')
      );
    }

    // ESTABELECIMENTOS (Proteção contra Fraude de Assinatura)
    match /establishments/{establishmentId} {
      allow get: if true; // Público para leitura (agendamento)
      
      // O Dono pode editar dados (nome, endereço), EXCETO a assinatura (subscription)
      allow update: if isOwner(establishmentId) 
                    && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['subscription']);
      
      match /notifications/{notificationId} {
        allow read: if isMemberOf(establishmentId);
        allow write: if false; // Apenas backend cria notificações
      }
    }

    // --- COLEÇÕES DE NEGÓCIO (Multitenancy Obrigatório) ---

    // FORNECEDORES
    match /suppliers/{supplierId} {
      allow create: if isSignedIn() && isMemberOf(request.resource.data.establishmentId);
      allow read, update, delete: if isSignedIn() && isMemberOf(resource.data.establishmentId);
    }

    // HISTÓRICO DE COMPRAS
    match /purchases/{purchaseId} {
      allow create: if isSignedIn() && isMemberOf(request.resource.data.establishmentId);
      allow read, update, delete: if isSignedIn() && isMemberOf(resource.data.establishmentId);
    }

    // CLIENTES
    match /clients/{clientId} {
      allow create: if isSignedIn() && isMemberOf(request.resource.data.establishmentId);
      allow read, update, delete: if isSignedIn() && isMemberOf(resource.data.establishmentId);
      
      match /loyaltyHistory/{historyId} {
        allow read: if isSignedIn() && isMemberOf(get(/databases/$(database)/documents/clients/$(clientId)).data.establishmentId);
        // Criação de histórico de fidelidade idealmente via backend, mas se for via front:
        allow create: if isSignedIn() && isMemberOf(get(/databases/$(database)/documents/clients/$(clientId)).data.establishmentId);
      }
    }

    // AGENDAMENTOS
    match /appointments/{appointmentId} {
      allow create: if true; // Permite criação pública (agendamento online)
      // Leitura/Edição restrita à equipe
      allow read, update, delete: if isSignedIn() && isMemberOf(resource.data.establishmentId);
    }

    // PRODUTOS
    match /products/{productId} {
      allow create: if isSignedIn() && isMemberOf(request.resource.data.establishmentId);
      allow read, update, delete: if isSignedIn() && isMemberOf(resource.data.establishmentId);

      match /stockHistory/{historyId} {
        allow read: if isSignedIn() && isMemberOf(resource.ancestor.data.establishmentId);
        allow create: if isSignedIn() && isMemberOf(request.resource.data.establishmentId);
      }
    }
    
    match /productCategories/{categoryId} {
      allow create: if isSignedIn() && isMemberOf(request.resource.data.establishmentId);
      allow read, update, delete: if isSignedIn() && isMemberOf(resource.data.establishmentId);
    }

    // VENDAS, CAIXA E BLOQUEIOS
    match /sales/{saleId} {
       allow create: if isSignedIn() && isMemberOf(request.resource.data.establishmentId);
       allow read, update, delete: if isSignedIn() && isMemberOf(resource.data.establishmentId);
    }
    
    match /blockages/{blockageId} {
      allow create: if isSignedIn() && isMemberOf(request.resource.data.establishmentId);
      allow read, update, delete: if isSignedIn() && isMemberOf(resource.data.establishmentId);
    }
    
    match /cashierSessions/{sessionId} {
      allow create: if isSignedIn() && isMemberOf(request.resource.data.establishmentId);
      allow read, update, delete: if isSignedIn() && isMemberOf(resource.data.establishmentId);
    }

    // SERVIÇOS E PROFISSIONAIS (Públicos para Agendamento, Protegidos na Escrita)
    match /services/{serviceId} {
      allow get: if true;
      allow list: if true; // Necessário para catálogo público
      allow create: if isSignedIn() && isMemberOf(request.resource.data.establishmentId);
      allow update, delete: if isSignedIn() && isMemberOf(resource.data.establishmentId);
    }
    
    match /professionals/{professionalId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn() && isMemberOf(request.resource.data.establishmentId);
      allow update, delete: if isSignedIn() && isMemberOf(resource.data.establishmentId);
    }

    // --- AUDITORIA (Proteção contra Logs Falsos) ---
    match /audit_logs/{logId} {
      // Permite criar log APENAS se o usuário estiver logado E o log pertencer ao seu estabelecimento
      // Idealmente, o 'authorId' no documento também deveria ser validado aqui:
      // && request.resource.data.author.uid == request.auth.uid
      allow create: if isSignedIn() && isMemberOf(request.resource.data.establishmentId);
      
      // Apenas o DONO pode ver os logs
      allow read: if isOwner(resource.data.establishmentId);
      
      // NUNCA permite editar ou apagar logs
      allow update, delete: if false;
    }
    
    // --- FINANCEIRO (Proteção Genérica) ---
    // Caso o frontend acesse diretamente o Firestore para estas coleções
    match /natures/{docId} { 
      allow read, write: if isSignedIn() && isMemberOf(resource.data.establishmentId); 
      allow create: if isSignedIn() && isMemberOf(request.resource.data.establishmentId);
    }
    match /costCenters/{docId} { 
      allow read, write: if isSignedIn() && isMemberOf(resource.data.establishmentId); 
      allow create: if isSignedIn() && isMemberOf(request.resource.data.establishmentId);
    }
    match /payables/{docId} { 
      allow read, write: if isSignedIn() && isMemberOf(resource.data.establishmentId); 
      allow create: if isSignedIn() && isMemberOf(request.resource.data.establishmentId);
    }
    match /receivables/{docId} { 
      allow read, write: if isSignedIn() && isMemberOf(resource.data.establishmentId); 
      allow create: if isSignedIn() && isMemberOf(request.resource.data.establishmentId);
    }
  }
}