import"./modulepreload-polyfill-B5Qt9EMX.js";import{initializeApp as O}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";import{getAuth as F,onAuthStateChanged as H,signOut as L,signInWithCustomToken as U}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";const R={apiKey:"AIzaSyAlJaPEW5-yOb-8wkB8EJZhAML2M2yI8Ao",authDomain:"kairos-system-us.firebaseapp.com",projectId:"kairos-system-us",storageBucket:"kairos-system-us.firebasestorage.app",messagingSenderId:"603994960586",appId:"1:603994960586:web:30d2c030eed3c55eccfa33",measurementId:"G-SVHFXKV5EC"},j=5,q=O(R),b=F(q);let k=null,C=[],I=[],p=[],E=null,r={page:1,limit:10,search:"",status:"active",plan:"all",dateRange:"all",sortBy:"createdAt",sortOrder:"desc"};const P={agenda:"Agenda / Calendário",comandas:"Comandas / PDV",relatorios:"Relatórios (Analytics)","sales-report":"Relatório de Vendas",financial:"Financeiro",servicos:"Serviços",produtos:"Produtos",suppliers:"Fornecedores",profissionais:"Profissionais",ausencias:"Ausências e Bloqueios",clientes:"Clientes",packages:"Pacotes de Serviços",commissions:"Comissões",estabelecimento:"Configurações",users:"Usuários Internos",mobileApp:"Acesso App Mobile"};H(b,async e=>{if(e){let n=!1;try{const t=await e.getIdTokenResult(!0);if(t.claims.role==="super-admin"&&(n=!0,k=await e.getIdToken(),z(),V(),J(),G(),document.getElementById("userDisplayEmail").textContent=e.email,document.body.style.display="block",await Promise.all([oe(),v(),x(),K().then(()=>u())])),!n&&(t.claims.role==="owner"||t.claims.role==="employee")){window.location.href="/";return}}catch(t){console.error("Auth error:",t)}if(!n){await L(b),window.location.href="/admin-login";return}}else window.location.href="/admin-login"});function J(){document.querySelectorAll("#logoutButton, #logoutButtonFooter").forEach(i=>i.addEventListener("click",()=>L(b)));const n=document.getElementById("establishmentForm");n&&n.addEventListener("submit",Q);const t=document.getElementById("planForm");t&&t.addEventListener("submit",ne);const s=document.getElementById("logoUploadForm");s&&s.addEventListener("submit",ae);const a=document.getElementById("logoFileInput");a&&a.addEventListener("change",i=>{const l=i.target.files[0]?.name||"Nenhum arquivo selecionado";document.getElementById("fileNameDisplay").textContent=l});const o=document.getElementById("subscriptionPlan");o&&o.addEventListener("change",T),se(),document.body.addEventListener("click",ie)}function z(){const e=document.getElementById("sidebar"),n=document.getElementById("sidebarToggle"),t=document.getElementById("main-content-wrapper"),s=document.getElementById("fixed-header"),a=o=>{e.classList.toggle("expanded",o);const i=o?"17rem":"5rem",l=o?"calc(100% - 17rem)":"calc(100% - 5rem)";t.style.marginLeft=i,t.style.width=l,s.style.marginLeft=i,s.style.width=l};n.addEventListener("click",o=>{o.preventDefault(),a(!e.classList.contains("expanded"))})}function V(){const e=document.querySelectorAll(".sidebar-link");e.forEach(n=>{n.addEventListener("click",t=>{t.preventDefault();const s=n.getAttribute("href");if(s.startsWith("#")){e.forEach(l=>l.classList.remove("active","bg-slate-800","text-white")),n.classList.add("active","bg-slate-800","text-white");const a=s.substring(1);document.querySelectorAll("main > section").forEach(l=>l.classList.add("hidden"));const o=n.querySelector(".sidebar-text");o&&(document.getElementById("pageTitle").textContent=o.textContent);const i=document.getElementById(a+"-section");i&&i.classList.remove("hidden"),a==="dashboard"&&x(),a==="establishments"&&u(),a==="trash"&&A()}else window.location.href=s})})}const $="",_=()=>({"Content-Type":"application/json",Authorization:`Bearer ${k}`});async function c(e,n={}){const t=await fetch(`${$}${e}`,{headers:_(),...n});if(!t.ok){const s=await t.json().catch(()=>({message:t.statusText}));throw new Error(s.message||"Ocorreu um erro.")}return t.status===204||t.headers.get("content-length")==="0"?null:t.json()}function G(){const e=document.getElementById("filterSearch"),n=document.getElementById("filterStatus"),t=document.getElementById("filterPlan"),s=document.getElementById("clearFiltersBtn");let a;e.addEventListener("input",o=>{clearTimeout(a),a=setTimeout(()=>{r.search=o.target.value,r.page=1,u()},500)}),[n,t].forEach(o=>{o.addEventListener("change",i=>{const l=o.id.replace("filter","").toLowerCase();r[l]=i.target.value,r.page=1,u()})}),s.addEventListener("click",()=>{e.value="",n.value="active",t.value="all",r={...r,search:"",status:"active",plan:"all",page:1},u()}),document.querySelectorAll("th[data-sort]").forEach(o=>{o.addEventListener("click",()=>{const i=o.dataset.sort;r.sortBy===i?r.sortOrder=r.sortOrder==="asc"?"desc":"asc":(r.sortBy=i,r.sortOrder="asc"),u()})})}function W(){document.querySelectorAll("th[data-sort]").forEach(e=>{const n=e.querySelector(".sort-icon");e.dataset.sort===r.sortBy?(n.textContent=r.sortOrder==="asc"?"↑":"↓",n.classList.add("text-indigo-600")):(n.textContent="↕",n.classList.remove("text-indigo-600"))})}async function K(){p.length===0&&await v();const e=document.getElementById("filterPlan");e.innerHTML='<option value="all">Todos</option>'+p.map(n=>`<option value="${n.id}">${n.name}</option>`).join("")}async function u(){const e=document.getElementById("establishmentsList");if(e){e.innerHTML=`
                <tr><td colspan="6" class="p-4">
                    <div class="animate-pulse flex space-x-4"><div class="flex-1 space-y-4 py-1"><div class="h-4 bg-slate-200 rounded w-3/4"></div><div class="space-y-2"><div class="h-4 bg-slate-200 rounded"></div></div></div></div>
                </td></tr>
            `;try{const n=new URLSearchParams({page:r.page,limit:r.limit,search:r.search,status:r.status,plan:r.plan,sortBy:r.sortBy,sortOrder:r.sortOrder}),t=await c(`/api/admin/establishments?${n.toString()}`),{data:s,pagination:a}=t;C=s,Z(s),X(a),W()}catch(n){e.innerHTML='<tr><td colspan="6" class="text-center p-4 text-red-500">Erro ao carregar dados.</td></tr>',console.error(n)}}}function Z(e){const n=document.getElementById("establishmentsList");if(!e||e.length===0){n.innerHTML='<tr><td colspan="6" class="text-center p-8 text-slate-500">Nenhum registro encontrado.</td></tr>';return}n.innerHTML=e.map(t=>{const s=t.status==="active",a=p.find(m=>m.id===t.subscription?.planId)?.name||"N/A",o=t.subscription?.expiryDate;let i="N/A",l="N/A",d="bg-slate-100 text-slate-800";if(o){const m=new Date(o._seconds?o._seconds*1e3:o);i=m.toLocaleDateString("pt-BR");const f=new Date,h=new Date(m);h.setDate(h.getDate()+j),f>h?(l="VENCIDO",d="bg-red-100 text-red-800"):f>m?(l="CARÊNCIA",d="bg-amber-100 text-amber-800"):(l="EM DIA",d="bg-emerald-100 text-emerald-800")}return`
                    <tr class="hover:bg-slate-50 transition-colors border-b border-slate-100 last:border-0">
                        <td class="px-6 py-4 cursor-pointer" data-action="edit-establishment" data-id="${t.id}">
                            <div class="text-sm font-medium text-slate-900">${t.name}</div>
                            <div class="text-xs text-slate-500 font-mono bg-slate-100 px-1.5 py-0.5 rounded inline-block mt-1">${t.urlId||t.id}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">
                            <span class="px-2.5 py-0.5 bg-indigo-50 text-indigo-700 rounded-full text-xs font-bold border border-indigo-100">${a}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${i}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2.5 py-0.5 text-xs font-bold rounded-full border border-opacity-20 ${d}">${l}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right">
                            <label class="relative inline-flex items-center cursor-pointer" data-action="toggle-status" data-id="${t.id}">
                                <input type="checkbox" class="sr-only peer" ${s?"checked":""}>
                                <div class="w-9 h-5 bg-slate-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-indigo-600"></div>
                            </label>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium flex justify-end gap-2 items-center h-full">
                            <button data-action="impersonate-establishment" data-id="${t.id}" title="Aceder Painel" class="p-1.5 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" /></svg>
                            </button>
                            <button data-action="edit-establishment" data-id="${t.id}" title="Editar" class="p-1.5 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                            </button>
                            <button data-action="delete-establishment" data-id="${t.id}" title="Lixeira" class="p-1.5 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m-7-10V4a1 1 0 00-1-1h-2a1 1 0 00-1 1v3M4 7h16" /></svg>
                            </button>
                        </td>
                    </tr>
                `}).join("")}function X(e){if(!e)return;const{total:n,page:t,limit:s,totalPages:a}=e;document.getElementById("totalItems").textContent=n,document.getElementById("pageStart").textContent=n===0?0:(t-1)*s+1,document.getElementById("pageEnd").textContent=Math.min(t*s,n);const o=document.getElementById("prevPageBtn"),i=document.getElementById("nextPageBtn");o.disabled=t<=1,i.disabled=t>=a,o.classList.toggle("opacity-50",t<=1),i.classList.toggle("opacity-50",t>=a),o.classList.toggle("cursor-not-allowed",t<=1),i.classList.toggle("cursor-not-allowed",t>=a);const l=o.cloneNode(!0),d=i.cloneNode(!0);o.parentNode.replaceChild(l,o),i.parentNode.replaceChild(d,i),l.addEventListener("click",()=>{r.page>1&&(r.page--,u())}),d.addEventListener("click",()=>{r.page<a&&(r.page++,u())})}async function x(){try{const e=await c("/api/admin/dashboard-stats");document.getElementById("kpi-mrr").textContent=`R$ ${e.kpis.mrr.toFixed(2).replace(".",",")}`,document.getElementById("kpi-active").textContent=e.kpis.activeUsers,document.getElementById("kpi-churn").textContent=`${e.kpis.churnRate}%`,document.getElementById("kpi-attention").textContent=e.attentionList.length;const n=document.getElementById("attentionListTable");e.attentionList.length>0?n.innerHTML=e.attentionList.map(t=>`
                        <tr class="hover:bg-slate-50 border-b border-slate-100 last:border-0 transition-colors">
                            <td class="p-3">
                                <div class="font-medium text-slate-800">${t.name}</div>
                                <div class="text-xs text-slate-400 font-mono">${t.id}</div>
                            </td>
                            <td class="p-3 text-right">
                                <span class="px-2 py-1 text-xs font-bold rounded-full ${t.daysLeft<0?"bg-red-100 text-red-700":"bg-amber-100 text-amber-700"}">
                                    ${t.daysLeft<0?"Vencido":`${t.daysLeft} dias`}
                                </span>
                            </td>
                        </tr>
                    `).join(""):n.innerHTML='<tr><td colspan="2" class="p-6 text-center text-slate-400 text-sm italic">Nenhuma renovação urgente pendente.</td></tr>',Y(e.kpis.newSubscribersData)}catch(e){console.error("Erro ao carregar dashboard:",e)}}function Y(e){const n=document.getElementById("growthChart").getContext("2d"),t=[];for(let s=29;s>=0;s--){const a=new Date;a.setDate(a.getDate()-s),t.push(a.toLocaleDateString("pt-BR",{day:"2-digit",month:"2-digit"}))}E&&E.destroy(),E=new Chart(n,{type:"line",data:{labels:t,datasets:[{label:"Novos Assinantes",data:e,borderColor:"#4f46e5",backgroundColor:s=>{const a=s.chart.ctx.createLinearGradient(0,0,0,300);return a.addColorStop(0,"rgba(79, 70, 229, 0.2)"),a.addColorStop(1,"rgba(79, 70, 229, 0.0)"),a},borderWidth:2,pointRadius:0,pointHoverRadius:4,tension:.4,fill:!0}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{mode:"index",intersect:!1}},scales:{y:{beginAtZero:!0,ticks:{stepSize:1},grid:{borderDash:[4,4],color:"#e2e8f0"}},x:{grid:{display:!1},ticks:{maxTicksLimit:5}}},interaction:{mode:"nearest",axis:"x",intersect:!1}}})}function T(){const e=document.getElementById("subscriptionPlan").value,n=p.find(a=>a.id===e),t=document.getElementById("modulesContainer"),s=JSON.parse(t.dataset.modules||"{}");t.innerHTML="",Object.entries(P).forEach(([a,o])=>{const i=n?.allowedModules?.[a]===!0,l=s?.[a]===!0,f=`
                    <label for="module-${a}" class="flex items-center p-2 rounded-lg border ${i?"bg-indigo-50 border-indigo-100":"bg-white border-slate-200 hover:border-indigo-300"} cursor-pointer transition-colors">
                        <div class="relative flex items-center">
                            <input type="checkbox" id="module-${a}" name="modules" value="${a}" class="sr-only" ${i||l?"checked":""} ${i?"disabled":""}>
                            <div class="toggle-bg block bg-slate-200 w-9 h-5 rounded-full"></div>
                            <div class="dot absolute left-1 top-1 bg-white w-3 h-3 rounded-full transition"></div>
                        </div>
                        <span class="ml-3 text-sm font-medium ${i?"text-indigo-700":"text-slate-600"}">${o}</span>
                        ${i?'<span class="ml-auto text-[10px] font-bold text-indigo-400 uppercase">Plano</span>':""}
                    </label>
                `;t.innerHTML+=f})}async function w(e=null){document.getElementById("establishmentForm").reset();const t=!!e,s=document.getElementById("modulesContainer");if(s.dataset.modules=JSON.stringify(e?.modules||{}),document.getElementById("access-links-container").classList.toggle("hidden",!t),t){const y=e.urlId||e.id,D=`${window.location.origin}/agendar?id=${y}`,N=`${window.location.origin}/login`;document.getElementById("schedulingLink").value=D,document.getElementById("adminLink").value=N}document.getElementById("slideOverTitle").textContent=t?"Editar Cliente":"Novo Cliente",document.getElementById("editEstablishmentId").value=e?.id||"",document.getElementById("establishmentName").value=e?.name||"";const a=e?.urlId||e?.id||"";document.getElementById("establishmentId").value=a,document.getElementById("establishmentId").disabled=!1;const o=document.getElementById("ownerEmail"),i=document.getElementById("ownerPassword"),l=document.getElementById("owner-credentials-container");o.value=e?.ownerEmail||"",t?(l.style.display="none",o.removeAttribute("required"),i.removeAttribute("required")):(l.style.display="block",o.setAttribute("required","required"),i.setAttribute("required","required"),o.disabled=!1);const d=document.getElementById("subscriptionPlan");d.innerHTML=p.map(y=>`<option value="${y.id}">${y.name}</option>`).join(""),e?.subscription?.planId?d.value=e.subscription.planId:p.length>0&&(d.value=p[0].id),T();const m=document.getElementById("establishmentSlideOver"),f=document.getElementById("slideOverBackdrop"),h=document.getElementById("slideOverPanel");m.classList.remove("hidden"),setTimeout(()=>{f.classList.remove("opacity-0"),h.classList.remove("translate-x-full"),h.classList.add("translate-x-0")},10)}function S(){const e=document.getElementById("establishmentSlideOver"),n=document.getElementById("slideOverBackdrop"),t=document.getElementById("slideOverPanel");n.classList.add("opacity-0"),t.classList.remove("translate-x-0"),t.classList.add("translate-x-full"),setTimeout(()=>{e.classList.add("hidden")},500)}async function Q(e){e.preventDefault();const n=document.getElementById("editEstablishmentId").value,t=!!n,s=document.getElementById("establishmentId").value,a={};document.querySelectorAll('input[name="modules"]').forEach(d=>{a[d.value]=d.checked});const o={establishmentId:s,name:document.getElementById("establishmentName").value,ownerEmail:document.getElementById("ownerEmail").value,modules:a};t||(o.ownerPassword=document.getElementById("ownerPassword").value);const i=document.getElementById("subscriptionPlan").value,l=document.getElementById("subscriptionExpiry").value;i&&l&&(o.subscription={planId:i,expiryDate:l});try{t?(await c(`/api/admin/establishments/${n}/modules`,{method:"PATCH",body:JSON.stringify({modules:o.modules})}),await c(`/api/admin/establishments/${n}/details`,{method:"PUT",body:JSON.stringify({name:o.name,urlId:s})}),i&&l&&await c(`/api/subscriptions/assign/${n}`,{method:"PATCH",body:JSON.stringify({planId:i,expiryDate:l})}),g("Cliente atualizado com sucesso!","success")):(await c("/api/admin/establishments",{method:"POST",body:JSON.stringify(o)}),g("Cliente criado com sucesso!","success")),S(),u(),x()}catch(d){g(`Erro: ${d.message}`,"error")}}async function A(){const e=document.getElementById("trashList");if(e){e.innerHTML='<tr><td colspan="3" class="p-6 text-center"><div class="loader mx-auto"></div></td></tr>';try{I=await c("/api/admin/establishments?includeDeleted=true"),ee()}catch{e.innerHTML='<tr><td colspan="3" class="p-6 text-center text-red-500">Erro ao carregar lixeira.</td></tr>'}}}function ee(){const e=document.getElementById("trashList");I.length>0?e.innerHTML=I.map(n=>{const t=n.deletedAt?new Date(n.deletedAt._seconds*1e3).toLocaleDateString("pt-BR"):"N/A";return`
                        <tr class="hover:bg-slate-50 border-b border-slate-100 last:border-0">
                            <td class="px-6 py-4 text-sm text-slate-900 font-medium">${n.name}</td>
                            <td class="px-6 py-4 text-sm text-slate-600">${t}</td>
                            <td class="px-6 py-4 text-right">
                                <button data-action="restore-establishment" data-id="${n.id}" class="text-emerald-600 hover:text-emerald-800 text-sm font-bold transition-colors">Restaurar</button>
                            </td>
                        </tr>
                    `}).join(""):e.innerHTML='<tr><td colspan="3" class="p-8 text-center text-slate-400 text-sm italic">A lixeira está vazia.</td></tr>'}async function v(){const e=document.getElementById("plansList");if(e)try{p=await c("/api/subscriptions/plans"),te()}catch{e.innerHTML='<div class="p-6 text-center text-red-500">Erro ao carregar planos.</div>'}}function te(){const e=document.getElementById("plansList");let n=`<div class="overflow-x-auto"><table class="w-full text-sm text-left text-slate-500">
                <thead class="text-xs text-slate-700 uppercase bg-slate-50"><tr>
                    <th class="px-6 py-3 font-bold">Nome</th>
                    <th class="px-6 py-3 font-bold">Preço</th>
                    <th class="px-6 py-3 font-bold">Limites (Prof/User)</th>
                    <th class="px-6 py-3 font-bold">Ações</th>
                </tr></thead><tbody class="divide-y divide-slate-100">`;p.length>0?p.forEach(t=>{n+=`
                        <tr class="bg-white hover:bg-slate-50 transition-colors">
                            <td class="px-6 py-4 font-bold text-slate-900">${t.name}</td>
                            <td class="px-6 py-4 text-slate-600">R$ ${t.price.toFixed(2)}</td>
                            <td class="px-6 py-4 text-slate-600">${t.maxProfessionals} / ${t.maxUsers}</td>
                            <td class="px-6 py-4 flex gap-3">
                                <button data-action="edit-plan" data-id="${t.id}" class="font-medium text-indigo-600 hover:text-indigo-800">Editar</button>
                                <button data-action="delete-plan" data-id="${t.id}" class="font-medium text-red-600 hover:text-red-800">Excluir</button>
                            </td>
                        </tr>`}):n+='<tr><td colspan="4" class="p-6 text-center text-slate-400 italic">Nenhum plano cadastrado.</td></tr>',n+="</tbody></table></div>",e.innerHTML=n}function B(e=null){document.getElementById("planForm").reset();const t=!!e;document.getElementById("planModalTitle").textContent=t?"Editar Plano":"Novo Plano",document.getElementById("editPlanId").value=e?.id||"",document.getElementById("planName").value=e?.name||"",document.getElementById("planPrice").value=e?.price||"",document.getElementById("planMaxProfessionals").value=e?.maxProfessionals||"",document.getElementById("planMaxUsers").value=e?.maxUsers||"";const s=document.getElementById("planModulesContainer");s.innerHTML=Object.entries(P).map(([o,i])=>`
                <label for="plan-module-${o}" class="flex items-center p-2 rounded border border-slate-200 hover:border-indigo-300 cursor-pointer transition-colors">
                    <input type="checkbox" id="plan-module-${o}" name="plan-modules" value="${o}" class="rounded text-indigo-600 focus:ring-indigo-500 mr-2" ${e?.allowedModules?.[o]?"checked":""}>
                    <span class="text-xs font-medium text-slate-700">${i}</span>
                </label>
            `).join("");const a=document.getElementById("planModal");a.classList.add("flex"),setTimeout(()=>a.style.opacity="1",10)}function M(){const e=document.getElementById("planModal");e.style.opacity="0",setTimeout(()=>e.classList.remove("flex"),300)}async function ne(e){e.preventDefault();const n=document.getElementById("editPlanId").value,t=!!n,s={};document.querySelectorAll('input[name="plan-modules"]').forEach(o=>{s[o.value]=o.checked});const a={name:document.getElementById("planName").value,price:parseFloat(document.getElementById("planPrice").value),maxProfessionals:parseInt(document.getElementById("planMaxProfessionals").value),maxUsers:parseInt(document.getElementById("planMaxUsers").value),allowedModules:s};try{t?(await c(`/api/subscriptions/plans/${n}`,{method:"PUT",body:JSON.stringify(a)}),g("Plano atualizado!","success")):(await c("/api/subscriptions/plans",{method:"POST",body:JSON.stringify(a)}),g("Plano criado!","success")),M(),v()}catch(o){g(`Erro: ${o.message}`,"error")}}function g(e,n="info"){const t=document.getElementById("toast-container"),s=document.createElement("div"),a={success:"bg-emerald-500",error:"bg-rose-500",info:"bg-blue-500"};s.className=`px-4 py-3 text-white font-medium text-sm rounded-lg shadow-lg ${a[n]} animate-fade-in-out flex items-center gap-2`,s.innerHTML=`<span>${e}</span>`,t.appendChild(s),setTimeout(()=>s.remove(),3e3)}async function ae(e){e.preventDefault();const n=document.getElementById("logoFileInput"),t=document.getElementById("logoUploadButton"),s=document.getElementById("logoUploadStatus"),a=n.files[0];if(a){t.disabled=!0,t.textContent="Enviando...",s.textContent="Processando...",s.className="text-sm mt-2 text-slate-500";try{const o=await b.currentUser.getIdToken(),i=new FormData;i.append("logoFile",a);const l=await fetch(`${$}/api/admin/config/logo`,{method:"POST",headers:{Authorization:`Bearer ${o}`},body:i}),d=await l.json();if(!l.ok)throw new Error(d.message||"Erro");s.textContent="Sucesso!",s.className="text-sm mt-2 text-emerald-600";const m=d.logoUrl+`?t=${new Date().getTime()}`;document.getElementById("logoUploadPreview").src=m,document.getElementById("platformLogoDisplay").src=m,document.getElementById("platformLogoDisplay").classList.remove("hidden")}catch{s.textContent="Falha no upload.",s.className="text-sm mt-2 text-rose-600"}finally{t.disabled=!1,t.textContent="Salvar"}}}function se(){const e=document.getElementById("logoFileInput"),n=document.getElementById("logoUploadPreview");e&&e.addEventListener("change",()=>{const t=e.files[0];if(t){const s=new FileReader;s.onload=a=>{n.src=a.target.result,n.classList.remove("hidden")},s.readAsDataURL(t)}})}async function oe(){try{const e=await c("/api/admin/config",{method:"GET"});if(e&&e.logoUrl){const n=document.getElementById("platformLogoDisplay");n.src=e.logoUrl,n.classList.remove("hidden")}}catch(e){console.warn("Logo load error",e)}}async function ie(e){const n=e.target.closest("[data-action]");if(!n)return;e.stopPropagation();const t=n.dataset.action,s=n.dataset.id;switch(t){case"open-create-modal":w();break;case"close-modal":S();break;case"open-plan-modal":B();break;case"close-plan-modal":M();break;case"edit-establishment":{const a=C.find(o=>o.id===s);a&&w(a);break}case"delete-establishment":{confirm("Mover para lixeira?")&&(await c(`/api/admin/establishments/${s}`,{method:"DELETE"}),g("Movido para lixeira.","success"),u(),x());break}case"restore-establishment":{await c(`/api/admin/establishments/${s}/restore`,{method:"POST"}),g("Restaurado!","success"),A(),u();break}case"impersonate-establishment":{if(confirm("Acessar painel deste cliente?")){const a=await c(`/api/admin/establishments/${s}/impersonate`,{method:"POST"});a?.token&&(await U(b,a.token),window.location.href="/")}break}case"copy-link":{document.getElementById(n.dataset.target).select(),document.execCommand("copy"),g("Link copiado!","info");break}case"edit-plan":{const a=p.find(o=>o.id===s);a&&B(a);break}case"delete-plan":{confirm("Excluir plano?")&&(await c(`/api/subscriptions/plans/${s}`,{method:"DELETE"}),g("Plano excluído.","success"),v());break}}}
