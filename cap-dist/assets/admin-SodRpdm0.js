import"./modulepreload-polyfill-B5Qt9EMX.js";import{initializeApp as H}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";import{getAuth as F,onAuthStateChanged as U,signOut as k,signInWithCustomToken as R}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";const j={apiKey:"AIzaSyBmeKlOJ_kMshsuintO0j8CXOvM9ywBMnk",authDomain:"kairos-agenda-us.firebaseapp.com",projectId:"kairos-agenda-us",storageBucket:"kairos-agenda-us.firebasestorage.app",messagingSenderId:"407358446276",appId:"1:407358446276:web:c6229ea999b56701558791"},q=5,z=H(j),h=F(z);let C=null,w=[],I=[],p=[],E=null,r={page:1,limit:10,search:"",status:"active",plan:"all",dateRange:"all",sortBy:"createdAt",sortOrder:"desc"};const P={agenda:"Agenda / Calendário",comandas:"Comandas / PDV",relatorios:"Relatórios (Analytics)","sales-report":"Relatório de Vendas",financial:"Financeiro",servicos:"Serviços",produtos:"Produtos",suppliers:"Fornecedores",profissionais:"Profissionais",ausencias:"Ausências e Bloqueios",clientes:"Clientes",packages:"Pacotes de Serviços",commissions:"Comissões",estabelecimento:"Configurações",users:"Usuários Internos",mobileApp:"Acesso App Mobile"};U(h,async e=>{if(e){let n=!1;try{const t=await e.getIdTokenResult(!0);if(t.claims.role==="super-admin"&&(n=!0,C=await e.getIdToken(),V(),_(),J(),G(),document.getElementById("userDisplayEmail").textContent=e.email,document.body.style.display="block",await Promise.all([se(),v(),x(),W().then(()=>m())])),!n&&(t.claims.role==="owner"||t.claims.role==="employee")){window.location.href="/";return}}catch(t){console.error("Auth error:",t)}if(!n){await k(h),window.location.href="/admin-login";return}}else window.location.href="/admin-login"});function J(){document.querySelectorAll("#logoutButton, #logoutButtonFooter").forEach(l=>l.addEventListener("click",()=>k(h)));const n=document.getElementById("establishmentForm");n&&n.addEventListener("submit",Q);const t=document.getElementById("planForm");t&&t.addEventListener("submit",ne);const o=document.getElementById("logoUploadForm");o&&o.addEventListener("submit",ae);const a=document.getElementById("logoFileInput");a&&a.addEventListener("change",l=>{const i=l.target.files[0]?.name||"Nenhum arquivo selecionado";document.getElementById("fileNameDisplay").textContent=i});const s=document.getElementById("subscriptionPlan");s&&s.addEventListener("change",T),oe(),document.body.addEventListener("click",le)}function V(){const e=document.getElementById("sidebar"),n=document.getElementById("sidebarToggle"),t=document.getElementById("main-content-wrapper"),o=document.getElementById("fixed-header"),a=s=>{e.classList.toggle("expanded",s);const l=s?"17rem":"5rem",i=s?"calc(100% - 17rem)":"calc(100% - 5rem)";t.style.marginLeft=l,t.style.width=i,o.style.marginLeft=l,o.style.width=i};n.addEventListener("click",s=>{s.preventDefault(),a(!e.classList.contains("expanded"))})}function _(){const e=document.querySelectorAll(".sidebar-link");e.forEach(n=>{n.addEventListener("click",t=>{t.preventDefault();const o=n.getAttribute("href");if(o.startsWith("#")){e.forEach(i=>i.classList.remove("active","bg-slate-800","text-white")),n.classList.add("active","bg-slate-800","text-white");const a=o.substring(1);document.querySelectorAll("main > section").forEach(i=>i.classList.add("hidden"));const s=n.querySelector(".sidebar-text");s&&(document.getElementById("pageTitle").textContent=s.textContent);const l=document.getElementById(a+"-section");l&&l.classList.remove("hidden"),a==="dashboard"&&x(),a==="establishments"&&m(),a==="trash"&&A()}else window.location.href=o})})}const $="",S=()=>({"Content-Type":"application/json",Authorization:`Bearer ${C}`});async function c(e,n={}){const t=await fetch(`${$}${e}`,{headers:S(),...n});if(!t.ok){const o=await t.json().catch(()=>({message:t.statusText}));throw new Error(o.message||"Ocorreu um erro.")}return t.status===204||t.headers.get("content-length")==="0"?null:t.json()}function G(){const e=document.getElementById("filterSearch"),n=document.getElementById("filterStatus"),t=document.getElementById("filterPlan"),o=document.getElementById("clearFiltersBtn");let a;e.addEventListener("input",s=>{clearTimeout(a),a=setTimeout(()=>{r.search=s.target.value,r.page=1,m()},500)}),[n,t].forEach(s=>{s.addEventListener("change",l=>{const i=s.id.replace("filter","").toLowerCase();r[i]=l.target.value,r.page=1,m()})}),o.addEventListener("click",()=>{e.value="",n.value="active",t.value="all",r={...r,search:"",status:"active",plan:"all",page:1},m()}),document.querySelectorAll("th[data-sort]").forEach(s=>{s.addEventListener("click",()=>{const l=s.dataset.sort;r.sortBy===l?r.sortOrder=r.sortOrder==="asc"?"desc":"asc":(r.sortBy=l,r.sortOrder="asc"),m()})})}function K(){document.querySelectorAll("th[data-sort]").forEach(e=>{const n=e.querySelector(".sort-icon");e.dataset.sort===r.sortBy?(n.textContent=r.sortOrder==="asc"?"↑":"↓",n.classList.add("text-indigo-600")):(n.textContent="↕",n.classList.remove("text-indigo-600"))})}async function W(){p.length===0&&await v();const e=document.getElementById("filterPlan");e.innerHTML='<option value="all">Todos</option>'+p.map(n=>`<option value="${n.id}">${n.name}</option>`).join("")}async function m(){const e=document.getElementById("establishmentsList");if(e){e.innerHTML=`
                <tr><td colspan="6" class="p-4">
                    <div class="animate-pulse flex space-x-4"><div class="flex-1 space-y-4 py-1"><div class="h-4 bg-slate-200 rounded w-3/4"></div><div class="space-y-2"><div class="h-4 bg-slate-200 rounded"></div></div></div></div>
                </td></tr>
            `;try{const n=new URLSearchParams({page:r.page,limit:r.limit,search:r.search,status:r.status,plan:r.plan,sortBy:r.sortBy,sortOrder:r.sortOrder}),t=await c(`/api/admin/establishments?${n.toString()}`),{data:o,pagination:a}=t;w=o,X(o),Y(a),K()}catch(n){e.innerHTML='<tr><td colspan="6" class="text-center p-4 text-red-500">Erro ao carregar dados.</td></tr>',console.error(n)}}}function X(e){const n=document.getElementById("establishmentsList");if(!e||e.length===0){n.innerHTML='<tr><td colspan="6" class="text-center p-8 text-slate-500">Nenhum registro encontrado.</td></tr>';return}n.innerHTML=e.map(t=>{const o=t.status==="active",a=p.find(u=>u.id===t.subscription?.planId)?.name||"N/A",s=t.subscription?.expiryDate;let l="N/A",i="N/A",d="bg-slate-100 text-slate-800";if(s){const u=new Date(s._seconds?s._seconds*1e3:s);l=u.toLocaleDateString("pt-BR");const f=new Date,b=new Date(u);b.setDate(b.getDate()+q),f>b?(i="VENCIDO",d="bg-red-100 text-red-800"):f>u?(i="CARÊNCIA",d="bg-amber-100 text-amber-800"):(i="EM DIA",d="bg-emerald-100 text-emerald-800")}return`
                    <tr class="hover:bg-slate-50 transition-colors border-b border-slate-100 last:border-0">
                        <td class="px-6 py-4 cursor-pointer" data-action="edit-establishment" data-id="${t.id}">
                            <div class="text-sm font-medium text-slate-900">${t.name}</div>
                            <div class="text-xs text-slate-500 font-mono bg-slate-100 px-1.5 py-0.5 rounded inline-block mt-1">${t.urlId||t.id}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">
                            <span class="px-2.5 py-0.5 bg-indigo-50 text-indigo-700 rounded-full text-xs font-bold border border-indigo-100">${a}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${l}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2.5 py-0.5 text-xs font-bold rounded-full border border-opacity-20 ${d}">${i}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right">
                            <label class="relative inline-flex items-center cursor-pointer" data-action="toggle-status" data-id="${t.id}">
                                <input type="checkbox" class="sr-only peer" ${o?"checked":""}>
                                <div class="w-9 h-5 bg-slate-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-indigo-600"></div>
                            </label>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium flex justify-end gap-2 items-center h-full">
                            <button data-action="impersonate-establishment" data-id="${t.id}" title="Aceder Painel" class="p-1.5 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" /></svg>
                            </button>
                            <button data-action="cancel-subscription" data-id="${t.id}" title="Cancelar Assinatura" class="p-1.5 text-slate-400 hover:text-amber-600 hover:bg-amber-50 rounded-lg transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 11l-6 6m0-6l6 6" /></svg>
                            </button>
                            <button data-action="edit-establishment" data-id="${t.id}" title="Editar" class="p-1.5 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                            </button>
                            <button data-action="delete-establishment" data-id="${t.id}" title="Lixeira" class="p-1.5 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m-7-10V4a1 1 0 00-1-1h-2a1 1 0 00-1 1v3M4 7h16" /></svg>
                            </button>
                        </td>
                    </tr>
                `}).join("")}function Y(e){if(!e)return;const{total:n,page:t,limit:o,totalPages:a}=e;document.getElementById("totalItems").textContent=n,document.getElementById("pageStart").textContent=n===0?0:(t-1)*o+1,document.getElementById("pageEnd").textContent=Math.min(t*o,n);const s=document.getElementById("prevPageBtn"),l=document.getElementById("nextPageBtn");s.disabled=t<=1,l.disabled=t>=a,s.classList.toggle("opacity-50",t<=1),l.classList.toggle("opacity-50",t>=a),s.classList.toggle("cursor-not-allowed",t<=1),l.classList.toggle("cursor-not-allowed",t>=a);const i=s.cloneNode(!0),d=l.cloneNode(!0);s.parentNode.replaceChild(i,s),l.parentNode.replaceChild(d,l),i.addEventListener("click",()=>{r.page>1&&(r.page--,m())}),d.addEventListener("click",()=>{r.page<a&&(r.page++,m())})}async function x(){try{const e=await c("/api/admin/dashboard-stats");document.getElementById("kpi-mrr").textContent=`R$ ${e.kpis.mrr.toFixed(2).replace(".",",")}`,document.getElementById("kpi-active").textContent=e.kpis.activeUsers,document.getElementById("kpi-churn").textContent=`${e.kpis.churnRate}%`,document.getElementById("kpi-attention").textContent=e.attentionList.length;const n=document.getElementById("attentionListTable");e.attentionList.length>0?n.innerHTML=e.attentionList.map(t=>`
                        <tr class="hover:bg-slate-50 border-b border-slate-100 last:border-0 transition-colors">
                            <td class="p-3">
                                <div class="font-medium text-slate-800">${t.name}</div>
                                <div class="text-xs text-slate-400 font-mono">${t.id}</div>
                            </td>
                            <td class="p-3 text-right">
                                <span class="px-2 py-1 text-xs font-bold rounded-full ${t.daysLeft<0?"bg-red-100 text-red-700":"bg-amber-100 text-amber-700"}">
                                    ${t.daysLeft<0?"Vencido":`${t.daysLeft} dias`}
                                </span>
                            </td>
                        </tr>
                    `).join(""):n.innerHTML='<tr><td colspan="2" class="p-6 text-center text-slate-400 text-sm italic">Nenhuma renovação urgente pendente.</td></tr>',Z(e.kpis.newSubscribersData)}catch(e){console.error("Erro ao carregar dashboard:",e)}}function Z(e){const n=document.getElementById("growthChart").getContext("2d"),t=[];for(let o=29;o>=0;o--){const a=new Date;a.setDate(a.getDate()-o),t.push(a.toLocaleDateString("pt-BR",{day:"2-digit",month:"2-digit"}))}E&&E.destroy(),E=new Chart(n,{type:"line",data:{labels:t,datasets:[{label:"Novos Assinantes",data:e,borderColor:"#4f46e5",backgroundColor:o=>{const a=o.chart.ctx.createLinearGradient(0,0,0,300);return a.addColorStop(0,"rgba(79, 70, 229, 0.2)"),a.addColorStop(1,"rgba(79, 70, 229, 0.0)"),a},borderWidth:2,pointRadius:0,pointHoverRadius:4,tension:.4,fill:!0}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{mode:"index",intersect:!1}},scales:{y:{beginAtZero:!0,ticks:{stepSize:1},grid:{borderDash:[4,4],color:"#e2e8f0"}},x:{grid:{display:!1},ticks:{maxTicksLimit:5}}},interaction:{mode:"nearest",axis:"x",intersect:!1}}})}function T(){const e=document.getElementById("subscriptionPlan").value,n=p.find(a=>a.id===e),t=document.getElementById("modulesContainer"),o=JSON.parse(t.dataset.modules||"{}");t.innerHTML="",Object.entries(P).forEach(([a,s])=>{const l=n?.allowedModules?.[a]===!0,i=o?.[a]===!0,f=`
                    <label for="module-${a}" class="flex items-center p-2 rounded-lg border ${l?"bg-indigo-50 border-indigo-100":"bg-white border-slate-200 hover:border-indigo-300"} cursor-pointer transition-colors">
                        <div class="relative flex items-center">
                            <input type="checkbox" id="module-${a}" name="modules" value="${a}" class="sr-only" ${l||i?"checked":""} ${l?"disabled":""}>
                            <div class="toggle-bg block bg-slate-200 w-9 h-5 rounded-full"></div>
                            <div class="dot absolute left-1 top-1 bg-white w-3 h-3 rounded-full transition"></div>
                        </div>
                        <span class="ml-3 text-sm font-medium ${l?"text-indigo-700":"text-slate-600"}">${s}</span>
                        ${l?'<span class="ml-auto text-[10px] font-bold text-indigo-400 uppercase">Plano</span>':""}
                    </label>
                `;t.innerHTML+=f})}async function B(e=null){document.getElementById("establishmentForm").reset();const t=!!e,o=document.getElementById("modulesContainer");if(o.dataset.modules=JSON.stringify(e?.modules||{}),document.getElementById("access-links-container").classList.toggle("hidden",!t),t){const y=e.urlId||e.id,N=`${window.location.origin}/agendar?id=${y}`,O=`${window.location.origin}/login`;document.getElementById("schedulingLink").value=N,document.getElementById("adminLink").value=O}document.getElementById("slideOverTitle").textContent=t?"Editar Cliente":"Novo Cliente",document.getElementById("editEstablishmentId").value=e?.id||"",document.getElementById("establishmentName").value=e?.name||"";const a=e?.urlId||e?.id||"";document.getElementById("establishmentId").value=a,document.getElementById("establishmentId").disabled=!1;const s=document.getElementById("ownerEmail"),l=document.getElementById("ownerPassword"),i=document.getElementById("owner-credentials-container");s.value=e?.ownerEmail||"",t?(i.style.display="none",s.removeAttribute("required"),l.removeAttribute("required")):(i.style.display="block",s.setAttribute("required","required"),l.setAttribute("required","required"),s.disabled=!1);const d=document.getElementById("subscriptionPlan");d.innerHTML=p.map(y=>`<option value="${y.id}">${y.name}</option>`).join(""),e?.subscription?.planId?d.value=e.subscription.planId:p.length>0&&(d.value=p[0].id),T();const u=document.getElementById("establishmentSlideOver"),f=document.getElementById("slideOverBackdrop"),b=document.getElementById("slideOverPanel");u.classList.remove("hidden"),setTimeout(()=>{f.classList.remove("opacity-0"),b.classList.remove("translate-x-full"),b.classList.add("translate-x-0")},10)}function M(){const e=document.getElementById("establishmentSlideOver"),n=document.getElementById("slideOverBackdrop"),t=document.getElementById("slideOverPanel");n.classList.add("opacity-0"),t.classList.remove("translate-x-0"),t.classList.add("translate-x-full"),setTimeout(()=>{e.classList.add("hidden")},500)}async function Q(e){e.preventDefault();const n=document.getElementById("editEstablishmentId").value,t=!!n,o=document.getElementById("establishmentId").value,a={};document.querySelectorAll('input[name="modules"]').forEach(d=>{a[d.value]=d.checked});const s={establishmentId:o,name:document.getElementById("establishmentName").value,ownerEmail:document.getElementById("ownerEmail").value,modules:a};t||(s.ownerPassword=document.getElementById("ownerPassword").value);const l=document.getElementById("subscriptionPlan").value,i=document.getElementById("subscriptionExpiry").value;l&&i&&(s.subscription={planId:l,expiryDate:i});try{t?(await c(`/api/admin/establishments/${n}/modules`,{method:"PATCH",body:JSON.stringify({modules:s.modules})}),await c(`/api/admin/establishments/${n}/details`,{method:"PUT",body:JSON.stringify({name:s.name,urlId:o})}),l&&i&&await c(`/api/subscriptions/assign/${n}`,{method:"PATCH",body:JSON.stringify({planId:l,expiryDate:i})}),g("Cliente atualizado com sucesso!","success")):(await c("/api/admin/establishments",{method:"POST",body:JSON.stringify(s)}),g("Cliente criado com sucesso!","success")),M(),m(),x()}catch(d){g(`Erro: ${d.message}`,"error")}}async function A(){const e=document.getElementById("trashList");if(e){e.innerHTML='<tr><td colspan="3" class="p-6 text-center"><div class="loader mx-auto"></div></td></tr>';try{I=await c("/api/admin/establishments?includeDeleted=true"),ee()}catch{e.innerHTML='<tr><td colspan="3" class="p-6 text-center text-red-500">Erro ao carregar lixeira.</td></tr>'}}}function ee(){const e=document.getElementById("trashList");I.length>0?e.innerHTML=I.map(n=>{const t=n.deletedAt?new Date(n.deletedAt._seconds*1e3).toLocaleDateString("pt-BR"):"N/A";return`
                        <tr class="hover:bg-slate-50 border-b border-slate-100 last:border-0">
                            <td class="px-6 py-4 text-sm text-slate-900 font-medium">${n.name}</td>
                            <td class="px-6 py-4 text-sm text-slate-600">${t}</td>
                            <td class="px-6 py-4 text-right">
                                <button data-action="restore-establishment" data-id="${n.id}" class="text-emerald-600 hover:text-emerald-800 text-sm font-bold transition-colors">Restaurar</button>
                            </td>
                        </tr>
                    `}).join(""):e.innerHTML='<tr><td colspan="3" class="p-8 text-center text-slate-400 text-sm italic">A lixeira está vazia.</td></tr>'}async function v(){const e=document.getElementById("plansList");if(e)try{p=await c("/api/subscriptions/plans"),te()}catch{e.innerHTML='<div class="p-6 text-center text-red-500">Erro ao carregar planos.</div>'}}function te(){const e=document.getElementById("plansList");let n=`<div class="overflow-x-auto"><table class="w-full text-sm text-left text-slate-500">
                <thead class="text-xs text-slate-700 uppercase bg-slate-50"><tr>
                    <th class="px-6 py-3 font-bold">Nome</th>
                    <th class="px-6 py-3 font-bold">Preço</th>
                    <th class="px-6 py-3 font-bold">Limites (Prof/User)</th>
                    <th class="px-6 py-3 font-bold">Ações</th>
                </tr></thead><tbody class="divide-y divide-slate-100">`;p.length>0?p.forEach(t=>{n+=`
                        <tr class="bg-white hover:bg-slate-50 transition-colors">
                            <td class="px-6 py-4 font-bold text-slate-900">${t.name}</td>
                            <td class="px-6 py-4 text-slate-600">R$ ${t.price.toFixed(2)}</td>
                            <td class="px-6 py-4 text-slate-600">${t.maxProfessionals} / ${t.maxUsers}</td>
                            <td class="px-6 py-4 flex gap-3">
                                <button data-action="edit-plan" data-id="${t.id}" class="font-medium text-indigo-600 hover:text-indigo-800">Editar</button>
                                <button data-action="delete-plan" data-id="${t.id}" class="font-medium text-red-600 hover:text-red-800">Excluir</button>
                            </td>
                        </tr>`}):n+='<tr><td colspan="4" class="p-6 text-center text-slate-400 italic">Nenhum plano cadastrado.</td></tr>',n+="</tbody></table></div>",e.innerHTML=n}function L(e=null){document.getElementById("planForm").reset();const t=!!e;document.getElementById("planModalTitle").textContent=t?"Editar Plano":"Novo Plano",document.getElementById("editPlanId").value=e?.id||"",document.getElementById("planName").value=e?.name||"",document.getElementById("planPrice").value=e?.price||"",document.getElementById("planMaxProfessionals").value=e?.maxProfessionals||"",document.getElementById("planMaxUsers").value=e?.maxUsers||"";const o=document.getElementById("planModulesContainer");o.innerHTML=Object.entries(P).map(([s,l])=>`
                <label for="plan-module-${s}" class="flex items-center p-2 rounded border border-slate-200 hover:border-indigo-300 cursor-pointer transition-colors">
                    <input type="checkbox" id="plan-module-${s}" name="plan-modules" value="${s}" class="rounded text-indigo-600 focus:ring-indigo-500 mr-2" ${e?.allowedModules?.[s]?"checked":""}>
                    <span class="text-xs font-medium text-slate-700">${l}</span>
                </label>
            `).join("");const a=document.getElementById("planModal");a.classList.add("flex"),setTimeout(()=>a.style.opacity="1",10)}function D(){const e=document.getElementById("planModal");e.style.opacity="0",setTimeout(()=>e.classList.remove("flex"),300)}async function ne(e){e.preventDefault();const n=document.getElementById("editPlanId").value,t=!!n,o={};document.querySelectorAll('input[name="plan-modules"]').forEach(s=>{o[s.value]=s.checked});const a={name:document.getElementById("planName").value,price:parseFloat(document.getElementById("planPrice").value),maxProfessionals:parseInt(document.getElementById("planMaxProfessionals").value),maxUsers:parseInt(document.getElementById("planMaxUsers").value),allowedModules:o};try{t?(await c(`/api/subscriptions/plans/${n}`,{method:"PUT",body:JSON.stringify(a)}),g("Plano atualizado!","success")):(await c("/api/subscriptions/plans",{method:"POST",body:JSON.stringify(a)}),g("Plano criado!","success")),D(),v()}catch(s){g(`Erro: ${s.message}`,"error")}}function g(e,n="info"){const t=document.getElementById("toast-container"),o=document.createElement("div"),a={success:"bg-emerald-500",error:"bg-rose-500",info:"bg-blue-500"};o.className=`px-4 py-3 text-white font-medium text-sm rounded-lg shadow-lg ${a[n]} animate-fade-in-out flex items-center gap-2`,o.innerHTML=`<span>${e}</span>`,t.appendChild(o),setTimeout(()=>o.remove(),3e3)}async function ae(e){e.preventDefault();const n=document.getElementById("logoFileInput"),t=document.getElementById("logoUploadButton"),o=document.getElementById("logoUploadStatus"),a=n.files[0];if(a){t.disabled=!0,t.textContent="Enviando...",o.textContent="Processando...",o.className="text-sm mt-2 text-slate-500";try{const s=await h.currentUser.getIdToken(),l=new FormData;l.append("logoFile",a);const i=await fetch(`${$}/api/admin/config/logo`,{method:"POST",headers:{Authorization:`Bearer ${s}`},body:l}),d=await i.json();if(!i.ok)throw new Error(d.message||"Erro");o.textContent="Sucesso!",o.className="text-sm mt-2 text-emerald-600";const u=d.logoUrl+`?t=${new Date().getTime()}`;document.getElementById("logoUploadPreview").src=u,document.getElementById("platformLogoDisplay").src=u,document.getElementById("platformLogoDisplay").classList.remove("hidden")}catch{o.textContent="Falha no upload.",o.className="text-sm mt-2 text-rose-600"}finally{t.disabled=!1,t.textContent="Salvar"}}}function oe(){const e=document.getElementById("logoFileInput"),n=document.getElementById("logoUploadPreview");e&&e.addEventListener("change",()=>{const t=e.files[0];if(t){const o=new FileReader;o.onload=a=>{n.src=a.target.result,n.classList.remove("hidden")},o.readAsDataURL(t)}})}async function se(){try{const e=await c("/api/admin/config",{method:"GET"});if(e&&e.logoUrl){const n=document.getElementById("platformLogoDisplay");n.src=e.logoUrl,n.classList.remove("hidden")}}catch(e){console.warn("Logo load error",e)}}window.openCancelModal=function(e,n){document.getElementById("cancel-estab-id").value=e,document.getElementById("cancel-estab-name").innerText=`Estabelecimento: ${n}`;const t=document.querySelector('input[name="cancelMode"][value="period_end"]');t&&(t.checked=!0),toggleDateInput(!1),document.getElementById("cancelCustomDate").value="",document.getElementById("cancelSubModal").style.display="flex"};window.closeCancelModal=function(){document.getElementById("cancelSubModal").style.display="none"};window.toggleDateInput=function(e){const n=document.getElementById("date-input-container");n&&(n.style.display=e?"block":"none")};window.confirmCancellation=async function(){const e=document.getElementById("cancel-estab-id").value,n=document.querySelector('input[name="cancelMode"]:checked').value,t=document.getElementById("cancelCustomDate").value,o=document.querySelector('#cancelSubModal button[onclick="confirmCancellation()"]');if(n==="custom_date"&&!t){alert("Por favor, selecione uma data limite.");return}if(confirm("Tem certeza que deseja programar este cancelamento?"))try{o.disabled=!0,o.textContent="Processando...";const a=await fetch("/api/admin/cancel-subscription",{method:"POST",headers:S(),body:JSON.stringify({establishmentId:e,mode:n,date:t})}),s=await a.json();a.ok?(alert("Sucesso: "+s.message),closeCancelModal(),m()):alert("Erro: "+s.message)}catch(a){alert("Erro de conexão: "+a.message)}finally{o.disabled=!1,o.textContent="Confirmar Cancelamento"}};async function le(e){const n=e.target.closest("[data-action]");if(!n)return;e.stopPropagation();const t=n.dataset.action,o=n.dataset.id;switch(t){case"open-create-modal":B();break;case"close-modal":M();break;case"open-plan-modal":L();break;case"close-plan-modal":D();break;case"edit-establishment":{const a=w.find(s=>s.id===o);a&&B(a);break}case"cancel-subscription":{const a=w.find(s=>s.id===o);a&&window.openCancelModal(o,a.name);break}case"delete-establishment":{confirm("Mover para lixeira?")&&(await c(`/api/admin/establishments/${o}`,{method:"DELETE"}),g("Movido para lixeira.","success"),m(),x());break}case"restore-establishment":{await c(`/api/admin/establishments/${o}/restore`,{method:"POST"}),g("Restaurado!","success"),A(),m();break}case"impersonate-establishment":{if(confirm("Acessar painel deste cliente?")){const a=await c(`/api/admin/establishments/${o}/impersonate`,{method:"POST"});a?.token&&(await R(h,a.token),window.location.href="/")}break}case"copy-link":{document.getElementById(n.dataset.target).select(),document.execCommand("copy"),g("Link copiado!","info");break}case"edit-plan":{const a=p.find(s=>s.id===o);a&&L(a);break}case"delete-plan":{confirm("Excluir plano?")&&(await c(`/api/subscriptions/plans/${o}`,{method:"DELETE"}),g("Plano excluído.","success"),v());break}}}
