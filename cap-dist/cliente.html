<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Agendamento Online</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Cores Padrão (serão sobrescritas pelo JS se houver personalização) */
            --theme-main: #4f46e5;
            --theme-contrast: #ffffff;
            --content-text-color: #111827; /* Cor escura padrão para textos */
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
            min-height: 100vh;
            
            /* Necessário para posicionar o overlay corretamente */
            position: relative;
        }

        /* --- AJUSTE VISUAL: Camada Translúcida (Overlay) --- */
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* Cor de fundo base com 85% de opacidade para suavizar a imagem */
            background-color: rgba(0, 0, 0, 0.40); 
            /* Desfoque suave para melhorar a leitura */
            backdrop-filter: blur(3px); 
            z-index: 0; /* Fica atrás do conteúdo */
            pointer-events: none; /* Permite clicar através da camada */
        }

        /* Garante que o painel de agendamento fique ACIMA da camada translúcida */
        #booking-view {
            position: relative;
            z-index: 1;
        }

        /* Classes Utilitárias de Tema */
        .theme-bg { background-color: var(--theme-main); color: var(--theme-contrast); }
        .theme-text { color: var(--theme-main); }
        .theme-border { border-color: var(--theme-main); }
        .theme-ring:focus { --tw-ring-color: var(--theme-main); }
        
        /* Classe para a Cor do Texto Personalizada (Nome do Salão) */
        .custom-text-color { color: var(--content-text-color); }

        /* Painel de Vidro (Conteúdo Principal) - Fundo claro translúcido */
        .glass-panel {
            background-color: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }
        
        /* Painel de Vidro Escuro (Barra Superior) - Contraste para o logo */
        .glass-panel-dark {
            background-color: rgba(17, 24, 39, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* Transições e Interações */
        .service-card, .professional-card, .time-slot-btn { transition: all 0.2s ease; }
        
        .service-card.selected, .professional-card.selected {
            border-color: var(--theme-main);
            background-color: #f8fafc;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .service-card.selected .check-icon, .professional-card.selected .check-icon { 
            opacity: 1; 
            transform: scale(1); 
        }
        
        .time-slot-selected { 
            background-color: var(--theme-main) !important; 
            color: var(--theme-contrast) !important; 
            font-weight: 600; 
            transform: scale(1.05); 
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        .hidden { display: none; }
        
        /* Loader simples para feedback visual */
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--theme-main);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div class="fixed top-0 left-0 right-0 z-40 px-4 py-3">
        <div class="glass-panel-dark rounded-full px-4 py-2 flex justify-between items-center max-w-2xl mx-auto">
             <a href="/landing.html" class="flex items-center gap-2 hover:opacity-80 transition-opacity">
                <img src="/assets/logo_kairos-qvW0sW2r.png" alt="Kairos" class="h-6 w-auto opacity-90">
            </a>
            
            <button id="myAppointmentsBtn" class="text-xs font-semibold text-white bg-white/10 hover:bg-white/20 border border-white/10 px-3 py-1.5 rounded-full transition-colors flex items-center gap-1.5">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Meus Agendamentos
            </button>
        </div>
    </div>

    <div id="booking-view" class="pt-20 pb-10 px-3 min-h-screen flex flex-col items-center justify-start">
        
        <header class="w-full max-w-lg mb-6 text-center fade-in"> 
            <div class="relative inline-block mb-3">
                <div id="logo-container" class="h-20 w-20 rounded-full bg-white p-1 shadow-lg mx-auto overflow-hidden">
                    <img id="establishmentLogo" src="" alt="Logo" class="h-full w-full rounded-full object-cover opacity-0 transition-opacity duration-500">
                </div>
            </div>
            <h1 id="establishmentName" class="text-2xl font-bold custom-text-color drop-shadow-sm mb-1 leading-tight">
                <div class="h-8 bg-gray-200/50 rounded w-48 mx-auto animate-pulse"></div>
            </h1>
            <p id="establishmentWelcomeMessage" class="text-sm custom-text-color font-medium px-4 opacity-90">
                <div class="h-4 bg-gray-200/50 rounded w-32 mx-auto animate-pulse mt-2"></div>
            </p>
        </header>

        <main class="w-full max-w-lg glass-panel rounded-2xl p-4 sm:p-6 shadow-xl relative min-h-[400px]">
            
            <div class="absolute top-0 left-0 right-0 h-1 bg-gray-100 rounded-t-2xl overflow-hidden">
                <div id="progress-bar" class="h-full theme-bg transition-all duration-500 w-1/4"></div>
            </div>

            <section id="services-section" class="fade-in">
                <h2 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
                    <span class="flex items-center justify-center w-6 h-6 theme-bg text-xs rounded-full theme-text-contrast">1</span>
                    Qual serviço deseja?
                </h2>
                <div id="services-container" class="space-y-2">
                    <p class="text-center text-gray-500 text-sm py-4">A carregar serviços...</p>
                </div>
            </section>

            <section id="professionals-section" class="hidden">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                        <span class="flex items-center justify-center w-6 h-6 theme-bg text-xs rounded-full theme-text-contrast">2</span>
                        Com quem?
                    </h2>
                    <button id="professionals-back-btn" class="text-xs text-gray-500 hover:text-gray-800 underline">Voltar</button>
                </div>
                <div id="professionals-container" class="grid grid-cols-3 gap-2">
                    <p class="col-span-full text-center text-gray-500 text-sm">A carregar...</p>
                </div>
            </section>

            <section id="schedule-section" class="hidden">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                        <span class="flex items-center justify-center w-6 h-6 theme-bg text-xs rounded-full theme-text-contrast">3</span>
                        Quando?
                    </h2>
                    <button id="schedule-back-btn" class="text-xs text-gray-500 hover:text-gray-800 underline">Voltar</button>
                </div>
                
                <div class="bg-gray-50 rounded-lg p-2 mb-4 border border-gray-100">
                    <div class="flex justify-between items-center mb-2">
                        <button id="prev-week-btn" class="p-1 text-gray-400 hover:text-gray-700">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                        </button>
                        <h3 id="month-year-display" class="text-sm font-semibold text-gray-700 capitalize"></h3>
                        <button id="next-week-btn" class="p-1 text-gray-400 hover:text-gray-700">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                        </button>
                    </div>
                    <div id="week-container" class="grid grid-cols-7 gap-1"></div>
                </div>

                <div id="time-slots-container" class="space-y-4">
                    <div>
                        <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wide mb-2">Manhã</h4>
                        <div id="morning-slots" class="grid grid-cols-4 gap-2"></div>
                    </div>
                    <div>
                        <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wide mb-2">Tarde</h4>
                        <div id="afternoon-slots" class="grid grid-cols-4 gap-2"></div>
                    </div>
                </div>
            </section>

            <section id="confirmation-section" class="hidden">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                        <span class="flex items-center justify-center w-6 h-6 theme-bg text-xs rounded-full theme-text-contrast">4</span>
                        Finalizar
                    </h2>
                    <button id="confirmation-back-btn" class="text-xs text-gray-500 hover:text-gray-800 underline">Voltar</button>
                </div>

                <div class="bg-gray-50 rounded-lg p-3 mb-4 border border-gray-100 text-sm">
                    <div class="flex items-start gap-3">
                        <div id="summary-service-images" class="flex-shrink-0"></div>
                        <div>
                            <p class="font-bold text-gray-900" id="summary-service"></p>
                            <p class="text-gray-600 text-xs mt-0.5">com <span id="summary-professional" class="font-medium"></span></p>
                            <p class="theme-text font-medium mt-1" id="summary-datetime"></p>
                        </div>
                    </div>
                </div>

                <form id="confirmation-form" class="space-y-3">
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Seu Nome</label>
                        <input type="text" id="clientName" class="w-full p-2.5 bg-white border border-gray-300 rounded-lg text-sm focus:ring-1 theme-ring focus:border-transparent outline-none" placeholder="Ex: Maria Silva" required>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">WhatsApp</label>
                        <input type="tel" id="clientPhone" maxlength="15" class="w-full p-2.5 bg-white border border-gray-300 rounded-lg text-sm focus:ring-1 theme-ring focus:border-transparent outline-none" placeholder="(00) 00000-0000" required>
                    </div>
                    <button type="submit" id="btn-confirm" class="w-full theme-bg text-white font-bold py-3 rounded-lg shadow-md hover:opacity-90 transition mt-2">
                        Confirmar Agendamento
                    </button>
                </form>
            </section>

        </main>
        
        <footer class="mt-6 text-center opacity-60">
            <p class="text-xs custom-text-color font-medium">Desenvolvido por Kairos System</p>
        </footer>
    </div>
    
    <div id="my-appointments-view" class="hidden fixed inset-0 z-50 bg-gray-100 flex flex-col fade-in">
        <div class="bg-white shadow-sm p-4 flex items-center gap-3">
            <button data-action="close-appointments-view" class="p-1 rounded-full hover:bg-gray-100">
                <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
            </button>
            <h2 class="text-lg font-bold text-gray-800">Meus Agendamentos</h2>
        </div>
        <div id="appointments-content" class="flex-grow p-4 overflow-y-auto">
             </div>
    </div>
    
    <div id="notificationModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-[100] p-6 hidden backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl p-6 text-center max-w-sm w-full animate-[bounce_0.2s_ease-out]">
          <h3 id="modal-title" class="text-lg font-bold text-gray-900 mb-2"></h3>
          <p id="modal-message" class="text-sm text-gray-600 mb-6"></p>
          <button id="modal-ok-btn" class="w-full py-2.5 theme-bg text-white font-semibold rounded-lg shadow hover:opacity-90">Entendi</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- NOVO: Função de Máscara de Telefone ---
            function setupPhoneMask(inputId) {
                const input = document.getElementById(inputId);
                if (!input) return;

                input.addEventListener('input', (e) => {
                    let value = e.target.value.replace(/\D/g, ""); // Remove tudo que não é dígito
                    
                    // Limita a 11 dígitos
                    if (value.length > 11) value = value.substring(0, 11);

                    // Aplica a formatação (XX) XXXXX-XXXX
                    if (value.length > 10) {
                        value = value.replace(/^(\d{2})(\d{5})(\d{4})/, "($1) $2-$3");
                    } else if (value.length > 6) {
                        value = value.replace(/^(\d{2})(\d{4})(\d{0,4})/, "($1) $2-$3");
                    } else if (value.length > 2) {
                        value = value.replace(/^(\d{2})(\d{0,5})/, "($1) $2");
                    } else if (value.length > 0) {
                        value = value.replace(/^(\d*)/, "($1");
                    }
                    
                    e.target.value = value;
                });
            }

            // Inicializa a máscara no campo de cadastro
            setupPhoneMask('clientPhone');

            // 1. Função para Aplicar Personalizações (Cores e Fundo)
            function applyCustomization(data) {
                const root = document.documentElement;
                
                // Cor Principal
                const primaryColor = data.primaryColor || data.themeColor || '#4f46e5'; 
                root.style.setProperty('--theme-main', primaryColor);
                
                // Cor do Texto do Estabelecimento
                if (data.textColor) {
                    root.style.setProperty('--content-text-color', data.textColor);
                }

                // Imagem de Fundo
                if (data.backgroundImage) {
                    document.body.style.backgroundImage = `url('${data.backgroundImage}')`;
                } else {
                    document.body.style.backgroundImage = 'none';
                    document.body.style.backgroundColor = '#f3f4f6';
                }
            }

            // 2. Configurações Iniciais
            const API_BASE_URL = window.location.origin;
            const urlParams = new URLSearchParams(window.location.search);
            const URL_ID = urlParams.get('id'); // Pode ser o ID Real ou o Slug
            
            // *** VARIÁVEL NOVA PARA O ID REAL ***
            let REAL_ESTABLISHMENT_ID = null; 
            
            let currentWeekStart = getStartOfWeek(new Date());
            let allServicesData = [];
            let allProfessionalsData = [];
            
            // Estado do Agendamento em memória
            const booking = { professionalId: null, professionalName: null, services: [], date: null, time: null, totalDuration: 0 };

            // 3. Elementos DOM
            const bookingView = document.getElementById('booking-view');
            const myAppointmentsView = document.getElementById('my-appointments-view');
            const myAppointmentsContent = document.getElementById('appointments-content');
            const myAppointmentsBtn = document.getElementById('myAppointmentsBtn');
            const establishmentNameEl = document.getElementById('establishmentName');
            const establishmentLogoEl = document.getElementById('establishmentLogo');
            const establishmentWelcomeMessageEl = document.getElementById('establishmentWelcomeMessage');
            const servicesContainer = document.getElementById('services-container');
            const professionalsContainer = document.getElementById('professionals-container');
            const timeSlotsContainer = document.getElementById('time-slots-container');
            const morningSlotsContainer = document.getElementById('morning-slots');
            const afternoonSlotsContainer = document.getElementById('afternoon-slots');
            const confirmationForm = document.getElementById('confirmation-form');
            const weekContainer = document.getElementById('week-container');
            const monthYearDisplay = document.getElementById('month-year-display');
            const prevWeekBtn = document.getElementById('prev-week-btn');
            const nextWeekBtn = document.getElementById('next-week-btn');
            const notificationModal = document.getElementById('notificationModal');
            const modalTitle = document.getElementById('modal-title');
            const modalMessage = document.getElementById('modal-message');
            const modalOkBtn = document.getElementById('modal-ok-btn');
            const progressBar = document.getElementById('progress-bar');
            
            // Botões de Navegação ("Voltar")
            document.getElementById('professionals-back-btn').addEventListener('click', () => showSection('services'));
            document.getElementById('schedule-back-btn').addEventListener('click', () => showSection('professionals'));
            document.getElementById('confirmation-back-btn').addEventListener('click', () => showSection('schedule'));

            if (!URL_ID) {
                document.body.innerHTML = '<div class="flex h-screen items-center justify-center p-4 text-center text-gray-500">Link inválido ou incompleto.</div>';
                return;
            }

            const sections = { 
                services: document.getElementById('services-section'), 
                professionals: document.getElementById('professionals-section'), 
                schedule: document.getElementById('schedule-section'), 
                confirmation: document.getElementById('confirmation-section') 
            };

            function updateProgress(step) {
                progressBar.style.width = `${step * 25}%`;
            }

            function showNotificationModal(title, message) {
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                notificationModal.classList.remove('hidden');
            }
            modalOkBtn.addEventListener('click', () => notificationModal.classList.add('hidden'));

            function getStartOfWeek(date) {
                const d = new Date(date);
                const day = d.getDay();
                const diff = d.getDate() - day + (day === 0 ? -6 : 1);
                return new Date(d.setDate(diff));
            }

            const showSection = (sectionName) => {
                Object.keys(sections).forEach(key => sections[key].classList.add('hidden'));
                sections[sectionName].classList.remove('hidden');
                sections[sectionName].classList.add('fade-in');
                
                const steps = { services: 1, professionals: 2, schedule: 3, confirmation: 4 };
                updateProgress(steps[sectionName]);

                // --- CORREÇÃO: Atualizar horários automaticamente se já houver data selecionada ---
                // Isso resolve o problema de voltar para mudar o serviço e os horários não atualizarem.
                if (sectionName === 'schedule' && booking.date) {
                    // Coloca um loader visual para indicar que estamos buscando novos horários
                    morningSlotsContainer.innerHTML = '<div class="loader mx-auto col-span-4 mt-4"></div>';
                    afternoonSlotsContainer.innerHTML = '';
                    loadAvailability(booking.date);
                }
            };

            // 4. Carregar Dados do Estabelecimento
            const loadEstablishmentDetails = async () => {
                try {
                    // Busca pelo SLUG ou ID (O backend já suporta ambos na rota /:id)
                    const response = await fetch(`${API_BASE_URL}/api/establishments/${URL_ID}`);
                    if (!response.ok) throw new Error('Falha ao carregar dados.');
                    const data = await response.json();

                    if (data.publicBookingEnabled === false) {
                        document.body.innerHTML = ''; 
                        document.body.className = 'bg-gray-100 h-screen flex items-center justify-center p-4 font-sans';
                        document.body.innerHTML = `
                            <div class="bg-white p-8 rounded-2xl shadow-xl max-w-sm w-full text-center">
                                <div class="bg-red-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-6">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
                                    </svg>
                                </div>
                                <h2 class="text-xl font-bold text-gray-900 mb-3">Link Indisponível</h2>
                                <p class="text-gray-600 mb-6 text-sm leading-relaxed">
                                    O agendamento online para <strong class="text-gray-800">${data.name || 'este estabelecimento'}</strong> está temporariamente desativado.
                                </p>
                            </div>
                        `;
                        return false;
                    }

                    // *** IMPORTANTE: CAPTURA O ID REAL ***
                    REAL_ESTABLISHMENT_ID = data.id; 

                    applyCustomization(data);

                    establishmentNameEl.innerHTML = data.name || 'Bem-vindo';
                    establishmentWelcomeMessageEl.textContent = data.welcomeMessage || 'Agende seu horário online.';
                    
                    if (data.logo) {
                        establishmentLogoEl.src = data.logo;
                        establishmentLogoEl.classList.remove('opacity-0');
                    }
                    return true;

                } catch(error) {
                    console.error(error);
                    document.body.innerHTML = `<div class="flex items-center justify-center h-screen"><div class="text-center text-red-500 p-4">Não é possível realizar agendamentos para este estabelecimento.</div></div>`;
                    return false;
                }
            };
            
            // 5. Carregar Serviços (USANDO REAL_ESTABLISHMENT_ID)
            const loadServices = async () => {
                servicesContainer.innerHTML = '<div class="loader mx-auto"></div>';
                try {
                    // Usa o ID REAL, não o da URL
                    const response = await fetch(`${API_BASE_URL}/api/services/${REAL_ESTABLISHMENT_ID}`);
                    if (!response.ok) throw new Error();
                    const services = await response.json();
                    allServicesData = services;
                    servicesContainer.innerHTML = '';
                    
                    if (services.length === 0) {
                        servicesContainer.innerHTML = '<p class="text-center text-sm text-gray-500">Nenhum serviço disponível.</p>';
                        return;
                    }

                    services.forEach(serv => {
                        const card = document.createElement('div');
                        card.className = 'service-card group flex items-center justify-between p-2 bg-white border border-gray-200 rounded-xl cursor-pointer hover:border-gray-300';
                        card.dataset.id = serv.id;
                        
                        const duration = serv.duration ? `<span class="text-xs text-gray-400 font-medium ml-2">• ${serv.duration} min</span>` : '';
                        const photoSrc = serv.photo || `https://placehold.co/128x128/E2E8F0/4A5568?text=${encodeURIComponent(serv.name.charAt(0))}`;
                        
                        card.innerHTML = `
                            <div class="flex items-center gap-3 w-full">
                                <img src="${photoSrc}" alt="${serv.name}" class="w-12 h-12 rounded-lg object-cover border border-gray-200 flex-shrink-0">
                                <div class="flex-grow min-w-0">
                                    <h3 class="font-bold text-gray-800 text-sm leading-tight truncate">${serv.name}</h3>
                                    <p class="text-xs font-semibold theme-text mt-0.5">R$ ${serv.price.toFixed(2)} ${duration}</p>
                                </div>
                                <div class="w-5 h-5 rounded-full border-2 border-gray-300 flex-shrink-0 flex items-center justify-center check-icon transition-all duration-200 ml-2">
                                    <div class="w-2.5 h-2.5 rounded-full theme-bg opacity-0 transition-opacity"></div>
                                </div>
                            </div>
                        `;
                        
                        card.addEventListener('click', () => {
                            const icon = card.querySelector('.check-icon div');
                            const border = card.querySelector('.check-icon');
                            const isSelected = card.classList.contains('selected');
                            
                            document.querySelectorAll('.service-card').forEach(c => {
                                c.classList.remove('selected');
                                c.querySelector('.check-icon').classList.remove('border-[color:var(--theme-main)]');
                                c.querySelector('.check-icon div').classList.add('opacity-0');
                            });

                            if (!isSelected) {
                                card.classList.add('selected');
                                border.classList.add('border-[color:var(--theme-main)]');
                                icon.classList.remove('opacity-0');
                                
                                booking.services = [{
                                    id: serv.id, name: serv.name, duration: serv.duration, price: serv.price,
                                    bufferTime: serv.bufferTime || 0, photo: serv.photo
                                }];
                                loadProfessionalsForService();
                                setTimeout(() => showSection('professionals'), 300); 
                            }
                        });
                        servicesContainer.appendChild(card);
                    });
                } catch {
                    servicesContainer.innerHTML = '<p class="text-red-500 text-sm">Erro ao carregar serviços.</p>';
                }
            };
            
            // 6. Carregar Profissionais (USANDO REAL_ESTABLISHMENT_ID)
            const loadProfessionalsForService = async () => {
                professionalsContainer.innerHTML = '<div class="loader mx-auto col-span-3"></div>';
                try {
                    // Usa o ID REAL
                    const response = await fetch(`${API_BASE_URL}/api/professionals/${REAL_ESTABLISHMENT_ID}`);
                    if (!response.ok) throw new Error();
                    allProfessionalsData = await response.json();
                    
                    const selectedServiceIds = booking.services.map(s => s.id);
                    const professionals = allProfessionalsData.filter(prof => 
                        prof.services && selectedServiceIds.every(id => prof.services.includes(id))
                    );
                    
                    professionalsContainer.innerHTML = '';
                    if (professionals.length === 0) {
                        professionalsContainer.innerHTML = '<p class="col-span-full text-sm text-gray-500 text-center">Indisponível.</p>';
                        return;
                    }

                    professionals.forEach(prof => {
                        const card = document.createElement('div');
                        card.className = 'professional-card flex flex-col items-center justify-center p-2 bg-white border border-gray-200 rounded-xl cursor-pointer aspect-square';
                        const photoSrc = prof.photo || `https://ui-avatars.com/api/?name=${encodeURIComponent(prof.name)}&background=random&color=fff`;
                        
                        card.innerHTML = `
                            <img src="${photoSrc}" class="w-12 h-12 rounded-full object-cover mb-2 border border-gray-100 shadow-sm">
                            <h4 class="font-bold text-xs text-gray-800 text-center leading-tight line-clamp-2">${prof.name.split(' ')[0]}</h4>
                        `;
                        card.addEventListener('click', () => {
                            document.querySelectorAll('.professional-card').forEach(c => c.classList.remove('selected'));
                            card.classList.add('selected');
                            booking.professionalId = prof.id;
                            booking.professionalName = prof.name;
                            renderWeek();
                            showSection('schedule');
                        });
                        professionalsContainer.appendChild(card);
                    });
                } catch {
                    professionalsContainer.innerHTML = '<p class="text-red-500 text-xs">Erro.</p>';
                }
            };

            // 7. Carregar Disponibilidade (USANDO REAL_ESTABLISHMENT_ID)
            const loadAvailability = async (selectedDate) => {
                morningSlotsContainer.innerHTML = '';
                afternoonSlotsContainer.innerHTML = '';
                booking.date = selectedDate;
                const serviceIds = booking.services.map(s => s.id).join(',');
                
                try {
                    // Usa o ID REAL na query string
                    const response = await fetch(`${API_BASE_URL}/api/availability?establishmentId=${REAL_ESTABLISHMENT_ID}&professionalId=${booking.professionalId}&serviceIds=${serviceIds}&date=${selectedDate}`);
                    if (!response.ok) throw new Error();
                    const slots = await response.json();
                    
                    if (slots.length === 0) {
                        morningSlotsContainer.innerHTML = '<p class="col-span-4 text-xs text-gray-400 text-center py-2">Sem horários</p>';
                        return;
                    }

                    const now = new Date();
                    const todayStr = now.toISOString().split('T')[0];
                    const isToday = booking.date === todayStr;

                    slots.forEach(slot => {
                        const [h, m] = slot.split(':').map(Number);
                        if (isToday) {
                            if (h < now.getHours() || (h === now.getHours() && m < now.getMinutes())) return;
                        }

                        const btn = document.createElement('button');
                        btn.className = 'time-slot-btn py-2 text-xs font-medium bg-white border border-gray-200 rounded-lg hover:border-gray-400 transition shadow-sm';
                        btn.textContent = slot;
                        btn.onclick = () => {
                            document.querySelectorAll('.time-slot-btn').forEach(b => b.classList.remove('time-slot-selected'));
                            btn.classList.add('time-slot-selected');
                            booking.time = slot;
                            updateSummary();
                            showSection('confirmation');
                        };
                        
                        if (h < 12) morningSlotsContainer.appendChild(btn);
                        else afternoonSlotsContainer.appendChild(btn);
                    });
                    
                    if (!morningSlotsContainer.hasChildNodes()) morningSlotsContainer.innerHTML = '<span class="col-span-4 text-[10px] text-gray-400 text-center italic">---</span>';
                    if (!afternoonSlotsContainer.hasChildNodes()) afternoonSlotsContainer.innerHTML = '<span class="col-span-4 text-[10px] text-gray-400 text-center italic">---</span>';

                } catch {
                    morningSlotsContainer.innerHTML = '<p class="text-red-500 text-xs">Erro</p>';
                }
            };

            // 8. Renderizar Calendário
            const renderWeek = () => {
                weekContainer.innerHTML = '';
                const today = new Date();
                today.setHours(0,0,0,0);
                
                for (let i = 0; i < 7; i++) {
                    const day = new Date(currentWeekStart);
                    day.setDate(day.getDate() + i);
                    
                    const btn = document.createElement('button');
                    btn.className = 'day-button flex flex-col items-center justify-center p-1 rounded-lg transition hover:bg-gray-100';
                    const isSelected = booking.date === day.toISOString().split('T')[0];
                    
                    if(isSelected) {
                        btn.classList.add('bg-gray-800', 'text-white', 'shadow-md');
                    }

                    const dayColorClass = isSelected ? 'text-white' : 'text-gray-500';
                    const numColorClass = isSelected ? 'text-white' : 'text-gray-800';

                    btn.innerHTML = `
                        <span class="text-[10px] uppercase ${dayColorClass}">${day.toLocaleDateString('pt-BR', { weekday: 'short' }).replace('.', '')}</span>
                        <span class="text-sm font-semibold ${numColorClass}">${day.getDate()}</span>
                    `;

                    if (day < today) {
                        btn.classList.add('opacity-30', 'cursor-not-allowed');
                    } else {
                        btn.onclick = () => {
                            document.querySelectorAll('.day-button').forEach(b => {
                                b.classList.remove('bg-gray-800', 'text-white', 'shadow-md');
                                b.querySelectorAll('span').forEach(s => s.className = s.className.replace('text-white', '').replace('text-gray-500', 'text-gray-500').replace('text-gray-800', 'text-gray-800'));
                            });
                            btn.classList.add('bg-gray-800', 'text-white', 'shadow-md');
                            btn.querySelectorAll('span').forEach(s => s.className = s.className.replace('text-gray-500', 'text-white').replace('text-gray-800', 'text-white'));
                            
                            const dateStr = `${day.getFullYear()}-${String(day.getMonth()+1).padStart(2,'0')}-${String(day.getDate()).padStart(2,'0')}`;
                            loadAvailability(dateStr);
                        };
                    }
                    weekContainer.appendChild(btn);
                }
                monthYearDisplay.textContent = currentWeekStart.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
            };

            // 9. Atualizar Resumo
            const updateSummary = () => {
                const s = booking.services[0];
                document.getElementById('summary-service').textContent = s.name;
                document.getElementById('summary-professional').textContent = booking.professionalName;
                
                const dateObj = new Date(booking.date + 'T00:00:00');
                const dateFormatted = dateObj.toLocaleDateString('pt-BR', { day: 'numeric', month: 'long' });
                document.getElementById('summary-datetime').textContent = `${dateFormatted} às ${booking.time}`;
                
                const imgContainer = document.getElementById('summary-service-images');
                imgContainer.innerHTML = '';
                if(s.photo) {
                    imgContainer.innerHTML = `<img src="${s.photo}" class="w-12 h-12 rounded-lg object-cover border border-gray-200">`;
                } else {
                    imgContainer.innerHTML = `<div class="w-12 h-12 rounded-lg theme-bg flex items-center justify-center text-white font-bold text-lg">${s.name[0]}</div>`;
                }
            };

            // 10. Confirmar Agendamento (USANDO REAL_ESTABLISHMENT_ID)
            confirmationForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = document.getElementById('btn-confirm');
                btn.disabled = true;
                btn.innerText = 'Agendando...';
                
                const data = {
                    establishmentId: REAL_ESTABLISHMENT_ID, // Usa ID REAL
                    services: booking.services,
                    professionalId: booking.professionalId,
                    clientName: document.getElementById('clientName').value,
                    clientPhone: document.getElementById('clientPhone').value,
                    startTime: new Date(`${booking.date}T${booking.time}:00`).toISOString()
                };

                try {
                    const res = await fetch(`${API_BASE_URL}/api/appointments`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(data)
                    });
                    if(!res.ok) throw new Error();
                    
                    document.querySelector('main').innerHTML = `
                        <div class="text-center py-10 fade-in">
                            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                            </div>
                            <h2 class="text-xl font-bold text-gray-800 mb-2">Agendado!</h2>
                            <p class="text-sm text-gray-600 px-4">Seu horário está confirmado. Enviaremos uma mensagem para o seu WhatsApp em breve.</p>
                            <button onclick="location.reload()" class="mt-6 text-sm theme-text font-semibold hover:underline">Agendar outro</button>
                        </div>
                    `;
                } catch {
                    showNotificationModal('Erro', 'Não foi possível agendar. Tente novamente.');
                    btn.disabled = false;
                    btn.innerText = 'Confirmar Agendamento';
                }
            });

            // 11. Meus Agendamentos (USANDO REAL_ESTABLISHMENT_ID)
            const openAppointments = () => {
                myAppointmentsView.classList.remove('hidden');
                document.getElementById('booking-view').classList.add('hidden');
                myAppointmentsContent.innerHTML = `
                    <div class="text-center mt-10">
                        <h3 class="font-bold text-gray-700 mb-2">Consultar Agendamentos</h3>
                        <p class="text-xs text-gray-500 mb-4">Digite seu WhatsApp para buscar</p>
                        <form id="lookupForm" class="max-w-xs mx-auto">
                            <input type="tel" id="lookupPhone" maxlength="15" class="w-full p-3 border rounded-lg text-center mb-3" placeholder="(00) 00000-0000" required>
                            <button type="submit" class="w-full theme-bg text-white py-3 rounded-lg font-bold">Buscar</button>
                        </form>
                    </div>
                `;
                
                // Aplica a máscara no campo recém-criado
                setupPhoneMask('lookupPhone');
                
                document.getElementById('lookupForm').onsubmit = async (e) => {
                    e.preventDefault();
                    const phone = document.getElementById('lookupPhone').value;
                    myAppointmentsContent.innerHTML = '<div class="loader mx-auto mt-10"></div>';
                    
                    try {
                        // Usa ID REAL
                        const res = await fetch(`${API_BASE_URL}/api/client-portal/appointments/${REAL_ESTABLISHMENT_ID}?phone=${encodeURIComponent(phone)}`);
                        if(!res.ok) throw new Error();
                        const appts = await res.json();
                        
                        if(appts.length === 0) {
                            myAppointmentsContent.innerHTML = '<p class="text-center text-gray-500 mt-10">Nenhum agendamento encontrado.</p>';
                            return;
                        }
                        
                        myAppointmentsContent.innerHTML = `<div class="space-y-3 pb-10">
                            ${appts.map(a => {
                                const photoUrl = a.professionalPhoto || `https://ui-avatars.com/api/?name=${encodeURIComponent(a.professionalName || 'P')}&background=random&color=fff`;
                                const dateFormatted = new Date(a.startTime).toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
                                
                                // CORREÇÃO DE LÓGICA DE STATUS AQUI
                                let statusLabel = 'Confirmado';
                                let statusClass = 'bg-green-50 text-green-600';
                                
                                if (a.status === 'completed') {
                                    statusLabel = 'Finalizado';
                                    statusClass = 'bg-gray-100 text-gray-500';
                                } else if (a.status === 'cancelled') {
                                    statusLabel = 'Cancelado';
                                    statusClass = 'bg-red-50 text-red-600';
                                }

                                return `
                                <div class="bg-white p-3 rounded-xl border border-gray-200 shadow-sm flex items-start gap-3">
                                    <img src="${photoUrl}" alt="Profissional" class="w-12 h-12 rounded-full object-cover border border-gray-100 flex-shrink-0">
                                    <div class="flex-grow min-w-0">
                                        <div class="flex justify-between items-start">
                                            <p class="font-bold text-sm text-gray-800 truncate">${a.professionalName || 'Profissional'}</p>
                                            <span class="text-[10px] font-bold uppercase px-2 py-0.5 rounded ${statusClass}">
                                                ${statusLabel}
                                            </span>
                                        </div>
                                        <p class="text-xs text-gray-600 mt-0.5 font-medium">${a.serviceName}</p>
                                        <p class="text-xs text-gray-400 mt-1 flex items-center gap-1">
                                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                                            ${dateFormatted}
                                        </p>
                                        ${a.status !== 'completed' && a.status !== 'cancelled' ? 
                                            `<button onclick="cancelAppt('${a.id}', '${phone}')" class="mt-3 w-full text-xs text-red-500 border border-red-200 py-1.5 rounded hover:bg-red-50 font-semibold transition-colors">Cancelar Agendamento</button>` 
                                            : ''}
                                    </div>
                                </div>
                                `;
                            }).join('')}
                        </div>`;
                    } catch {
                        myAppointmentsContent.innerHTML = '<p class="text-center text-red-500 mt-10">Erro ao buscar.</p>';
                    }
                };
            };
            
            window.cancelAppt = async (id, phone) => {
                if(!confirm('Deseja cancelar?')) return;
                try {
                    await fetch(`${API_BASE_URL}/api/client-portal/appointments/${id}/cancel`, {
                        method: 'POST',
                        headers: {'Content-Type':'application/json'},
                        body: JSON.stringify({phone, establishmentId: REAL_ESTABLISHMENT_ID}) // Usa ID REAL
                    });
                    alert('Cancelado com sucesso.');
                    location.reload(); 
                } catch {
                    alert('Erro ao cancelar.');
                }
            };

            myAppointmentsBtn.addEventListener('click', openAppointments);
            document.querySelector('[data-action="close-appointments-view"]').addEventListener('click', () => {
                myAppointmentsView.classList.add('hidden');
                document.getElementById('booking-view').classList.remove('hidden');
            });

            // --- EXECUÇÃO INICIAL ---
            loadEstablishmentDetails().then((success) => {
                if (success) {
                    loadServices();
                }
            });
            
            prevWeekBtn.onclick = () => { currentWeekStart.setDate(currentWeekStart.getDate() - 7); renderWeek(); };
            nextWeekBtn.onclick = () => { currentWeekStart.setDate(currentWeekStart.getDate() + 7); renderWeek(); };
        });
    </script>
</body>
</html>